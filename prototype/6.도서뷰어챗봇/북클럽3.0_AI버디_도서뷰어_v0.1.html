<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ë¶í´ëŸ½ 3.0 AIë²„ë”” ë„ì„œë·°ì–´ v0.1</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;-webkit-tap-highlight-color:transparent}
html,body,#root{width:100%;height:100%;overflow:hidden;background:#1a1a2e}

@keyframes buddy-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes buddy-enter{0%{transform:scale(0) translateY(40px);opacity:0}60%{transform:scale(1.1) translateY(-5px)}100%{transform:scale(1) translateY(0);opacity:1}}
@keyframes bubble-in{0%{transform:scale(0.5) translateY(10px);opacity:0}100%{transform:scale(1) translateY(0);opacity:1}}
@keyframes confetti-fall{0%{transform:translateY(-10vh) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 8px rgba(255,183,77,0.4)}50%{box-shadow:0 0 20px rgba(255,183,77,0.8)}}
@keyframes star-pop{0%{transform:scale(0) rotate(0);opacity:0}60%{transform:scale(1.3) rotate(180deg);opacity:1}100%{transform:scale(1) rotate(360deg);opacity:1}}
@keyframes slide-up{0%{transform:translateY(20px);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes tail-wag{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(15deg)}}
@keyframes zzz{0%{opacity:0;transform:translateY(0) scale(0.5)}50%{opacity:1;transform:translateY(-15px) scale(1)}100%{opacity:0;transform:translateY(-30px) scale(0.5)}}

.buddy-bounce{animation:buddy-bounce 2s ease-in-out infinite}
.buddy-enter{animation:buddy-enter 0.5s ease-out both}
.bubble-in{animation:bubble-in 0.3s ease-out both}
.confetti{animation:confetti-fall 3s linear both}
.pulse-glow{animation:pulse-glow 2s ease-in-out infinite}
.star-pop{animation:star-pop 0.6s ease-out both}
.anim-slide-up{animation:slide-up 0.4s ease-out both}
.anim-float{animation:float 3s ease-in-out infinite}
.tail-wag{animation:tail-wag 0.4s ease-in-out infinite}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState, useEffect, useRef, useCallback, useMemo} = React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SVG ë‹¤ëŒì¥ ìºë¦­í„° (ê°ì •ë³„ 5ì¢…)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SquirrelBuddy({ emotion = 'kind', size = 80, animate = true }) {
  const emotions = {
    kind:    { eyeShape:'normal', mouthShape:'smile',  cheekOpacity:0.6, bodyColor:'#8B5E3C', tailWag:false, extraClass:'' },
    excited: { eyeShape:'sparkle', mouthShape:'bigSmile', cheekOpacity:0.8, bodyColor:'#8B5E3C', tailWag:true, extraClass:'buddy-bounce' },
    comfort: { eyeShape:'sad', mouthShape:'worried', cheekOpacity:0.3, bodyColor:'#8B5E3C', tailWag:false, extraClass:'' },
    study:   { eyeShape:'determined', mouthShape:'grin', cheekOpacity:0.5, bodyColor:'#8B5E3C', tailWag:false, extraClass:'' },
    sleepy:  { eyeShape:'closed', mouthShape:'sleepy', cheekOpacity:0.4, bodyColor:'#8B5E3C', tailWag:false, extraClass:'anim-float' },
  };
  const e = emotions[emotion] || emotions.kind;

  const renderEyes = () => {
    switch(e.eyeShape) {
      case 'sparkle':
        return (<>
          <circle cx="38" cy="42" r="5" fill="#2D1B0E"/>
          <circle cx="62" cy="42" r="5" fill="#2D1B0E"/>
          <circle cx="40" cy="40" r="2" fill="white"/>
          <circle cx="64" cy="40" r="2" fill="white"/>
          <path d="M35 35 L37 33 L39 35 L37 37Z" fill="white" opacity="0.8"><animateTransform attributeName="transform" type="rotate" values="0 37 35;360 37 35" dur="2s" repeatCount="indefinite"/></path>
          <path d="M59 35 L61 33 L63 35 L61 37Z" fill="white" opacity="0.8"><animateTransform attributeName="transform" type="rotate" values="0 61 35;360 61 35" dur="2s" repeatCount="indefinite"/></path>
        </>);
      case 'sad':
        return (<>
          <ellipse cx="38" cy="44" rx="4" ry="5" fill="#2D1B0E"/>
          <ellipse cx="62" cy="44" rx="4" ry="5" fill="#2D1B0E"/>
          <circle cx="39" cy="42" r="1.5" fill="white" opacity="0.8"/>
          <circle cx="63" cy="42" r="1.5" fill="white" opacity="0.8"/>
          <path d="M33 37 Q38 39 43 37" stroke="#2D1B0E" strokeWidth="1.5" fill="none"/>
          <path d="M57 37 Q62 39 67 37" stroke="#2D1B0E" strokeWidth="1.5" fill="none"/>
        </>);
      case 'determined':
        return (<>
          <circle cx="38" cy="42" r="4.5" fill="#2D1B0E"/>
          <circle cx="62" cy="42" r="4.5" fill="#2D1B0E"/>
          <circle cx="39" cy="41" r="1.5" fill="white"/>
          <circle cx="63" cy="41" r="1.5" fill="white"/>
          <line x1="33" y1="36" x2="43" y2="34" stroke="#2D1B0E" strokeWidth="2" strokeLinecap="round"/>
          <line x1="57" y1="34" x2="67" y2="36" stroke="#2D1B0E" strokeWidth="2" strokeLinecap="round"/>
        </>);
      case 'closed':
        return (<>
          <path d="M33 42 Q38 46 43 42" stroke="#2D1B0E" strokeWidth="2" fill="none" strokeLinecap="round"/>
          <path d="M57 42 Q62 46 67 42" stroke="#2D1B0E" strokeWidth="2" fill="none" strokeLinecap="round"/>
        </>);
      default:
        return (<>
          <circle cx="38" cy="42" r="4.5" fill="#2D1B0E"/>
          <circle cx="62" cy="42" r="4.5" fill="#2D1B0E"/>
          <circle cx="40" cy="41" r="1.8" fill="white"/>
          <circle cx="64" cy="41" r="1.8" fill="white"/>
        </>);
    }
  };

  const renderMouth = () => {
    switch(e.mouthShape) {
      case 'bigSmile':
        return <path d="M42 54 Q50 62 58 54" stroke="#2D1B0E" strokeWidth="2" fill="#FF8A80" strokeLinecap="round"/>;
      case 'worried':
        return <path d="M43 56 Q50 52 57 56" stroke="#2D1B0E" strokeWidth="1.8" fill="none" strokeLinecap="round"/>;
      case 'grin':
        return (<>
          <path d="M43 53 Q50 58 57 53" stroke="#2D1B0E" strokeWidth="2" fill="none" strokeLinecap="round"/>
          <line x1="50" y1="53" x2="50" y2="56" stroke="#2D1B0E" strokeWidth="1" strokeLinecap="round"/>
        </>);
      case 'sleepy':
        return <path d="M45 55 Q50 57 55 55" stroke="#2D1B0E" strokeWidth="1.5" fill="none" strokeLinecap="round"/>;
      default:
        return <path d="M43 53 Q50 59 57 53" stroke="#2D1B0E" strokeWidth="2" fill="none" strokeLinecap="round"/>;
    }
  };

  return (
    <svg width={size} height={size} viewBox="0 0 100 100" className={animate ? e.extraClass : ''}>
      {/* ê¼¬ë¦¬ */}
      <g className={e.tailWag ? 'tail-wag' : ''} style={{transformOrigin:'30px 70px'}}>
        <path d="M25 70 Q5 45 15 25 Q25 15 30 30 Q32 45 28 65" fill="#C67C4E" stroke="#A0622E" strokeWidth="1"/>
        <path d="M20 55 Q10 40 18 28" stroke="#D4956B" strokeWidth="3" fill="none" strokeLinecap="round" opacity="0.5"/>
      </g>
      {/* ëª¸í†µ */}
      <ellipse cx="50" cy="72" rx="22" ry="18" fill={e.bodyColor}/>
      <ellipse cx="50" cy="74" rx="16" ry="12" fill="#D4956B"/>
      {/* ë¨¸ë¦¬ */}
      <circle cx="50" cy="42" r="24" fill={e.bodyColor}/>
      {/* ê·€ */}
      <ellipse cx="32" cy="22" rx="8" ry="10" fill={e.bodyColor} transform="rotate(-15 32 22)"/>
      <ellipse cx="32" cy="22" rx="5" ry="7" fill="#D4956B" transform="rotate(-15 32 22)"/>
      <ellipse cx="68" cy="22" rx="8" ry="10" fill={e.bodyColor} transform="rotate(15 68 22)"/>
      <ellipse cx="68" cy="22" rx="5" ry="7" fill="#D4956B" transform="rotate(15 68 22)"/>
      {/* ì–¼êµ´ ë°ì€ ë¶€ë¶„ */}
      <ellipse cx="50" cy="48" rx="18" ry="14" fill="#D4956B"/>
      {/* ë³¼ í„°ì¹˜ */}
      <circle cx="30" cy="50" r="5" fill="#FF9999" opacity={e.cheekOpacity}/>
      <circle cx="70" cy="50" r="5" fill="#FF9999" opacity={e.cheekOpacity}/>
      {/* ëˆˆ */}
      {renderEyes()}
      {/* ì½” */}
      <ellipse cx="50" cy="48" rx="3" ry="2.5" fill="#2D1B0E"/>
      {/* ì… */}
      {renderMouth()}
      {/* íŒ” */}
      <ellipse cx="30" cy="68" rx="6" ry="4" fill={e.bodyColor} transform="rotate(20 30 68)"/>
      <ellipse cx="70" cy="68" rx="6" ry="4" fill={e.bodyColor} transform="rotate(-20 70 68)"/>
      {/* ì¡¸ë¦¼ ZZZ */}
      {emotion === 'sleepy' && (<>
        <text x="70" y="25" fontSize="10" fill="#7C8DB5" fontWeight="bold" opacity="0.7">
          z<animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite"/>
        </text>
        <text x="78" y="18" fontSize="8" fill="#7C8DB5" fontWeight="bold">
          z<animate attributeName="opacity" values="0;1;0" dur="2s" begin="0.5s" repeatCount="indefinite"/>
        </text>
        <text x="84" y="12" fontSize="6" fill="#7C8DB5" fontWeight="bold">
          z<animate attributeName="opacity" values="0;1;0" dur="2s" begin="1s" repeatCount="indefinite"/>
        </text>
      </>)}
      {/* ì—´ê³µ ë¨¸ë¦¬ë  */}
      {emotion === 'study' && (
        <g>
          <rect x="28" y="28" width="44" height="6" rx="3" fill="#FF6B6B" opacity="0.9"/>
          <text x="50" y="34" fontSize="5" fill="white" textAnchor="middle" fontWeight="bold">ì—´ê³µ!</text>
        </g>
      )}
    </svg>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒ˜í”Œ ë„ì„œ í˜ì´ì§€ (ì‹œë®¬ë ˆì´ì…˜)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BOOK_DATA = {
  title: 'ìˆ²ì† ì¹œêµ¬ë“¤ì˜ ëª¨í—˜',
  totalPages: 16,
  pages: [
    { bg:'#FFF8E7', title:'ìˆ²ì† ì¹œêµ¬ë“¤ì˜ ëª¨í—˜', subtitle:'ê¸€ Â· ê·¸ë¦¼  ê¹€ë³´ë¯¸', isTitle:true, img:'ğŸ¦ŠğŸ¿ï¸ğŸ°' },
    { bg:'#F0FFF0', text:'ì–´ëŠ ë”°ëœ»í•œ ë´„ë‚ , ìˆ²ì† ë§ˆì„ì— ì•„ì¹¨ í•´ê°€ ë°ì•˜ì–´ìš”.\në‹¤ëŒì¥ ë„í† ë¦¬ëŠ” ê¸°ì§€ê°œë¥¼ ì¼œë©° ì°½ë°–ì„ ë‚´ë‹¤ë´¤ì–´ìš”.', img:'ğŸŒ…ğŸ¡' },
    { bg:'#FFF0F5', text:'"ì˜¤ëŠ˜ì€ ë­”ê°€ íŠ¹ë³„í•œ ì¼ì´ ì¼ì–´ë‚  ê²ƒ ê°™ì•„!"\në„í† ë¦¬ëŠ” ì„¤ë ˆëŠ” ë§ˆìŒìœ¼ë¡œ ì§‘ì„ ë‚˜ì„°ì–´ìš”.', img:'ğŸ¿ï¸âœ¨' },
    { bg:'#F0F8FF', text:'ê¸¸ì„ ê±·ë‹¤ ë³´ë‹ˆ ì—¬ìš° ì¹œêµ¬ ë£¨ë¹„ë¥¼ ë§Œë‚¬ì–´ìš”.\n"ë„í† ë¦¬ì•¼, ì–´ë”” ê°€ë‹ˆ?" ë£¨ë¹„ê°€ ë¬¼ì—ˆì–´ìš”.', img:'ğŸ¿ï¸ğŸ¦Š' },
    { bg:'#FFFFF0', text:'"ìˆ² ëì— ìˆëŠ” ë¬´ì§€ê°œ ì—°ëª»ì„ ì°¾ì•„ê°€ë ¤ê³ !"\n"ì •ë§? ë‚˜ë„ ê°™ì´ ê°€ë„ ë¼?"', img:'ğŸŒˆğŸ’§' },
    { bg:'#FFF5EE', text:'ë‘˜ì€ í•¨ê»˜ ìˆ²ê¸¸ì„ ê±¸ì—ˆì–´ìš”.\në‚˜ë­‡ì ì‚¬ì´ë¡œ í–‡ì‚´ì´ ë°˜ì§ë°˜ì§ ë¹›ë‚¬ì–´ìš”.', img:'ğŸŒ³â˜€ï¸' },
    { bg:'#F5FFFA', text:'ê°‘ìê¸° ê¸¸ì´ ë‘ ê°ˆë˜ë¡œ ë‚˜ë‰˜ì—ˆì–´ìš”.\n"ì–´ëŠ ìª½ìœ¼ë¡œ ê°€ì•¼ í• ê¹Œ?" ë„í† ë¦¬ê°€ ê³ ë¯¼í–ˆì–´ìš”.', img:'ğŸ›¤ï¸ğŸ¤”' },
    { bg:'#FFF0F0', text:'ê·¸ë•Œ í† ë¼ ì¹œêµ¬ í•˜ì–‘ì´ê°€ ë‚˜íƒ€ë‚¬ì–´ìš”.\n"ì™¼ìª½ ê¸¸ì´ ë§ì•„! ë‚´ê°€ ì•ˆë‚´í•´ ì¤„ê²Œ!"', img:'ğŸ°ğŸ‘ˆ' },
    { bg:'#F0FFFF', text:'ì…‹ì€ í•¨ê»˜ ì™¼ìª½ ê¸¸ì„ ë”°ë¼ê°”ì–´ìš”.\nì ì  ì‹ ë¹„ë¡œìš´ ì†Œë¦¬ê°€ ë“¤ë ¤ì™”ì–´ìš”.', img:'ğŸµğŸŒ¿' },
    { bg:'#FFFAF0', text:'ë“œë””ì–´ ë¬´ì§€ê°œ ì—°ëª»ì— ë„ì°©í–ˆì–´ìš”!\nì¼ê³± ë¹›ê¹” ë¬´ì§€ê°œê°€ ì—°ëª» ìœ„ì— ë–  ìˆì—ˆì–´ìš”.', img:'ğŸŒˆâœ¨ğŸ’§' },
    { bg:'#F8F0FF', text:'"ì™€ì•„~ ì •ë§ ì•„ë¦„ë‹µë‹¤!"\nì„¸ ì¹œêµ¬ëŠ” ê°íƒ„í–ˆì–´ìš”.', img:'ğŸ˜ğŸŒˆ' },
    { bg:'#FFF8F0', text:'ì—°ëª» ì˜†ì—ëŠ” ì‘ì€ ë³´ë¬¼ìƒìê°€ ìˆì—ˆì–´ìš”.\n"ì´ê±´ ë­˜ê¹Œ?" ë£¨ë¹„ê°€ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì—´ì—ˆì–´ìš”.', img:'ğŸ“¦âœ¨' },
    { bg:'#F0FFF8', text:'ìƒì ì•ˆì—ëŠ” ë°˜ì§ì´ëŠ” ìš°ì •ì˜ ëŒì´ ì„¸ ê°œ ë“¤ì–´ìˆì—ˆì–´ìš”.\n"ìš°ë¦¬ ì…‹ì„ ìœ„í•œ ê±°ì•¼!"', img:'ğŸ’ğŸ’ğŸ’' },
    { bg:'#FFF0FF', text:'ì„¸ ì¹œêµ¬ëŠ” ê°ì í•˜ë‚˜ì”© ìš°ì •ì˜ ëŒì„ ë‚˜ëˆ  ê°€ì¡Œì–´ìš”.\n"ì˜ì›íˆ ì¹œêµ¬í•˜ì!" ëª¨ë‘ ì•½ì†í–ˆì–´ìš”.', img:'ğŸ¤ğŸ’•' },
    { bg:'#FFFFF5', text:'í•´ê°€ ì§€ê¸° ì „ì— ì§‘ìœ¼ë¡œ ëŒì•„ì˜¨ ì„¸ ì¹œêµ¬.\nì˜¤ëŠ˜ì˜ ëª¨í—˜ì€ ìµœê³ ì˜ ì¶”ì–µì´ ë˜ì—ˆì–´ìš”.', img:'ğŸŒ‡ğŸ¡' },
    { bg:'#FFF8E7', title:'ë', subtitle:'ìˆ²ì† ì¹œêµ¬ë“¤ì˜ ëª¨í—˜ì€ ê³„ì†ë©ë‹ˆë‹¤...', isTitle:true, img:'ğŸ¿ï¸ğŸ¦ŠğŸ°ğŸ’«' },
  ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI ë²„ë”” ì‹œë‚˜ë¦¬ì˜¤ ì—”ì§„
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCENARIOS = {
  S01: { id:'S01', emotion:'kind',    priority:1,  cooldown:Infinity, msg: (d) => `ì•ˆë…•! ì´ ì±…ì€ '${d.title}'ì´ì•¼! ê°™ì´ ì½ì–´ë³¼ê¹Œ? ğŸ“–`, buttons:[] },
  S02: { id:'S02', emotion:'kind',    priority:1,  cooldown:Infinity, msg: (d) => `${d.name}ì•„! ì˜¤ëŠ˜ë„ ì™”êµ¬ë‚˜! ì§€ë‚œë²ˆì— ${d.lastPage}í˜ì´ì§€ê¹Œì§€ ì½ì—ˆì§€? ì´ì–´ì„œ ê°€ë³¼ê¹Œ! ğŸ’ª`, buttons:[{label:'ì´ì–´ ì½ê¸°', action:'resume'}] },
  S03: { id:'S03', emotion:'excited', priority:1,  cooldown:Infinity, msg: (d) => `ë˜ ì™”ë„¤! ì´ ì±…ì´ ì¬ë¯¸ìˆë‚˜ ë³´ë‹¤~ ğŸ˜†` },
  S04: { id:'S04', emotion:'study',   priority:7,  cooldown:120,      msg: (d) => `ì™€~ ì§‘ì¤‘ë ¥ ëŒ€ë‹¨í•œê±¸? ë²Œì¨ ${d.readPages}í˜ì´ì§€ë‚˜ ì½ì—ˆì–´! ğŸ”¥` },
  S05: { id:'S05', emotion:'kind',    priority:6,  cooldown:180,      msg: () => `ì´ ë¶€ë¶„ì´ ì¬ë¯¸ìˆë‚˜ ë³´ë‹¤! ì²œì²œíˆ ì½ì–´ë„ ê´œì°®ì•„ ğŸ˜Š\ní˜¹ì‹œ ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ê¾¹ ëˆŒëŸ¬ë´!` },
  S06a:{ id:'S06a',emotion:'comfort', priority:2,  cooldown:300,      msg: () => `ì ê¹ ì‰¬ê³  ìˆëŠ” ê±°ì•¼? ê´œì°®ì•„~ ì¤€ë¹„ë˜ë©´ ë‹¤ì‹œ ì½ì! â˜•` },
  S06b:{ id:'S06b',emotion:'sleepy',  priority:2,  cooldown:300,      msg: () => `í˜¹ì‹œ ì¡¸ë¦° ê±´ ì•„ë‹ˆì§€? ğŸ˜´ ì´ ì¥ë©´ë¶€í„° ë‹¤ì‹œ ë³¼ê¹Œ?`, buttons:[{label:'ë‹¤ì‹œ ì½ê¸°', action:'refocus'}] },
  S06c:{ id:'S06c',emotion:'sleepy',  priority:2,  cooldown:300,      msg: () => `ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ ì½ì„ê¹Œ? ë‚´ì¼ ì´ì–´ì„œ ì½ì–´ë„ ë¼! ğŸŒ™`, buttons:[{label:'ë¶ë§ˆí¬í•˜ê³  ë‚˜ê°€ê¸°', action:'bookmark'},{label:'ë” ì½ì„ë˜!', action:'continue'}] },
  S07: { id:'S07', emotion:'kind',    priority:3,  cooldown:120,      msg: () => `ì•—! ë„ˆë¬´ ë¹¨ë¦¬ ë„˜ê¸°ê³  ìˆëŠ” ê²ƒ ê°™ì•„~\nì²œì²œíˆ ì½ì–´ë³´ëŠ” ê±´ ì–´ë•Œ? ğŸ“–` },
  S08: { id:'S08', emotion:'excited', priority:5,  cooldown:Infinity, msg: () => `ë²Œì¨ ë°˜ì´ë‚˜ ì½ì—ˆì–´! ğŸ‰\nì—¬ê¸°ì„œ ì ê¹, í€´ì¦ˆ í•˜ë‚˜ í’€ì–´ë³¼ê¹Œ?`, buttons:[{label:'í€´ì¦ˆ í’€ê¸° ğŸ§©', action:'quiz'},{label:'ë‚˜ì¤‘ì— í• ë˜', action:'dismiss'}] },
  S09: { id:'S09', emotion:'study',   priority:5,  cooldown:Infinity, msg: () => `4ë¶„ì˜ 1ì´ë‚˜ ì½ì—ˆì–´! ì´ ì†ë„ë©´ ê¸ˆë°©ì´ë‹¤~ ğŸ’ª` },
  S10: { id:'S10', emotion:'excited', priority:5,  cooldown:Infinity, msg: () => `ê±°ì˜ ë‹¤ ì™”ë‹¤! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì! ğŸƒâ€â™‚ï¸` },
  S11: { id:'S11', emotion:'excited', priority:4,  cooldown:Infinity, msg: (d) => `ì™€~ ë§ˆì§€ë§‰ ${d.remain}í˜ì´ì§€ë§Œ ë‚¨ì•˜ì–´! ëê¹Œì§€ ê°€ë³´ì! ğŸŠ` },
  S12: { id:'S12', emotion:'excited', priority:1,  cooldown:Infinity, msg: (d) => `ğŸ‰ğŸ‰ğŸ‰ ë‹¤ ì½ì—ˆë‹¤!\n'${d.title}' ì™„ë… ì¶•í•˜í•´! ì •ë§ ëŒ€ë‹¨í•´!`, buttons:[{label:'ë…í›„ í™œë™ í•˜ê¸° ğŸ¨', action:'activity'},{label:'ë‹¤ë¥¸ ì±… ì½ê¸° ğŸ“š', action:'next'}] },
  S16: { id:'S16', emotion:'kind',    priority:9,  cooldown:Infinity, msg: () => `ì•„ì¹¨ë¶€í„° ì±… ì½ë‹¤ë‹ˆ ëŒ€ë‹¨í•´!\nì˜¤ëŠ˜ í•˜ë£¨ ì¢‹ì€ ì‹œì‘ì´ì•¼! â˜€ï¸` },
  S17: { id:'S17', emotion:'kind',    priority:9,  cooldown:Infinity, msg: () => `ë°¥ ë¨¹ê³  ì±… ì½ê¸°! ì™„ë²½í•œ ì¡°í•©ì´ë‹¤~ ğŸšğŸ“–` },
  S18: { id:'S18', emotion:'sleepy',  priority:9,  cooldown:Infinity, msg: () => `ì´ ì‹œê°„ì—ë„ ì—´ì‹¬ì´êµ¬ë‚˜!\nê·¼ë° ë„ˆë¬´ ëŠ¦ìœ¼ë©´ ë‚´ì¼ ì½ì~ ğŸŒ™` },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í€´ì¦ˆ ë°ì´í„°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QUIZZES = [
  { q:'ë„í† ë¦¬ê°€ ì°¾ì•„ê°€ë ¤ëŠ” ê³³ì€?', opts:['ë¬´ì§€ê°œ ì—°ëª»','ê¹Šì€ ë™êµ´','ë†’ì€ ì‚°'], answer:0 },
  { q:'ì—¬ìš° ì¹œêµ¬ì˜ ì´ë¦„ì€?', opts:['í•˜ì–‘','ë£¨ë¹„','ë„í† ë¦¬'], answer:1 },
  { q:'ë³´ë¬¼ìƒì ì•ˆì—ëŠ” ë¬´ì—‡ì´ ìˆì—ˆë‚˜ìš”?', opts:['ê¸ˆí™”','ìš°ì •ì˜ ëŒ','ì—´ì‡ '], answer:1 },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì»¨í˜í‹° ì´í™íŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Confetti() {
  const colors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#FF6EC7','#A855F7'];
  const pieces = useMemo(() => Array.from({length:40}, (_,i) => ({
    id:i, left: Math.random()*100, delay: Math.random()*2, dur: 2+Math.random()*2,
    color: colors[Math.floor(Math.random()*colors.length)], size: 6+Math.random()*8,
    type: Math.random()>0.5?'circle':'rect'
  })), []);
  return (
    <div className="fixed inset-0 z-[100] pointer-events-none overflow-hidden">
      {pieces.map(p => (
        <div key={p.id} className="confetti absolute" style={{
          left:`${p.left}%`, top:'-20px', animationDelay:`${p.delay}s`, animationDuration:`${p.dur}s`,
          width:p.size, height:p.size, backgroundColor:p.color,
          borderRadius: p.type==='circle'?'50%':'2px',
        }}/>
      ))}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë§í’ì„  ì»´í¬ë„ŒíŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SpeechBubble({ message, buttons, onButton, onClose }) {
  return (
    <div className="bubble-in absolute bottom-full right-0 mb-2 w-64" onClick={e => e.stopPropagation()}>
      <div className="bg-white rounded-2xl shadow-xl p-4 relative" style={{filter:'drop-shadow(0 4px 12px rgba(0,0,0,0.15))'}}>
        <button onClick={onClose} className="absolute top-2 right-2 w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 text-xs hover:bg-gray-200">âœ•</button>
        <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap pr-5 font-medium">{message}</p>
        {buttons && buttons.length > 0 && (
          <div className="flex flex-wrap gap-2 mt-3">
            {buttons.map((b, i) => (
              <button key={i} onClick={() => onButton(b.action)}
                className="px-3 py-1.5 rounded-full text-xs font-bold bg-amber-100 text-amber-700 hover:bg-amber-200 active:scale-95 transition">
                {b.label}
              </button>
            ))}
          </div>
        )}
        {/* ê¼¬ë¦¬ */}
        <div className="absolute -bottom-2 right-6 w-4 h-4 bg-white transform rotate-45" style={{filter:'drop-shadow(2px 2px 2px rgba(0,0,0,0.05))'}}/>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í€´ì¦ˆ ì˜¤ë²„ë ˆì´
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function QuizOverlay({ quiz, onAnswer, onClose }) {
  const [selected, setSelected] = useState(null);
  const [answered, setAnswered] = useState(false);

  const handleSelect = (idx) => {
    if (answered) return;
    setSelected(idx);
    setAnswered(true);
    setTimeout(() => onAnswer(idx === quiz.answer), 1500);
  };

  return (
    <div className="fixed inset-0 z-[90] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6">
      <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 anim-slide-up">
        <div className="flex items-center gap-2 mb-4">
          <SquirrelBuddy emotion="excited" size={40} animate={false}/>
          <h3 className="font-black text-lg text-gray-800">ì¤‘ê°„ í€´ì¦ˆ! ğŸ§©</h3>
        </div>
        <p className="font-bold text-gray-700 mb-4 text-base">{quiz.q}</p>
        <div className="space-y-2">
          {quiz.opts.map((opt, i) => {
            let cls = 'bg-gray-50 hover:bg-amber-50 border-gray-200';
            if (answered && i === quiz.answer) cls = 'bg-green-100 border-green-400';
            else if (answered && i === selected) cls = 'bg-red-100 border-red-400';
            return (
              <button key={i} onClick={() => handleSelect(i)}
                className={`w-full text-left p-3 rounded-xl border-2 font-medium transition ${cls}`}>
                {opt}
              </button>
            );
          })}
        </div>
        {answered && (
          <div className={`mt-4 p-3 rounded-xl text-center font-bold ${selected === quiz.answer ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-500'}`}>
            {selected === quiz.answer ? 'ì •ë‹µì´ì•¼! ëŒ€ë‹¨í•´! ğŸ‰' : 'ì•„ì‰½ë‹¤~ ë‹¤ì‹œ ì½ì–´ë³´ë©´ ì•Œ ìˆ˜ ìˆì„ ê±°ì•¼! ğŸ’ª'}
          </div>
        )}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë„ì„œ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function BookPage({ data, pageNum, total }) {
  if (data.isTitle) {
    return (
      <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center" style={{background:data.bg}}>
        <div className="text-7xl mb-6">{data.img}</div>
        <h1 className="text-3xl font-black text-gray-800 mb-3">{data.title}</h1>
        <p className="text-gray-500 text-lg">{data.subtitle}</p>
      </div>
    );
  }
  return (
    <div className="w-full h-full flex flex-col items-center justify-center p-8" style={{background:data.bg}}>
      <div className="text-6xl mb-8">{data.img}</div>
      <p className="text-xl leading-relaxed text-gray-800 text-center font-medium whitespace-pre-line max-w-md">{data.text}</p>
      <div className="absolute bottom-4 right-4 text-sm text-gray-400 font-medium">{pageNum} / {total}</div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í…ŒìŠ¤íŠ¸ ëª¨ë“œ íŒ¨ë„ (ì™¼ìª½)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function TestPanel({ open, onToggle, currentEmotion, onEmotionChange, onTriggerScenario, currentBubbleMsg }) {
  const emotions = [
    { key:'kind',    emoji:'ğŸ˜Š', label:'ë‹¤ì •í•¨', color:'bg-green-400', border:'border-green-500' },
    { key:'excited', emoji:'ğŸ‰', label:'ì‹ ë‚¨',   color:'bg-yellow-400', border:'border-yellow-500' },
    { key:'comfort', emoji:'ğŸ’œ', label:'ìœ„ë¡œ',   color:'bg-purple-500', border:'border-purple-600' },
    { key:'study',   emoji:'ğŸ’ª', label:'ì—´ê³µ',   color:'bg-amber-400', border:'border-amber-500' },
    { key:'sleepy',  emoji:'ğŸ˜´', label:'ì·¨ì¹¨',   color:'bg-gray-500', border:'border-gray-600' },
  ];

  const entryScenarios = [
    { id:'S01', emoji:'ğŸŒŸ', label:'ìµœì´ˆ ì§„ì…', color:'bg-green-500' },
    { id:'S02', emoji:'ğŸ“–', label:'ì¼ìë³„ ì²« ì§„ì…', color:'bg-teal-500' },
    { id:'S03', emoji:'ğŸ”„', label:'ì¼ìë³„ ì¬ì§„ì…', color:'bg-teal-600' },
  ];

  const readingScenarios = [
    { id:'S04', emoji:'ğŸ”¥', label:'ì§‘ì¤‘ ì½ê¸° ê²©ë ¤', color:'bg-orange-500' },
    { id:'S05', emoji:'ğŸ˜Š', label:'ì¥ì‹œê°„ ì²´ë¥˜', color:'bg-blue-500' },
    { id:'S06a', emoji:'â˜•', label:'ì´íƒˆ ê°ì§€ (3ë¶„)', color:'bg-purple-500' },
    { id:'S06b', emoji:'ğŸ˜´', label:'ì´íƒˆ ê°ì§€ (5ë¶„)', color:'bg-purple-600' },
    { id:'S06c', emoji:'ğŸŒ™', label:'ì´íƒˆ ê°ì§€ (7ë¶„)', color:'bg-purple-700' },
    { id:'S07', emoji:'ğŸ“–', label:'ë¹ ë¥¸ ë„˜ê¹€ ê°ì§€', color:'bg-red-500' },
    { id:'S08', emoji:'ğŸ§©', label:'ì¤‘ê°„ í€´ì¦ˆ ì œì•ˆ', color:'bg-pink-500' },
  ];

  const progressScenarios = [
    { id:'S09', emoji:'ğŸ’ª', label:'25% ë‹¬ì„±', color:'bg-amber-500' },
    { id:'S10', emoji:'ğŸƒ', label:'75% ë‹¬ì„±', color:'bg-amber-600' },
    { id:'S11', emoji:'ğŸŠ', label:'ì™„ë… ì§ì „', color:'bg-amber-700' },
    { id:'S12', emoji:'ğŸ‰', label:'ì™„ë… ì¶•í•˜', color:'bg-red-500' },
  ];

  const timeScenarios = [
    { id:'S16', emoji:'â˜€ï¸', label:'ì•„ì¹¨ ë…ì„œ', color:'bg-sky-400' },
    { id:'S17', emoji:'ğŸš', label:'ì ì‹¬ ì‹œê°„', color:'bg-sky-500' },
    { id:'S18', emoji:'ğŸŒ™', label:'ì €ë…/ì•¼ê°„', color:'bg-indigo-600' },
  ];

  const [activeScenario, setActiveScenario] = useState(null);

  const handleScenario = (id) => {
    setActiveScenario(id);
    onTriggerScenario(id);
  };

  if (!open) return (
    <button onClick={onToggle} className="fixed top-2 left-2 z-[80] px-3 py-1.5 rounded-lg bg-green-600/90 text-white text-xs font-bold backdrop-blur-sm hover:bg-green-500 transition">
      â— í…ŒìŠ¤íŠ¸ ëª¨ë“œ
    </button>
  );

  return (
    <div className="fixed top-2 left-2 z-[80] w-80 bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl text-sm overflow-hidden border border-gray-200" style={{maxHeight:'calc(100vh - 16px)'}}>
      <div className="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-100">
        <span className="font-black text-gray-800">â— <span className="text-green-600">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</span></span>
        <button onClick={onToggle} className="text-gray-400 hover:text-gray-600 text-xs font-bold px-2 py-1 rounded hover:bg-gray-100">âœ•</button>
      </div>
      <div className="p-4 space-y-4 overflow-y-auto" style={{maxHeight:'calc(100vh - 70px)'}}>

        {/* ì±—ë´‡ ê°ì • ìƒíƒœ (ìë™ í‘œì‹œ) */}
        <div>
          <h3 className="font-bold text-gray-800 text-xs mb-1">ì±—ë´‡ ê°ì • ìƒíƒœ</h3>
          <p className="text-[10px] text-gray-400 mb-2">ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ì‹œ ìë™ ë³€ê²½ë¨</p>
          <div className="flex gap-1.5">
            {emotions.map(em => (
              <div key={em.key}
                className={`flex-1 flex flex-col items-center gap-1 py-2 rounded-lg transition-all ${currentEmotion === em.key ? em.color + ' text-white ring-2 ring-offset-1 ring-blue-500 scale-105 shadow-md' : 'bg-gray-100 text-gray-400'}`}>
                <span className="text-lg">{em.emoji}</span>
                <span className="text-[10px] font-bold">{em.label}</span>
                {currentEmotion === em.key && <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"/>}
              </div>
            ))}
          </div>
        </div>

        <hr className="border-gray-200"/>

        {/* ì§„ì… ì‹œë‚˜ë¦¬ì˜¤ */}
        <div>
          <h3 className="font-bold text-gray-600 text-xs mb-2">ğŸ’¬ ì§„ì… ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="space-y-1.5">
            {entryScenarios.map(s => (
              <button key={s.id} onClick={() => handleScenario(s.id)}
                className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-sm text-white transition-all ${s.color} ${activeScenario === s.id ? 'ring-2 ring-offset-1 ring-blue-500 scale-[1.02]' : 'opacity-80 hover:opacity-100'}`}>
                <span>{s.emoji}</span><span>{s.label}</span>
              </button>
            ))}
          </div>
        </div>

        <hr className="border-gray-200"/>

        {/* ì½ê¸° ì¤‘ ì‹œë‚˜ë¦¬ì˜¤ */}
        <div>
          <h3 className="font-bold text-gray-600 text-xs mb-2">ğŸ“– ì½ê¸° ì¤‘ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="space-y-1.5">
            {readingScenarios.map(s => (
              <button key={s.id} onClick={() => handleScenario(s.id)}
                className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-sm text-white transition-all ${s.color} ${activeScenario === s.id ? 'ring-2 ring-offset-1 ring-blue-500 scale-[1.02]' : 'opacity-80 hover:opacity-100'}`}>
                <span>{s.emoji}</span><span>{s.label}</span>
              </button>
            ))}
          </div>
        </div>

        <hr className="border-gray-200"/>

        {/* ì§„ì²™ë„ ì‹œë‚˜ë¦¬ì˜¤ */}
        <div>
          <h3 className="font-bold text-gray-600 text-xs mb-2">ğŸ“Š ì§„ì²™ë„ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="space-y-1.5">
            {progressScenarios.map(s => (
              <button key={s.id} onClick={() => handleScenario(s.id)}
                className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-sm text-white transition-all ${s.color} ${activeScenario === s.id ? 'ring-2 ring-offset-1 ring-blue-500 scale-[1.02]' : 'opacity-80 hover:opacity-100'}`}>
                <span>{s.emoji}</span><span>{s.label}</span>
              </button>
            ))}
          </div>
        </div>

        <hr className="border-gray-200"/>

        {/* ì‹œê°„ëŒ€ë³„ ì‹œë‚˜ë¦¬ì˜¤ */}
        <div>
          <h3 className="font-bold text-gray-600 text-xs mb-2">ğŸ• ì‹œê°„ëŒ€ë³„ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="space-y-1.5">
            {timeScenarios.map(s => (
              <button key={s.id} onClick={() => handleScenario(s.id)}
                className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-sm text-white transition-all ${s.color} ${activeScenario === s.id ? 'ring-2 ring-offset-1 ring-blue-500 scale-[1.02]' : 'opacity-80 hover:opacity-100'}`}>
                <span>{s.emoji}</span><span>{s.label}</span>
              </button>
            ))}
          </div>
        </div>

        <hr className="border-gray-200"/>

        {/* í˜„ì¬ ë§í’ì„  */}
        <div>
          <h3 className="font-bold text-gray-600 text-xs mb-2">í˜„ì¬ ë§í’ì„ </h3>
          <div className="bg-gray-50 rounded-xl p-3 min-h-[40px]">
            <p className="text-xs text-gray-600 whitespace-pre-wrap italic">
              {currentBubbleMsg || '(ë§í’ì„  ì—†ìŒ)'}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„° ë¡œê¹… íŒ¨ë„ (ì˜¤ë¥¸ìª½)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function DataPanel({ data, open, onToggle }) {
  const emotionMap = { kind:'ğŸ˜Š ë‹¤ì •í•¨', excited:'ğŸ‰ ì‹ ë‚¨', comfort:'ğŸ’œ ìœ„ë¡œ', study:'ğŸ’ª ì—´ê³µ', sleepy:'ğŸ˜´ ì·¨ì¹¨' };
  const emotionLevel = { kind:4, excited:7, comfort:2, study:5, sleepy:1 };
  const emotionLabelMap = { kind:'ì•ˆì • (ê¸°ë³¸)', excited:'ì‹ ë‚¨ (ì—ë„ˆì§€ ì¶©ë§Œ)', comfort:'ìœ„ë¡œ (ê°€ë¼ì•‰ìŒ)', study:'ë‹¤ì •í•¨ (ì•ˆì •)', sleepy:'ì¡¸ë¦¼ (ì—ë„ˆì§€ ì €í•˜)' };
  const level = emotionLevel[data.emotion] || 4;

  if (!open) return (
    <button onClick={onToggle} className="fixed top-2 right-2 z-[80] px-3 py-1.5 rounded-lg bg-gray-800/80 text-green-400 text-xs font-mono backdrop-blur-sm">
      ğŸ“Š Data Logging <span className="bg-green-600 text-white px-1 rounded text-[10px] ml-1">DEV</span>
    </button>
  );
  return (
    <div className="fixed top-2 right-2 z-[80] w-80 bg-gray-900/95 backdrop-blur-sm rounded-2xl shadow-2xl text-xs font-mono text-gray-300 overflow-hidden" style={{maxHeight:'calc(100vh - 16px)'}}>
      <div className="flex items-center justify-between px-4 py-2.5 bg-gray-800">
        <span className="text-green-400 font-bold">ğŸ“Š Data Logging <span className="bg-green-600 text-white px-1.5 py-0.5 rounded text-[10px] ml-1">DEV</span></span>
        <button onClick={onToggle} className="text-gray-500 hover:text-white text-xs">ì ‘ê¸°</button>
      </div>
      <div className="p-3 space-y-3 overflow-y-auto" style={{maxHeight:'calc(100vh - 60px)'}}>

        {/* í•™ìŠµì ì •ë³´ */}
        <div className="bg-gray-800/50 rounded-xl p-3 space-y-1.5">
          <h4 className="text-red-400 font-bold text-xs mb-2">ğŸ§‘ í•™ìŠµì ì •ë³´</h4>
          <div className="flex justify-between"><span className="text-gray-400">ì´ë¦„</span><span className="text-white font-bold">{data.name}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">í•™ë…„</span><span className="text-white font-bold">ì´ˆ{data.grade}</span></div>
        </div>

        {/* ì•„ì´ ìƒíƒœ */}
        <div className="bg-gray-800/50 rounded-xl p-3 space-y-2">
          <h4 className="text-amber-400 font-bold text-xs">ğŸ˜Š ì•„ì´ ìƒíƒœ (8ë‹¨ê³„) <span className="text-gray-500 font-normal">- ë‚´ë¶€ ê°ì • ê°•ë„ íŒë‹¨ ì§€í‘œ</span></h4>
          <p className="text-[10px] text-gray-500 leading-tight">ğŸ‘† ë§ ê¸¸ì´, ì´ëª¨ì§€, í‚¤ì›Œë“œë¥¼ ì¢…í•©í•˜ì—¬ ì—ë„ˆì§€+ê°ì • ì•ˆì •ë„ë¥¼ 8ë‹¨ê³„ë¡œ ìˆ˜ì¹˜í™”</p>
          <div className="flex justify-between"><span className="text-gray-400">í˜„ì¬ ë ˆë²¨</span><span className="text-cyan-400 font-bold">{level}/8</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ìƒíƒœ ì„¤ëª…</span><span className="text-white">{emotionLabelMap[data.emotion] || 'ì•ˆì • (ê¸°ë³¸)'}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">â†’ ìºë¦­í„°</span><span className="text-white">{emotionMap[data.emotion] || 'ğŸ˜Š ë‹¤ì •í•¨'}</span></div>
          {/* ë ˆë²¨ ë°” */}
          <div className="w-full bg-gray-700 rounded-full h-2 mt-1">
            <div className="h-full rounded-full transition-all duration-500 bg-gradient-to-r from-blue-500 to-cyan-400" style={{width:`${(level/8)*100}%`}}/>
          </div>
          <div className="bg-gray-700/50 rounded-lg p-2 mt-2 space-y-0.5 text-[10px]">
            <p className="text-gray-400">â— 8ë‹¨ê³„ â†’ ìºë¦­í„° ë§¤í•‘</p>
            <p className="text-gray-500">1~2 â†’ ğŸ˜´ ì·¨ì¹¨ (ì™„ì „ ê¸°ì§„ë§¥ì§„)</p>
            <p className="text-gray-500">3 â†’ ğŸ’œ ìœ„ë¡œ (ê°€ë¼ì•‰ìŒ)</p>
            <p className="text-gray-500">4~5 â†’ ğŸ˜Š ë‹¤ì •í•¨ (ì•ˆì •)</p>
            <p className="text-gray-500">6~8 â†’ ğŸ‰ ì‹ ë‚¨ (ì—ë„ˆì§€ ì¶©ë§Œ)</p>
            <p className="text-amber-500 mt-1">ğŸ”¥ ì—´ê³µ = ê¸ˆì£¼ ì£¼ì œ + ë ˆë²¨3 ì´ìƒ</p>
          </div>
        </div>

        {/* ê´€ì‹¬ì‚¬ íƒœê·¸ */}
        <div className="bg-gray-800/50 rounded-xl p-3">
          <h4 className="text-green-400 font-bold text-xs mb-1">ğŸ·ï¸ ê´€ì‹¬ì‚¬ íƒœê·¸</h4>
          <p className="text-gray-500 text-[10px]">ëŒ€í™” ì‹œì‘ í›„ ìˆ˜ì§‘ë¨</p>
        </div>

        {/* ì„¸ì…˜ ë°ì´í„° */}
        <div className="bg-gray-800/50 rounded-xl p-3 space-y-1.5">
          <h4 className="text-purple-400 font-bold text-xs mb-2">ğŸ“¡ ì„¸ì…˜ ë°ì´í„°</h4>
          <div className="flex justify-between"><span className="text-gray-400">ëŒ€í™” ì‹œê°„</span><span className="text-white">{String(Math.floor(data.sessionTime/60)).padStart(2,'0')}:{String(data.sessionTime%60).padStart(2,'0')}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ë©”ì‹œì§€ ìˆ˜</span><span className="text-white">0</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ëŒ€í™” ëª¨ë“œ</span><span className="text-white">ë…ì„œ ëª¨ë“œ</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ì¢…ë£Œ ìœ í˜•</span><span className="text-white">-</span></div>
        </div>

        <hr className="border-gray-700"/>

        {/* ê¸°ì¡´ ì½ê¸° ë°ì´í„° */}
        <div className="space-y-1.5">
          <h4 className="text-amber-400 font-bold text-xs">ğŸ“š ë…ì„œ ë°ì´í„°</h4>
          <div className="flex justify-between"><span className="text-gray-400">ë„ì„œ</span><span className="text-white">{data.bookTitle}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">í˜„ì¬ í˜ì´ì§€</span><span className="text-white">{data.page} / {data.totalPages}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ì§„í–‰ë¥ </span><span className="text-white">{data.progress}%</span></div>
          <div className="flex justify-between"><span className="text-gray-400">í˜ì´ì§€ ì²´ë¥˜</span><span className="text-white">{data.pageTime}ì´ˆ</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ë§ˆì§€ë§‰ ì‹œë‚˜ë¦¬ì˜¤</span><span className="text-white">{data.lastScenario || '-'}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ë¹ ë¥¸ë„˜ê¹€</span><span className="text-white">{data.fastFlipCount}</span></div>
          <div className="flex justify-between"><span className="text-gray-400">ì—°ì†ì½ê¸°</span><span className="text-white">{data.steadyCount}</span></div>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë©”ì¸ ì•±
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App() {
  // í˜ì´ì§€ ìƒíƒœ
  const [page, setPage] = useState(1);
  const totalPages = BOOK_DATA.totalPages;
  const [uiVisible, setUiVisible] = useState(true);

  // AI ë²„ë”” ìƒíƒœ
  const [buddyVisible, setBuddyVisible] = useState(false);
  const [buddyEmotion, setBuddyEmotion] = useState('kind');
  const [bubbleMsg, setBubbleMsg] = useState(null);
  const [bubbleButtons, setBubbleButtons] = useState([]);
  const [showConfetti, setShowConfetti] = useState(false);
  const [showQuiz, setShowQuiz] = useState(false);
  const [quizIdx, setQuizIdx] = useState(0);

  // íŠ¸ë˜í‚¹ ë°ì´í„°
  const [sessionTime, setSessionTime] = useState(0);
  const [pageTime, setPageTime] = useState(0);
  const [fastFlipCount, setFastFlipCount] = useState(0);
  const [steadyCount, setSteadyCount] = useState(0);
  const lastFlipRef = useRef(Date.now());
  const idleTimerRef = useRef(null);
  const triggeredRef = useRef(new Set());
  const lastBubbleRef = useRef(0);
  const [devOpen, setDevOpen] = useState(false);
  const [testOpen, setTestOpen] = useState(false);

  const userName = 'í•˜ì¤€';

  // ì„¸ì…˜ íƒ€ì´ë¨¸
  useEffect(() => {
    const t = setInterval(() => setSessionTime(s => s + 1), 1000);
    return () => clearInterval(t);
  }, []);

  // í˜ì´ì§€ ì²´ë¥˜ íƒ€ì´ë¨¸
  useEffect(() => {
    setPageTime(0);
    const t = setInterval(() => setPageTime(s => s + 1), 1000);
    return () => clearInterval(t);
  }, [page]);

  // ì§„ì… ì‹œë‚˜ë¦¬ì˜¤ (ìµœì´ˆ)
  useEffect(() => {
    setTimeout(() => {
      setBuddyVisible(true);
      triggerScenario('S01');
    }, 800);
  }, []);

  // ì´íƒˆ ê°ì§€ (í˜ì´ì§€ ì²´ë¥˜ ì‹œê°„ ê¸°ë°˜)
  useEffect(() => {
    if (pageTime === 90 && !triggeredRef.current.has('S05_'+page)) {
      triggeredRef.current.add('S05_'+page);
      triggerScenario('S05');
    }
    if (pageTime === 180 && !triggeredRef.current.has('S06a')) {
      triggerScenario('S06a');
      triggeredRef.current.add('S06a');
    }
    if (pageTime === 300 && !triggeredRef.current.has('S06b')) {
      triggerScenario('S06b');
      triggeredRef.current.add('S06b');
    }
    if (pageTime === 420 && !triggeredRef.current.has('S06c')) {
      triggerScenario('S06c');
      triggeredRef.current.add('S06c');
    }
  }, [pageTime]);

  const triggerScenario = (id, force) => {
    const now = Date.now();
    // ì¿¨ë‹¤ìš´ ì²´í¬ (ì´íƒˆ ê°ì§€ ì œì™¸, forceì¼ ë•Œ ë¬´ì‹œ)
    if (!force && !id.startsWith('S06') && !id.startsWith('S01') && !id.startsWith('S12')) {
      if (now - lastBubbleRef.current < 5000) return; // ìµœì†Œ 5ì´ˆ ê°„ê²©
    }
    const s = SCENARIOS[id];
    if (!s) return;
    const data = {
      title: BOOK_DATA.title, name: userName, lastPage: page,
      readPages: page, remain: totalPages - page,
    };
    const msg = typeof s.msg === 'function' ? s.msg(data) : s.msg;
    setBuddyEmotion(s.emotion);
    setBubbleMsg(msg);
    setBubbleButtons(s.buttons || []);
    lastBubbleRef.current = now;
  };

  const closeBubble = () => { setBubbleMsg(null); setBubbleButtons([]); };

  const handlePageChange = (newPage) => {
    if (newPage < 1 || newPage > totalPages) return;
    const now = Date.now();
    const elapsed = now - lastFlipRef.current;
    lastFlipRef.current = now;

    closeBubble();

    // ë¹ ë¥¸ ë„˜ê¹€ ê°ì§€
    if (elapsed < 3000) {
      setFastFlipCount(c => {
        const nc = c + 1;
        if (nc >= 3 && !triggeredRef.current.has('S07_'+page)) {
          triggeredRef.current.add('S07_'+page);
          setTimeout(() => triggerScenario('S07'), 300);
        }
        return nc;
      });
    } else {
      setFastFlipCount(0);
    }

    // ì•ˆì •ì  ì½ê¸° ê°ì§€ (15~60ì´ˆ)
    if (elapsed >= 8000 && elapsed <= 60000) {
      setSteadyCount(c => {
        const nc = c + 1;
        if (nc >= 5 && !triggeredRef.current.has('S04')) {
          triggeredRef.current.add('S04');
          setTimeout(() => triggerScenario('S04'), 300);
        }
        return nc;
      });
    } else if (elapsed > 60000) {
      setSteadyCount(0);
    }

    // ì´íƒˆ ê°ì§€ ì´ˆê¸°í™”
    triggeredRef.current.delete('S06a');
    triggeredRef.current.delete('S06b');
    triggeredRef.current.delete('S06c');

    setPage(newPage);

    // ì§„ì²™ë„ ì‹œë‚˜ë¦¬ì˜¤
    const progress = Math.round((newPage / totalPages) * 100);
    setTimeout(() => {
      if (progress >= 25 && progress < 30 && !triggeredRef.current.has('S09')) {
        triggeredRef.current.add('S09');
        triggerScenario('S09');
      }
      if (progress >= 50 && progress < 55 && !triggeredRef.current.has('S08')) {
        triggeredRef.current.add('S08');
        triggerScenario('S08');
      }
      if (progress >= 75 && progress < 80 && !triggeredRef.current.has('S10')) {
        triggeredRef.current.add('S10');
        triggerScenario('S10');
      }
      if (totalPages - newPage <= 3 && totalPages - newPage > 0 && !triggeredRef.current.has('S11')) {
        triggeredRef.current.add('S11');
        triggerScenario('S11');
      }
      if (newPage === totalPages && !triggeredRef.current.has('S12')) {
        triggeredRef.current.add('S12');
        triggerScenario('S12');
        setShowConfetti(true);
        setTimeout(() => setShowConfetti(false), 4000);
      }
    }, 500);
  };

  const handleBuddyButton = (action) => {
    closeBubble();
    switch(action) {
      case 'quiz':
        setQuizIdx(Math.floor(Math.random() * QUIZZES.length));
        setShowQuiz(true);
        break;
      case 'activity':
        setBuddyEmotion('kind');
        setBubbleMsg('ê°ìƒë¬¸ ì“°ê¸° ê¸°ëŠ¥ìœ¼ë¡œ ì´ë™í• ê²Œ! ğŸ¨');
        setTimeout(closeBubble, 2000);
        break;
      case 'bookmark':
        setBuddyEmotion('kind');
        setBubbleMsg(`${page}í˜ì´ì§€ì— ë¶ë§ˆí¬í–ˆì–´! ë‹¤ìŒì— ì´ì–´ì„œ ì½ì! ğŸ“Œ`);
        setTimeout(closeBubble, 2000);
        break;
      case 'continue':
        setBuddyEmotion('study');
        setBubbleMsg('ì¢‹ì•„! ë” ì½ì–´ë³´ì! í™”ì´íŒ…! ğŸ’ª');
        setTimeout(closeBubble, 2000);
        break;
      case 'refocus':
        setBuddyEmotion('kind');
        setBubbleMsg('ì, ë‹¤ì‹œ ì§‘ì¤‘! ì´ í˜ì´ì§€ë¶€í„° ì½ì–´ë³´ì! ğŸ“–');
        setTimeout(closeBubble, 2000);
        break;
      default:
        break;
    }
  };

  const handleQuizAnswer = (correct) => {
    setTimeout(() => {
      setShowQuiz(false);
      if (correct) {
        setBuddyEmotion('excited');
        setBubbleMsg('ì •ë‹µ! ì—­ì‹œ ì˜ ì½ê³  ìˆêµ¬ë‚˜! ğŸ‰');
      } else {
        setBuddyEmotion('comfort');
        setBubbleMsg('ê´œì°®ì•„~ ë‹¤ì‹œ ì½ìœ¼ë©´ì„œ ì°¾ì•„ë³´ì! ğŸ“–');
      }
      setTimeout(closeBubble, 2500);
    }, 500);
  };

  // ìŠ¤ì™€ì´í”„
  const touchStartRef = useRef(null);
  const handleTouchStart = (e) => { touchStartRef.current = e.touches[0].clientX; };
  const handleTouchEnd = (e) => {
    if (!touchStartRef.current) return;
    const diff = touchStartRef.current - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) {
      diff > 0 ? handlePageChange(page + 1) : handlePageChange(page - 1);
    }
    touchStartRef.current = null;
  };

  const progress = Math.round((page / totalPages) * 100);
  const pageData = BOOK_DATA.pages[page - 1];

  return (
    <div className="w-full h-full flex flex-col bg-gray-900 select-none">
      {/* ìƒë‹¨ ë°” */}
      <div className={`shrink-0 flex items-center justify-between px-4 py-2 bg-black/60 backdrop-blur-sm z-30 transition-opacity duration-300 ${uiVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
        <div className="flex items-center gap-3">
          <button className="text-white/70 text-lg">âœ•</button>
          <span className="text-white/90 font-bold text-sm truncate max-w-[200px]">{BOOK_DATA.title}</span>
        </div>
        <div className="flex items-center gap-3">
          <span className="text-white/60 text-xs font-mono">{page}/{totalPages}</span>
        </div>
      </div>

      {/* ì§„í–‰ë¥  ë°” */}
      <div className={`shrink-0 h-1 bg-gray-800 transition-opacity duration-300 ${uiVisible ? 'opacity-100' : 'opacity-0'}`}>
        <div className="h-full bg-gradient-to-r from-amber-400 to-orange-500 transition-all duration-500 rounded-r-full" style={{width:`${progress}%`}}/>
      </div>

      {/* ë„ì„œ í˜ì´ì§€ */}
      <div className="flex-1 relative overflow-hidden"
        onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}
        onClick={() => setUiVisible(v => !v)}>
        <div className="absolute inset-0">
          <BookPage data={pageData} pageNum={page} total={totalPages}/>
        </div>

        {/* ì¢Œìš° ë„˜ê¹€ ë²„íŠ¼ */}
        <button onClick={(e) => { e.stopPropagation(); handlePageChange(page - 1); }}
          className={`absolute left-0 top-0 bottom-0 w-16 flex items-center justify-start pl-2 transition-opacity ${page > 1 && uiVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
          <span className="text-3xl text-black/20 hover:text-black/40 transition">â€¹</span>
        </button>
        <button onClick={(e) => { e.stopPropagation(); handlePageChange(page + 1); }}
          className={`absolute right-0 top-0 bottom-0 w-16 flex items-center justify-end pr-2 transition-opacity ${page < totalPages && uiVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
          <span className="text-3xl text-black/20 hover:text-black/40 transition">â€º</span>
        </button>
      </div>

      {/* AI ë²„ë”” */}
      {buddyVisible && (
        <div className="fixed bottom-6 right-4 z-50" onClick={e => e.stopPropagation()}>
          {/* ë§í’ì„  */}
          {bubbleMsg && (
            <SpeechBubble message={bubbleMsg} buttons={bubbleButtons} onButton={handleBuddyButton} onClose={closeBubble}/>
          )}
          {/* ë‹¤ëŒì¥ ìºë¦­í„° */}
          <div className="buddy-enter cursor-pointer pulse-glow rounded-full"
            onClick={() => {
              if (!bubbleMsg) {
                const msgs = ['ë¬´ì—‡ì´ ê¶ê¸ˆí•´? ğŸ˜Š','ì¬ë¯¸ìˆê²Œ ì½ê³  ìˆì–´?','ë„ì›€ì´ í•„ìš”í•˜ë©´ ë§í•´!'];
                setBubbleMsg(msgs[Math.floor(Math.random() * msgs.length)]);
                setTimeout(closeBubble, 3000);
              }
            }}>
            <SquirrelBuddy emotion={buddyEmotion} size={70}/>
          </div>
        </div>
      )}

      {/* ì»¨í˜í‹° */}
      {showConfetti && <Confetti/>}

      {/* í€´ì¦ˆ */}
      {showQuiz && (
        <QuizOverlay quiz={QUIZZES[quizIdx]} onAnswer={handleQuizAnswer} onClose={() => setShowQuiz(false)}/>
      )}

      {/* í…ŒìŠ¤íŠ¸ ëª¨ë“œ íŒ¨ë„ (ì™¼ìª½) */}
      <TestPanel
        open={testOpen}
        onToggle={() => setTestOpen(v => !v)}
        currentEmotion={buddyEmotion}
        onEmotionChange={(em) => { setBuddyEmotion(em); }}
        onTriggerScenario={(id) => {
          if (!buddyVisible) setBuddyVisible(true);
          // S12 ì™„ë…ì¶•í•˜ ì‹œ ì»¨í˜í‹°
          if (id === 'S12') {
            setShowConfetti(true);
            setTimeout(() => setShowConfetti(false), 4000);
          }
          // S08 ì¤‘ê°„í€´ì¦ˆ ì œì•ˆ ì‹œ í€´ì¦ˆë„ ê°€ëŠ¥í•˜ê²Œ
          triggerScenario(id, true);
        }}
        currentBubbleMsg={bubbleMsg}
      />

      {/* ë°ì´í„° ë¡œê¹… íŒ¨ë„ (ì˜¤ë¥¸ìª½) */}
      <DataPanel
        open={devOpen}
        onToggle={() => setDevOpen(v => !v)}
        data={{
          name: userName, grade: 4, bookTitle: BOOK_DATA.title,
          page, totalPages, progress, sessionTime, pageTime,
          emotion: buddyEmotion, lastScenario: triggeredRef.current.size > 0 ? [...triggeredRef.current].pop() : '-',
          fastFlipCount, steadyCount,
        }}
      />

      {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */}
      <div className={`shrink-0 px-4 py-3 bg-black/60 backdrop-blur-sm flex items-center gap-4 z-30 transition-opacity duration-300 ${uiVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
        <span className="text-white/60 text-xs">{page}</span>
        <input type="range" min="1" max={totalPages} value={page}
          onChange={e => handlePageChange(+e.target.value)}
          className="flex-1 h-1 accent-amber-400"/>
        <span className="text-white/60 text-xs">{totalPages}</span>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
