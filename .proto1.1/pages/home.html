<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - í™ˆ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1', paper: '#FDFBF7',
                            report: { bg: '#F8FAFC', accent: '#4F46E5', dark: '#1E293B' },
                            tech: { dark: '#1e293b', purple: '#8b5cf6', blue: '#3b82f6', cyan: '#06b6d4' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 25px -5px rgba(0, 0, 0, 0.05)',
                        'floating': '0 20px 25px -5px rgba(255, 159, 67, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        .font-jua { font-family: 'Jua', sans-serif; }

        /* === Week Header === */
        .week-nav-btn { transition: all 0.2s ease; }
        .week-nav-btn:hover { background: rgba(255,159,67,0.12); border-color: #FF9F43; }
        .week-nav-btn:active { transform: scale(0.9); }

        /* === Step Progress Bar (íƒ­â†’í”„ë¡œê·¸ë˜ìŠ¤ë°”) === */
        .step-progress-bar {
            display: flex; height: 32px; border-radius: 16px;
            background: #f0ebe3; overflow: hidden; position: relative;
        }
        .step-segment {
            flex: 1; position: relative; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 11.5px; font-weight: 700; color: #b8a080;
            transition: color 0.3s; z-index: 2;
            border-right: 2px solid rgba(255,255,255,0.5);
            user-select: none;
        }
        .step-segment:last-child { border-right: none; }
        .step-segment .seg-icon { margin-right: 4px; font-size: 13px; }
        .step-segment .seg-lock { font-size: 8px; margin-left: 3px; opacity: 0.6; }
        .step-segment.active { color: #fff; }
        .step-segment.completed { color: #fff; }
        .step-segment.locked { color: #c0b49a; cursor: default; }

        /* Gauge fill behind segments */
        .step-gauge {
            position: absolute; top: 0; left: 0; height: 100%;
            border-radius: 16px;
            background: linear-gradient(90deg, #FF9F43, #ffb347);
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
        }
        .step-gauge.full-complete {
            background: linear-gradient(90deg, #1dd1a1, #2ecc71);
        }

        /* === Book Spread (ì–‘ë©´ í¼ì¹¨) === */
        .book-spread {
            display: flex; flex-wrap: wrap;
            border-radius: 1.25rem;
            box-shadow: 0 4px 24px rgba(80,60,30,0.12), 0 2px 0 #ede6d8;
            border: 1px solid #e8e0d4;
            transition: all 0.3s ease;
        }
        .book-spread:hover {
            box-shadow: 0 8px 32px rgba(80,60,30,0.16), 0 2px 0 #ede6d8;
        }

        /* Aë©´: í‘œì§€ â€” ìµœì†Œ 220px ì´ìƒì´ë©´ ê°€ë¡œ ë°°ì¹˜, ì•„ë‹ˆë©´ ìë™ ìŠ¤íƒ */
        .spread-cover {
            flex: 1 1 220px; min-height: 200px; max-width: 42%;
            position: relative; background: #2c1810; overflow: hidden;
            border-radius: 1.25rem 0 0 1.25rem;
        }
        .spread-cover img {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        /* ì±… ë“± (spine) ê·¸ë¦¼ì */
        .spread-cover::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 20px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.15));
            pointer-events: none;
        }

        /* Bë©´: ë‚´ìš© */
        .spread-content {
            flex: 1 1 280px;
            background: #FDFBF7;
            padding: clamp(1rem, 3vw, 1.75rem);
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; min-width: 0;
            border-radius: 0 1.25rem 1.25rem 0;
        }
        /* ì¢…ì´ ì§ˆê° ëŠë‚Œ */
        .spread-content::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 16px; height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.06), transparent);
            pointer-events: none; z-index: 1;
        }

        /*
         * ë°˜ì‘í˜•: flex-wrapì´ ìë™ìœ¼ë¡œ ìŠ¤íƒì„ ì²˜ë¦¬í•˜ì§€ë§Œ,
         * ì„¸ë¡œ ìŠ¤íƒ ì‹œ Aë©´ì˜ max-width í•´ì œ + ê³ ì • ë†’ì´ ë¶€ì—¬
         */
        @media (max-width: 720px) {
            .spread-cover {
                max-width: 100%; min-height: 0;
                height: clamp(150px, 30vw, 220px);
                border-radius: 1.25rem 1.25rem 0 0;
            }
            .spread-cover::after {
                top: auto; right: auto; bottom: 0; left: 0;
                width: 100%; height: 16px;
                background: linear-gradient(180deg, transparent, rgba(0,0,0,0.12));
            }
            .spread-content {
                border-radius: 0 0 1.25rem 1.25rem;
                min-height: auto;
            }
            .spread-content::before {
                width: 100%; height: 12px;
                background: linear-gradient(180deg, rgba(0,0,0,0.05), transparent);
            }
        }

        /* ëª¨ë°”ì¼: ìƒë‹¨ í–„ë²„ê±° ë²„íŠ¼ ê³µê°„ í™•ë³´ + ì¶•ì†Œ */
        @media (max-width: 768px) {
            main.flex-1 { padding-top: 4rem; }
            .book-excerpt { -webkit-line-clamp: 3; line-clamp: 3; }
        }

        /* í”„ë¡œê·¸ë˜ìŠ¤ë°”Â·ë²„íŠ¼ ìœ ë™ ì‚¬ì´ì¦ˆ */
        @media (max-width: 480px) {
            .step-segment { font-size: 10px; }
            .step-segment .seg-icon { font-size: 11px; margin-right: 2px; }
            .step-progress-bar { height: 28px; }
            .cta-btn { padding: 11px; font-size: 13px; }
        }

        /* íƒœë¸”ë¦¿: Bë©´ ì½˜í…ì¸  ìœ ë™ ì¶•ì†Œ */
        @media (min-width: 721px) and (max-width: 1100px) {
            .spread-cover { max-width: 36%; min-height: 200px; }
            .spread-content { flex-basis: 320px; }
            /* Bë©´ ë‚´ë¶€ ë§ˆì§„Â·ê°­ ì¶•ì†Œ */
            .spread-content .book-info-top { gap: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .tag-row { margin-bottom: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .book-title { margin-bottom: 2px; }
            .spread-content .book-info-top .book-desc { margin-bottom: clamp(6px, 1.2vw, 16px); }
            .spread-content .book-excerpt { margin-bottom: clamp(8px, 1.5vw, 20px); }
            .book-excerpt { -webkit-line-clamp: 2; line-clamp: 2; font-size: clamp(0.75rem, 1.5vw, 0.88rem); line-height: 1.7; }
            .book-tag { font-size: 10px; padding: 3px 7px; }
            .cta-btn { padding: clamp(8px, 1.5vw, 12px); font-size: clamp(11px, 1.8vw, 14px); }
            .pg-indicator { font-size: 12px; }
            .pg-indicator .pg-num { font-size: 15px; }
            .pg-arrow { width: 28px; height: 28px; }
        }

        /* Book tag */
        .book-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: 700;
        }

        /* ë³¸ë¬¸ ì¸ìš© ìŠ¤íƒ€ì¼ */
        .book-excerpt {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: clamp(0.8rem, 1.8vw, 0.92rem);
            line-height: 1.85; color: #5c4a32;
            position: relative;
            padding-left: clamp(0.8rem, 2vw, 1.2rem);
            border-left: 3px solid #e8d5b8;
            word-break: keep-all; overflow-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* CTA Button */
        .cta-btn {
            width: 100%;
            padding: clamp(10px, 2vw, 13px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(12px, 2vw, 14px);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }

        .cta-btn-secondary {
            width: 100%;
            padding: clamp(8px, 1.5vw, 10px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(11px, 1.8vw, 13px);
            border: 2px solid #1dd1a1;
            background: white;
            color: #1dd1a1;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn-secondary:hover { background: #f0fdf9; transform: translateY(-1px); }

        /* Page indicator */
        .pg-indicator {
            display: flex; align-items: center; gap: 6px;
            font-size: 14px; font-weight: 700; color: #b8a080;
        }
        .pg-indicator .pg-num { color: #FF9F43; font-size: 18px; }
        .pg-arrow {
            width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid #e8e0d4;
            background: #fff; display: flex; align-items: center; justify-content: center;
            color: #b8a080; cursor: pointer; transition: all 0.2s;
        }
        .pg-arrow:hover { border-color: #FF9F43; color: #FF9F43; background: #fff8f0; }

        /* === Carousel (í‘œì‹œ/ìˆ¨ê¹€ ë°©ì‹) === */
        .story-carousel { position: relative; }
        .story-page { display: none; }
        .story-page.active-page { display: block; animation: fadeInPage 0.3s ease; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === Locked Card === */
        .locked-card-main {
            background: #fff; border-radius: 1.25rem;
            box-shadow: 0 2px 0 #ede6d8, 0 6px 24px rgba(120,90,50,0.08);
            border: 1px solid #f0ebe3;
            min-height: 320px; position: relative; overflow: hidden;
        }
        .locked-card-main .lock-veil {
            position: absolute; inset: 0; z-index: 10;
            background: rgba(255,255,255,0.7); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        .lock-badge {
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #f0ebe3, #e8e0d4);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: #b8a080;
        }
        .locked-card-main.unlocked .lock-veil { display: none; }
        .locked-card-main.unlocked { cursor: pointer; transition: all 0.3s; }
        .locked-card-main.unlocked:hover { transform: translateY(-1px); box-shadow: 0 2px 0 #ede6d8, 0 12px 32px rgba(120,90,50,0.14); }

        /* === Completion Card === */
        .completion-card {
            background: #fff; border-radius: 1.25rem; text-align: center;
            box-shadow: 0 2px 0 #8fe0bb, 0 6px 24px rgba(29,209,161,0.15);
            border: 1px solid #b2f0d1; overflow: hidden; min-height: 320px;
        }
        .completion-top {
            background: linear-gradient(135deg, #1dd1a1, #10b981);
            padding: 2rem; color: #fff; position: relative; overflow: hidden;
        }
        .completion-bottom {
            padding: 1.5rem 2rem; background: #fff;
        }
        .confetti-p {
            position: absolute; border-radius: 3px;
            animation: confetti-drift 2.5s ease-in-out infinite;
        }
        @keyframes confetti-drift {
            0% { transform: translateY(0) rotate(0); opacity: 0.9; }
            100% { transform: translateY(60px) rotate(600deg); opacity: 0; }
        }

        /* === Completion Stamp (ì™„ë£Œ ë„ì¥) === */
        .completion-stamp {
            position: absolute;
            top: 16px; right: 16px;
            z-index: 20;
            background: rgba(29, 209, 161, 0.13);
            border: 2.5px solid rgba(29, 209, 161, 0.5);
            color: #1dd1a1;
            font-family: 'Jua', sans-serif;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transform: rotate(-6deg);
            pointer-events: none;
            animation: stampAppear 0.4s ease-out;
        }
        .completion-stamp i {
            font-size: 16px;
        }
        @keyframes stampAppear {
            0% { opacity: 0; transform: rotate(-6deg) scale(0.5); }
            60% { transform: rotate(-6deg) scale(1.1); }
            100% { opacity: 1; transform: rotate(-6deg) scale(1); }
        }

        /* === General === */
        .book-card:hover { transform: translateY(-4px); }
        .level-badge { font-size: 10px; padding: 2px 8px; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-brand-bg font-sans text-gray-800 h-screen overflow-hidden">
    <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë²„íŠ¼ -->
    <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars text-gray-600 text-lg"></i>
    </button>

    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="flex w-full h-full">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 h-full overflow-y-auto px-6 py-8 md:px-12">
          <div class="max-w-[1400px] mx-auto">
            <!-- Header -->
            <header class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="font-jua text-2xl md:text-3xl text-gray-800">
                        <span data-user-name>ì§€í›ˆ</span>ë‹˜, ì•ˆë…•! ğŸ‘‹
                    </h2>
                    <p class="text-gray-500 mt-1">ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ë…ì„œ íƒí—˜ì„ ì‹œì‘í•´ë³¼ê¹Œìš”?</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative hide-mobile">
                        <input type="text" placeholder="ì±… ì œëª©, ì‘ê°€ ê²€ìƒ‰..." class="w-64 h-12 bg-white/80 border border-gray-200 rounded-2xl px-5 pr-12 outline-none focus:border-brand-primary focus:bg-white transition-all text-sm">
                        <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="window.location.href='diagnosis.html'" class="w-12 h-12 bg-gradient-to-br from-brand-primary to-orange-500 rounded-2xl border-2 border-orange-300 flex items-center justify-center text-white hover:shadow-lg hover:scale-105 transition-all shadow-md" title="ì§„ë‹¨ í…ŒìŠ¤íŠ¸">
                        <i class="fa-solid fa-compass text-lg"></i>
                    </button>
                </div>
            </header>

            <!-- Weekly Curriculum Section -->
            <section id="curriculum-section" class="mb-8">
                <div class="bg-white rounded-[1.5rem] shadow-lg border border-gray-100">

                    <!-- Row 1: Week Header -->
                    <div class="flex items-center justify-between px-6 pt-5 pb-3">
                        <div class="flex items-center gap-2">
                            <button onclick="prevWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <span id="week-label" class="font-jua text-lg text-gray-800 mx-1">1ì›” 1ì£¼ì°¨</span>
                            <button onclick="nextWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 bg-amber-50 px-3 py-1.5 rounded-full">
                            <span class="text-amber-500 text-sm">â­</span>
                            <span class="font-bold text-sm text-amber-600">125</span>
                        </div>
                    </div>

                    <!-- Row 2: Step Progress Bar -->
                    <div class="px-6 pb-4">
                        <div class="step-progress-bar" id="step-progress-bar">
                            <div class="step-gauge" id="step-gauge" style="width:0%"></div>
                            <div class="step-segment active" onclick="goToPage(0)" id="seg-book">
                                <span class="seg-icon">ğŸ“–</span><span id="seg-book-label">ë„ì„œì½ê¸°</span>
                            </div>
                            <div class="step-segment locked" onclick="goToPage(1)" id="seg-quiz">
                                <span class="seg-icon">â“</span>ë…í›„í€´ì¦ˆ<i class="fa-solid fa-lock seg-lock"></i>
                            </div>
                            <div class="step-segment locked hidden" onclick="goToPage(2)" id="seg-retelling">
                                <span class="seg-icon">ğŸ¬</span>AIë¦¬í…”ë§<i class="fa-solid fa-lock seg-lock"></i>
                            </div>
                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())" id="seg-vocab">
                                <span class="seg-icon">ğŸ®</span>ì–´íœ˜ì±Œë¦°ì§€<i class="fa-solid fa-lock seg-lock"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Card Carousel -->
                    <div class="px-6 pb-5" id="carousel-wrapper">
                        <div id="story-active" class="story-carousel">

                                <!-- PAGE 1: ë„ì„œ ì½ê¸° (ì–‘ë©´ í¼ì¹¨) -->
                                <div class="story-page active-page" data-page="book">
                                    <div class="book-spread" id="book-card">
                                        <!-- Aë©´: í‘œì§€ -->
                                        <div class="spread-cover" id="spread-cover" onclick="openBookViewer()" style="cursor:pointer;">
                                            <img id="book-cover-img" src="../img/book1.jpg" alt="ì±… í‘œì§€">
                                        </div>
                                        <!-- Bë©´: ë‚´ìš© -->
                                        <div class="spread-content">
                                            <!-- ìƒë‹¨: ì±… ì •ë³´ -->
                                            <div class="book-info-top" id="book-info-top" onclick="openBookViewer()" style="cursor:pointer;">
                                                <!-- Labels -->
                                                <div class="flex items-center gap-2 flex-wrap tag-row" style="margin-bottom:clamp(6px,1.5vw,12px);">
                                                    <span id="book-type-badge" class="book-tag bg-orange-50 text-orange-500">
                                                        <i class="fa-solid fa-bookmark text-[9px]"></i> ì½”ì–´ë¶
                                                    </span>
                                                    <span id="main-book-level" class="book-tag bg-indigo-50 text-indigo-500 border border-indigo-100">K2-1</span>
                                                </div>

                                                <!-- Title & Desc -->
                                                <h3 id="main-book-title" class="font-jua text-gray-900 book-title" style="font-size:clamp(1rem,2.5vw,1.25rem); margin-bottom:2px;">ì˜¤ì¦ˆì˜ ë§ˆë²•ì‚¬</h3>
                                                <p id="main-book-desc" class="text-xs text-gray-400 book-desc" style="margin-bottom:clamp(8px,1.5vw,16px);">ë„ë¡œì‹œì™€ í•¨ê»˜í•˜ëŠ” ì‹ ë¹„í•œ ëª¨í—˜ ì´ì•¼ê¸°</p>

                                                <!-- ë³¸ë¬¸ ì¸ìš© -->
                                                <div class="book-excerpt" id="book-excerpt" style="margin-bottom:clamp(8px,1.5vw,20px);">
                                                    ì¿µ! ë§ˆì¹¨ë‚´ íšŒì˜¤ë¦¬ë°”ëŒì´ ë©ˆì¶”ê³  ì§‘ì´ ë•…ì— ë–¨ì–´ì¡Œì–´ìš”.<br>
                                                    ë„ë¡œì‹œê°€ ì§‘ ë°–ìœ¼ë¡œ ë‚˜ì˜¤ì ì§€íŒ¡ì´ë¥¼ ë“  í• ë¨¸ë‹ˆê°€ ë‹¤ê°€ì™”ì–´ìš”.
                                                </div>
                                            </div>

                                            <!-- í•˜ë‹¨: CTA + í˜ì´ì§€ -->
                                            <div>
                                                <button id="main-action-btn" class="cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md" onclick="openBookViewer()">
                                                    <i class="fa-solid fa-book-open"></i>
                                                    <span id="main-action-text">ì½ê¸° ì‹œì‘</span>
                                                </button>
                                                <button id="reread-btn" class="hidden cta-btn-secondary mt-2" onclick="reReadBook()">
                                                    <i class="fa-solid fa-rotate-right"></i>
                                                    <span>ë‹¤ì‹œ ì½ê¸°</span>
                                                </button>

                                                <div class="flex items-center justify-end mt-3 gap-2" id="book-pg-area" onclick="openBookViewer()" style="cursor:pointer;">
                                                    <div class="pg-indicator">
                                                        <span class="pg-num" id="book-pg-current">1</span>
                                                        <span>/</span>
                                                        <span id="book-pg-total">8</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE 2: ë…í›„í€´ì¦ˆ -->
                                <div class="story-page" data-page="quiz">
                                    <div class="locked-card-main" id="quiz-card">
                                        <div class="lock-veil" id="quiz-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-jua text-base text-gray-500">ì±…ì„ ë¨¼ì € ì½ì–´ì£¼ì„¸ìš”</span>
                                            <span class="text-xs text-gray-400">ë…ì„œ ì™„ë£Œ í›„ í€´ì¦ˆê°€ ì—´ë ¤ìš”</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-amber-50 to-amber-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">â“</span>
                                            </div>
                                            <h4 class="font-jua text-2xl text-gray-800 mb-2">ë…í›„í€´ì¦ˆ</h4>
                                            <p class="text-sm text-gray-500 mb-4">ì±… ë‚´ìš©ì„ ì–¼ë§ˆë‚˜ ê¸°ì–µí•˜ê³  ìˆì„ê¹Œ?</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-amber-50 text-amber-600">ğŸ“ 5ë¬¸ì œ</span>
                                                <span class="book-tag bg-amber-50 text-amber-600">â­ +50ì </span>
                                            </div>
                                            <button onclick="window.location.href='quiz.html'" class="cta-btn bg-gradient-to-r from-amber-500 to-yellow-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> í€´ì¦ˆ ì‹œì‘í•˜ê¸°
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">2</span>/<span id="pg-total-quiz">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE 3: AIë¦¬í…”ë§ (2,4ì£¼ì°¨) -->
                                <div class="story-page hidden" data-page="retelling" id="page-retelling">
                                    <div class="locked-card-main" id="retelling-card">
                                        <div class="lock-veil" id="retelling-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-jua text-base text-gray-500">í€´ì¦ˆë¥¼ ë¨¼ì € í’€ì–´ì£¼ì„¸ìš”</span>
                                            <span class="text-xs text-gray-400">í€´ì¦ˆ ì™„ë£Œ í›„ ì—´ë ¤ìš”</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-pink-50 to-pink-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">ğŸ¬</span>
                                            </div>
                                            <h4 class="font-jua text-2xl text-gray-800 mb-2">AI ë¦¬í…”ë§</h4>
                                            <p class="text-sm text-gray-500 mb-4">ì´ì•¼ê¸°ë¥¼ ë‚˜ë§Œì˜ ë°©ì‹ìœ¼ë¡œ ë‹¤ì‹œ ë“¤ë ¤ì¤˜!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-pink-50 text-pink-600">ğŸ™ï¸ ìŒì„±ë…¹ìŒ</span>
                                                <span class="book-tag bg-pink-50 text-pink-600">â­ +70ì </span>
                                            </div>
                                            <button onclick="window.location.href='video-retelling.html'" class="cta-btn bg-gradient-to-r from-pink-500 to-rose-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> ë¦¬í…”ë§ ì‹œì‘í•˜ê¸°
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">3</span>/<span>4</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE: ì–´íœ˜ ì±Œë¦°ì§€ -->
                                <div class="story-page" data-page="vocab">
                                    <div class="locked-card-main" id="vocab-card">
                                        <div class="lock-veil" id="vocab-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-jua text-base text-gray-500">ì´ì „ ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”</span>
                                            <span class="text-xs text-gray-400">ìˆœì„œëŒ€ë¡œ ì§„í–‰í•´ì•¼ ì—´ë ¤ìš”</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">ğŸ®</span>
                                            </div>
                                            <h4 class="font-jua text-2xl text-gray-800 mb-2">ì–´íœ˜ ì±Œë¦°ì§€</h4>
                                            <p class="text-sm text-gray-500 mb-4">ì¬ë¯¸ìˆëŠ” ê²Œì„ìœ¼ë¡œ ìƒˆ ë‹¨ì–´ë¥¼ ì •ë³µí•˜ì!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-green-50 text-green-600">ğŸ† 10ë‹¨ì–´</span>
                                                <span class="book-tag bg-green-50 text-green-600">â­ +80ì </span>
                                            </div>
                                            <button onclick="window.location.href='vocabulary-challenge.html'" class="cta-btn bg-gradient-to-r from-green-500 to-emerald-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> ì±Œë¦°ì§€ ì‹œì‘í•˜ê¸°
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num" id="pg-vocab-num">3</span>/<span id="pg-vocab-total">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- Completed State -->
                        <div id="story-completed" class="hidden">
                            <div class="completion-card">
                                <div class="completion-top">
                                    <div class="confetti-p" style="width:10px;height:10px;background:#fff;left:15%;top:20%;animation-delay:0s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#ffd54f;left:40%;top:10%;animation-delay:0.4s;"></div>
                                    <div class="confetti-p" style="width:12px;height:6px;background:#ff8a65;left:65%;top:25%;animation-delay:0.8s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#80deea;left:85%;top:12%;animation-delay:0.2s;"></div>
                                    <div style="position:relative; z-index:2;">
                                        <div style="font-size:4rem; margin-bottom:0.5rem;">ğŸ†</div>
                                        <h3 class="font-jua text-2xl">í•™ìŠµ ì™„ë£Œ!</h3>
                                    </div>
                                </div>
                                <div class="completion-bottom">
                                    <p id="completed-book-title" class="text-sm text-gray-500 mb-4">ì˜¤ì¦ˆì˜ ë§ˆë²•ì‚¬ - ì´ë²ˆ ì£¼ í•™ìŠµ ì™„ë£Œ!</p>
                                    <div class="flex items-center justify-center gap-3 mb-5">
                                        <span class="book-tag bg-amber-50 text-amber-600 text-sm py-1.5 px-4">â­ +130</span>
                                        <span class="book-tag bg-indigo-50 text-indigo-600 text-sm py-1.5 px-4">ğŸ… ë°°ì§€ íšë“</span>
                                    </div>
                                    <button onclick="loadNextBook()" class="cta-btn bg-gradient-to-r from-emerald-500 to-green-400 text-white shadow-md">
                                        <i class="fa-solid fa-arrow-right"></i> ë‹¤ìŒ ì£¼ ì±… ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recommendations Section -->
            <section class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">âœ¨</span>
                        <h3 class="font-jua text-xl text-gray-800">ì¶”ì²œ ë„ì„œ</h3>
                        <span class="text-xs bg-brand-primary/10 text-brand-primary px-2 py-0.5 rounded-full">ë§ì¶¤ ì¶”ì²œ</span>
                    </div>
                    <button class="text-sm text-brand-primary font-medium hover:underline">ë”ë³´ê¸° â†’</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Recommended Book 1 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_02.png" alt="ì¶”ì²œë„ì„œ" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸŒ³</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ìˆ²ì† ì¹œêµ¬ë“¤</h4>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">ë™ë¬¼ ì¹œêµ¬ë“¤ì˜ ìš°ì • ì´ì•¼ê¸°</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-emerald-100 text-emerald-600 rounded-full font-bold">K1-1</span>
                                <span class="text-xs text-gray-400">ìì—°/ë™ë¬¼</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Book 2 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-violet-400 to-purple-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_03.png" alt="ì¶”ì²œë„ì„œ" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸš€</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ìš°ì£¼ íƒí—˜ëŒ€</h4>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">ì‹ ë¹„ë¡œìš´ ìš°ì£¼ ì—¬í–‰ ëª¨í—˜</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-violet-100 text-violet-600 rounded-full font-bold">K2-1</span>
                                <span class="text-xs text-gray-400">ê³¼í•™/ëª¨í—˜</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Book 3 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-rose-400 to-pink-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_04.png" alt="ì¶”ì²œë„ì„œ" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸ‘¸</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ê³µì£¼ì™€ ìš©</h4>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">ìš©ê°í•œ ê³µì£¼ì˜ ì´ì•¼ê¸°</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-rose-100 text-rose-600 rounded-full font-bold">K1-1</span>
                                <span class="text-xs text-gray-400">íŒíƒ€ì§€</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Textbook Connection Section -->
            <section class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ“š</span>
                        <h3 class="font-jua text-xl text-gray-800">êµê³¼ì„œ ì§ê¿</h3>
                        <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">êµ­ì–´ 3-1 ì—°ê³„</span>
                    </div>
                    <button class="text-sm text-brand-primary font-medium hover:underline">ë”ë³´ê¸° â†’</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Textbook Book 1 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-blue-100 flex gap-4 cursor-pointer hover:shadow-lg hover:border-blue-200 transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-sky-400 to-blue-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_05.png" alt="êµê³¼ì„œì§ê¿" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸ¸</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-blue-500 text-white px-1.5 py-0.5 rounded">1ë‹¨ì›</span>
                                <span class="text-[10px] text-blue-500 font-medium">ë…í›„í€´ì¦ˆ ì—°ê³„</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ê°œêµ¬ë¦¬ì™€ ë‘êº¼ë¹„</h4>
                            <p class="text-xs text-gray-500 mb-2">ì¹œêµ¬ ì‚¬ì´ì˜ ìš°ì • ì´ì•¼ê¸°</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-sky-100 text-sky-600 rounded-full font-bold">K2-1</span>
                            </div>
                        </div>
                    </div>

                    <!-- Textbook Book 2 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-green-100 flex gap-4 cursor-pointer hover:shadow-lg hover:border-green-200 transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-lime-400 to-green-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_06.png" alt="êµê³¼ì„œì§ê¿" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸŒ³</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-green-500 text-white px-1.5 py-0.5 rounded">2ë‹¨ì›</span>
                                <span class="text-[10px] text-green-500 font-medium">ë…í›„í€´ì¦ˆ ì—°ê³„</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ë‚˜ë¬´ë¥¼ ì‹¬ì€ ì‚¬ëŒ</h4>
                            <p class="text-xs text-gray-500 mb-2">ìì—°ì„ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒ</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-lime-100 text-lime-600 rounded-full font-bold">K3-1</span>
                            </div>
                        </div>
                    </div>

                    <!-- Textbook Book 3 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-amber-100 flex gap-4 cursor-pointer hover:shadow-lg hover:border-amber-200 transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_07.png" alt="êµê³¼ì„œì§ê¿" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">â­</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-amber-500 text-white px-1.5 py-0.5 rounded">3ë‹¨ì›</span>
                                <span class="text-[10px] text-amber-500 font-medium">ë…í›„í€´ì¦ˆ ì—°ê³„</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ë³„ì„ í—¤ì•„ë¦¬ë©°</h4>
                            <p class="text-xs text-gray-500 mb-2">ê¿ˆê³¼ í¬ë§ì˜ ì´ì•¼ê¸°</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-amber-100 text-amber-600 rounded-full font-bold">K2-1</span>
                            </div>
                        </div>
                    </div>

                    <!-- Textbook Book 4 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-pink-100 flex gap-4 cursor-pointer hover:shadow-lg hover:border-pink-200 transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-pink-400 to-rose-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_08.png" alt="êµê³¼ì„œì§ê¿" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/80 text-3xl">ğŸ’</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-pink-500 text-white px-1.5 py-0.5 rounded">4ë‹¨ì›</span>
                                <span class="text-[10px] text-pink-500 font-medium">ë…í›„í€´ì¦ˆ ì—°ê³„</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1 truncate">ì‚¬ë‘ì˜ ì„ ë¬¼</h4>
                            <p class="text-xs text-gray-500 mb-2">ê°€ì¡± ì‚¬ë‘ ì´ì•¼ê¸°</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-pink-100 text-pink-600 rounded-full font-bold">K1-1</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
          </div>
        </main>
    </div>

    <!-- Logout Modal Container -->
    <div id="logout-modal-container"></div>

    <!-- Scripts -->
    <script src="../js/common.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
        // ===== ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ ë°ì´í„° =====
        const weeklyData = {
            1: {
                type: 'core', bookType: 'ì½”ì–´ë¶',
                book: { title: 'ì˜¤ì¦ˆì˜ ë§ˆë²•ì‚¬', author: 'ë°”ì›€', desc: 'íšŒì˜¤ë¦¬ë°”ëŒì— ë‚ ë ¤ê°„ ë„ë¡œì‹œì˜ ì‹ ë¹„ë¡œìš´ ëª¨í—˜ ì´ì•¼ê¸°', level: 'K2-1' },
                excerpt: 'ì¿µ! ë§ˆì¹¨ë‚´ íšŒì˜¤ë¦¬ë°”ëŒì´ ë©ˆì¶”ê³  ì§‘ì´ ë•…ì— ë–¨ì–´ì¡Œì–´ìš”.\në„ë¡œì‹œê°€ ì§‘ ë°–ìœ¼ë¡œ ë‚˜ì˜¤ì ì§€íŒ¡ì´ë¥¼ ë“  í• ë¨¸ë‹ˆê°€ ë‹¤ê°€ì™”ì–´ìš”.\n"ì—¬ê¸°ëŠ” ì˜¤ì¦ˆì˜ ë‚˜ë¼ë€ë‹¤. ë„Œ ë‚˜ìœ ë§ˆë…€ë¥¼ ë¬¼ë¦¬ì³¤ì–´!"',
                coverImg: '../img/book1.jpg',
                steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                currentBookPage: 1, totalPages: 8
            },
            2: {
                type: 'managed', bookType: 'ê´€ë¦¬ì´ë¶',
                book: { title: 'ì•½ì†ì€ ì¦ê±°ì›Œ', author: 'ë°•ì€ê²½', desc: 'ì•½ì†ê³¼ ê·œì¹™ì˜ ì†Œì¤‘í•¨ì„ ë°°ìš°ëŠ” ìƒí™œ ë™í™”', level: 'K1-1' },
                excerpt: 'ì€ì§€ëŠ” ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ìœ ì¹˜ì›ì—ì„œ ì¦ê±°ìš´ í•˜ë£¨ë¥¼ ë³´ë‚´ìš”.\n"ìš°ë¦¬ ëª¨ë‘ ì°¨ë¡€ì°¨ë¡€ ì¤„ì„ ì„œì!" ì•½ì†ì„ ì§€í‚¤ë‹ˆê¹Œ\në†€ì´ì‹œê°„ì´ ë” ì¦ê±°ì›Œì¡Œì–´ìš”.',
                coverImg: '../img/book2.jpg',
                steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                currentBookPage: 1, totalPages: 8
            },
            3: {
                type: 'core', bookType: 'ì½”ì–´ë¶',
                book: { title: 'ìˆ­ìˆ­ì´ì™€ ë‚˜', author: 'ì§€ìœ¤ê²½', desc: 'íŠ¹ë³„í•œ ì¹œêµ¬ì™€ í•¨ê»˜ ìë¼ëŠ” ìš°ì • ì´ì•¼ê¸°', level: 'K3-1' },
                excerpt: 'ìˆ­ìˆ­ì´ëŠ” ë‚˜ë§Œ ì•Œì•„ë³´ëŠ” íŠ¹ë³„í•œ ì¹œêµ¬ì˜ˆìš”.\nì˜¤ëŠ˜ë„ ìˆ­ìˆ­ì´ì™€ ë‚˜ë€íˆ ê±¸ìœ¼ë©° ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ì–´ìš”.\n"ìš°ë¦¬ ë‚´ì¼ë„ ê°™ì´ ë†€ì!" ìˆ­ìˆ­ì´ê°€ ê³ ê°œë¥¼ ë„ë•ì˜€ì–´ìš”.',
                coverImg: '../img/book3.jpg',
                steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                currentBookPage: 1, totalPages: 8
            },
            4: {
                type: 'managed', bookType: 'ê´€ë¦¬ì´ë¶',
                book: { title: 'ë¹¨ê°„ë¨¸ë¦¬ ì•¤', author: 'ëª½ê³ ë©”ë¦¬', desc: 'ìƒìƒë ¥ ë„˜ì¹˜ëŠ” ì†Œë…€ ì•¤ì˜ ì´ˆë¡ ì§€ë¶• ì§‘ ì´ì•¼ê¸°', level: 'K5' },
                excerpt: 'ë§¤ìŠˆ ì•„ì €ì”¨ê°€ ë°ë ¤ì˜¨ ê±´ ë‚¨ìì•„ì´ê°€ ì•„ë‹ˆë¼ ë¹¨ê°„ ë¨¸ë¦¬ ì†Œë…€ì˜€ì–´ìš”!\n"ì €ë¥¼ ì•¤ì´ë¼ê³  ë¶ˆëŸ¬ì£¼ì„¸ìš”. eê°€ ë¶™ì€ Anneìš”!"\nì•¤ì€ ì´ˆë¡ ì§€ë¶• ì§‘ì—ì„œ ìƒˆë¡œìš´ ê°€ì¡±ê³¼ ìƒí™œì„ ì‹œì‘í–ˆì–´ìš”.',
                coverImg: '../img/book4.jpg',
                steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                currentBookPage: 1, totalPages: 8
            }
        };

        let currentWeek = 1;
        let currentPage = 0;

        // ===== Page Navigation =====
        function getTotalPages() { return weeklyData[currentWeek].steps.length; }
        function getLastPageIndex() { return getTotalPages() - 1; }

        function goToPage(idx) {
            const total = getTotalPages();
            if (idx < 0 || idx >= total) return;
            currentPage = idx;

            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê³  í˜„ì¬ í˜ì´ì§€ë§Œ í‘œì‹œ
            const pages = document.querySelectorAll('.story-page');
            const steps = weeklyData[currentWeek].steps;
            let visibleIdx = 0;
            pages.forEach(p => {
                const pageType = p.dataset.page;
                // hidden í´ë˜ìŠ¤ê°€ ìˆëŠ” í˜ì´ì§€ëŠ” ê±´ë„ˆëœ€
                if (p.classList.contains('hidden')) {
                    p.classList.remove('active-page');
                    return;
                }
                if (visibleIdx === idx) {
                    p.classList.add('active-page');
                } else {
                    p.classList.remove('active-page');
                }
                visibleIdx++;
            });

            updatePageIndicators();
            updatePageNavButtons();
        }

        function nextPage() { if (currentPage < getTotalPages() - 1) goToPage(currentPage + 1); }
        function prevPage() { if (currentPage > 0) goToPage(currentPage - 1); }

        function updatePageIndicators() {
            // ì±… í˜ì´ì§€ ì¸ë””ì¼€ì´í„°ëŠ” selectWeek/updateLearningProgressì—ì„œ ë³„ë„ ê´€ë¦¬
        }

        function updatePageNavButtons() {
            // ì±… í˜ì´ì§€ì˜ í™”ì‚´í‘œ ë²„íŠ¼ì€ ì œê±°ë¨ - ë‹¤ë¥¸ í˜ì´ì§€(í€´ì¦ˆ ë“±)ì˜ í™”ì‚´í‘œëŠ” ìì²´ inlineìœ¼ë¡œ ë™ì‘
        }

        // ===== ì£¼ì°¨ë³„ sessionStorage í‚¤ í—¬í¼ =====
        function getProgressKey(week) { return 'learningProgress_w' + (week || currentWeek); }
        function getBookKey(week) { return 'currentBook_w' + (week || currentWeek); }
        function getWeekProgress(week) { return JSON.parse(sessionStorage.getItem(getProgressKey(week)) || '{}'); }
        function getWeekBookData(week) { return JSON.parse(sessionStorage.getItem(getBookKey(week)) || '{}'); }
        function saveWeekProgress(data, week) { sessionStorage.setItem(getProgressKey(week), JSON.stringify(data)); }
        function saveWeekBookData(data, week) { sessionStorage.setItem(getBookKey(week), JSON.stringify(data)); }

        // ===== Book Viewer =====
        function openBookViewer() {
            const data = weeklyData[currentWeek];
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: data.currentBookPage, totalPages: data.totalPages,
                week: currentWeek
            };
            // ì£¼ì°¨ë³„ í‚¤ì— ì €ì¥
            saveWeekBookData(bookPayload, currentWeek);
            // book-viewerëŠ” ê¸°ì¡´ 'currentBook' í‚¤ë¥¼ ì½ìœ¼ë¯€ë¡œ í˜¸í™˜ìš©ìœ¼ë¡œë„ ì €ì¥
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));
            window.location.href = 'book-viewer.html';
        }

        // ===== ë‹¤ì‹œ ì½ê¸° =====
        function reReadBook() {
            const data = weeklyData[currentWeek];
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: 1, totalPages: data.totalPages,
                week: currentWeek,
                reReading: true  // ë‹¤ì‹œ ì½ê¸° í”Œë˜ê·¸ - í”„ë¡œê·¸ë˜ìŠ¤ë°”ì— ì˜í–¥ ì—†ìŒ
            };
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));
            window.location.href = 'book-viewer.html';
        }

        // ===== Week Navigation =====
        function prevWeek() { if (currentWeek > 1) selectWeek(currentWeek - 1); }
        function nextWeek() { if (currentWeek < 4) selectWeek(currentWeek + 1); }

        function selectWeek(week) {
            currentWeek = week;
            currentPage = 0;
            const data = weeklyData[week];

            // Week header
            document.getElementById('week-label').textContent = '1ì›” ' + week + 'ì£¼ì°¨';

            // Book spread: cover image
            document.getElementById('book-cover-img').src = data.coverImg;

            // Book spread: info
            document.getElementById('book-type-badge').innerHTML = '<i class="fa-solid fa-bookmark text-[9px]"></i> ' + data.bookType;
            document.getElementById('main-book-level').textContent = data.book.level;
            document.getElementById('main-book-title').textContent = data.book.title;
            document.getElementById('main-book-desc').textContent = data.book.desc;
            document.getElementById('book-excerpt').innerHTML = data.excerpt.replace(/\n/g, '<br>');

            // Segment label for book step
            document.getElementById('seg-book-label').textContent = data.bookType === 'ê´€ë¦¬ì´ë¶' ? 'ì´ë¶ì½ê¸°' : 'ë„ì„œì½ê¸°';

            // Show/hide retelling segment & page
            const retPage = document.getElementById('page-retelling');
            const retSeg = document.getElementById('seg-retelling');
            if (data.hasRetelling) {
                retPage.classList.remove('hidden');
                retSeg.classList.remove('hidden');
            } else {
                retPage.classList.add('hidden');
                retSeg.classList.add('hidden');
            }

            // ì±… í˜ì´ì§€ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
            document.getElementById('book-pg-current').textContent = data.currentBookPage;
            document.getElementById('book-pg-total').textContent = data.totalPages;

            // ë¨¼ì € ê¸°ë³¸ í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
            currentPage = -1;
            goToPage(0);

            // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë‚´ë¶€ì—ì„œ autoFocusNextStepì´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™)
            updateLearningProgress();
        }

        // ===== Step Progress Gauge =====
        function updateStepGauge() {
            const progress = getWeekProgress(currentWeek);
            const bookData = getWeekBookData(currentWeek);
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const data = weeklyData[currentWeek];
            const gauge = document.getElementById('step-gauge');
            const steps = data.steps;
            const segmentWidth = 100 / steps.length;

            const bookDone = bookData.completed === true || (sharedBook.week === currentWeek && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;

            // ë…ì„œ ì½ê¸° ì§„í–‰ë¥ : í˜„ì¬ í˜ì´ì§€ / ì „ì²´ í˜ì´ì§€
            const readPct = bookDone ? 100 : ((data.currentBookPage / data.totalPages) * 100);

            // ê° ë‹¨ê³„ë³„ ì™„ë£Œ ì—¬ë¶€ â†’ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ë¡œ í™˜ì‚°
            let filledSegments = 0;
            let partialFill = 0;

            // 1ë‹¨ê³„: ë„ì„œì½ê¸°
            if (bookDone) {
                filledSegments = 1;
                // 2ë‹¨ê³„: ë…í›„í€´ì¦ˆ
                if (quizDone) {
                    filledSegments = 2;
                    // 3ë‹¨ê³„: ë¦¬í…”ë§ (ìˆì„ ê²½ìš°)
                    if (data.hasRetelling) {
                        if (retellDone) {
                            filledSegments = 3;
                            if (vocabDone) filledSegments = 4;
                        }
                    } else {
                        if (vocabDone) filledSegments = 3;
                    }
                }
            } else {
                // ë„ì„œ ì½ê¸° ì§„í–‰ ì¤‘ â†’ ë¶€ë¶„ ì±„ì›€
                partialFill = (readPct / 100) * segmentWidth;
            }

            const totalWidth = bookDone
                ? (filledSegments * segmentWidth)
                : partialFill;

            gauge.style.width = Math.min(totalWidth, 100) + '%';

            // ì „ì²´ ì™„ë£Œ ì‹œ ë…¹ìƒ‰
            const allDone = vocabDone && quizDone && bookDone && (!data.hasRetelling || retellDone);
            gauge.classList.toggle('full-complete', allDone);
        }

        // ===== Learning Progress =====
        function updateLearningProgress() {
            const progress = getWeekProgress(currentWeek);
            const bookData = getWeekBookData(currentWeek);
            const data = weeklyData[currentWeek];

            // ë·°ì–´ì—ì„œ ëŒì•„ì˜¨ ê²½ìš°: ê³µìš© í‚¤ì—ì„œ ì£¼ì°¨ë³„ í‚¤ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            if (sharedBook.week === currentWeek && sharedBook.currentBookPage) {
                data.currentBookPage = sharedBook.currentBookPage;
                // ì£¼ì°¨ë³„ í‚¤ì— ë™ê¸°í™” ì €ì¥
                saveWeekBookData(sharedBook, currentWeek);
            } else if (bookData.currentBookPage) {
                data.currentBookPage = bookData.currentBookPage;
            }

            // sharedBookì€ í•´ë‹¹ ì£¼ì°¨ì¼ ë•Œë§Œ ì°¸ì¡°
            const sharedBookMatch = sharedBook.week === currentWeek;
            const bookDone = bookData.completed === true || (sharedBookMatch && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;
            const weekDone = progress.weekCompleted === true;

            // Step segments
            setSegState('seg-book', bookDone, !bookDone);
            setSegState('seg-quiz', quizDone, bookDone && !quizDone);
            if (data.hasRetelling) {
                setSegState('seg-retelling', retellDone, quizDone && !retellDone);
                setSegState('seg-vocab', vocabDone, retellDone && !vocabDone);
            } else {
                setSegState('seg-vocab', vocabDone, quizDone && !vocabDone);
            }

            // Lock/unlock cards
            setCardLock('quiz-card', !bookDone);
            if (data.hasRetelling) {
                setCardLock('retelling-card', !quizDone);
                setCardLock('vocab-card', !retellDone);
            } else {
                setCardLock('vocab-card', !quizDone);
            }

            // ì™„ë£Œ ë„ì¥ í‘œì‹œ
            updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, data.hasRetelling);

            // Book CTA button
            const btn = document.getElementById('main-action-btn');
            const actionTxt = document.getElementById('main-action-text');
            const rereadBtn = document.getElementById('reread-btn');

            // í‘œì§€ & ì±…ì •ë³´ & í˜ì´ì§€ ì˜ì—­ í´ë¦­ í•¸ë“¤ëŸ¬ ì°¸ì¡°
            const coverEl = document.getElementById('spread-cover');
            const pgArea = document.getElementById('book-pg-area');
            const infoTop = document.getElementById('book-info-top');

            if (bookDone) {
                btn.className = 'cta-btn bg-[#1dd1a1] text-white shadow-md opacity-80';
                btn.querySelector('i').className = 'fa-solid fa-check';
                actionTxt.textContent = 'ë…ì„œ ì™„ë£Œ';
                btn.onclick = null;
                document.getElementById('book-pg-current').textContent = data.totalPages;
                // ë‹¤ì‹œ ì½ê¸° ë²„íŠ¼ í‘œì‹œ
                if (rereadBtn) rereadBtn.classList.remove('hidden');
                // í‘œì§€ & ì±…ì •ë³´ & í˜ì´ì§€ ì˜ì—­ í´ë¦­ ë¹„í™œì„±í™”
                if (coverEl) { coverEl.onclick = null; coverEl.style.cursor = 'default'; }
                if (infoTop) { infoTop.onclick = null; infoTop.style.cursor = 'default'; }
                if (pgArea) { pgArea.onclick = null; pgArea.style.cursor = 'default'; }
            } else {
                btn.className = 'cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md';
                btn.querySelector('i').className = 'fa-solid fa-book-open';
                actionTxt.textContent = data.currentBookPage > 1 ? 'ê³„ì† ì½ê¸°' : 'ì½ê¸° ì‹œì‘';
                btn.onclick = openBookViewer;
                document.getElementById('book-pg-current').textContent = data.currentBookPage;
                // ë‹¤ì‹œ ì½ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                if (rereadBtn) rereadBtn.classList.add('hidden');
                // í‘œì§€ & ì±…ì •ë³´ & í˜ì´ì§€ ì˜ì—­ í´ë¦­ í™œì„±í™”
                if (coverEl) { coverEl.onclick = openBookViewer; coverEl.style.cursor = 'pointer'; }
                if (infoTop) { infoTop.onclick = openBookViewer; infoTop.style.cursor = 'pointer'; }
                if (pgArea) { pgArea.onclick = openBookViewer; pgArea.style.cursor = 'pointer'; }
            }

            // Step gauge
            updateStepGauge();

            // Completion
            if (weekDone) { showCompletedState(); } else { hideCompletedState(); }

            // ìë™ í¬ì»¤ì‹±: ì™„ë£Œëœ ë‹¨ê³„ ë‹¤ìŒìœ¼ë¡œ ì´ë™
            autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data);
        }

        // ===== ì™„ë£Œ ë„ì¥ í‘œì‹œ =====
        function updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, hasRetelling) {
            // ë„ì„œ ì½ê¸° ì™„ë£Œ ë„ì¥
            applyStamp('book-card', bookDone, 'ë…ì„œ ì™„ë£Œ!');
            applyStamp('quiz-card', quizDone, 'í€´ì¦ˆ ì™„ë£Œ!');
            if (hasRetelling) applyStamp('retelling-card', retellDone, 'ë¦¬í…”ë§ ì™„ë£Œ!');
            applyStamp('vocab-card', vocabDone, 'ì±Œë¦°ì§€ ì™„ë£Œ!');
        }

        function applyStamp(cardId, isDone, label) {
            const card = document.getElementById(cardId);
            if (!card) return;
            let stamp = card.querySelector('.completion-stamp');
            if (isDone) {
                if (!stamp) {
                    stamp = document.createElement('div');
                    stamp.className = 'completion-stamp';
                    stamp.innerHTML = '<i class="fa-solid fa-circle-check"></i> ' + label;
                    card.style.position = 'relative';
                    card.appendChild(stamp);
                }
                stamp.style.display = '';
            } else {
                if (stamp) stamp.style.display = 'none';
            }
        }

        // ===== ìë™ í¬ì»¤ì‹±: ë‹¤ìŒ ë¯¸ì™„ë£Œ ë‹¨ê³„ë¡œ ì´ë™ =====
        function autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data) {
            // ì£¼ì°¨ ì „í™˜ ì‹œì—ë§Œ ìë™ í¬ì»¤ì‹± (ì²« ë¡œë“œ ì‹œ)
            if (!bookDone) {
                // ë…ì„œ ë¯¸ì™„ë£Œ â†’ ë„ì„œì½ê¸° í˜ì´ì§€ (ê¸°ë³¸ê°’ì´ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”)
                return;
            }
            // ë…ì„œ ì™„ë£Œ â†’ í€´ì¦ˆ ë¯¸ì™„ë£Œë©´ í€´ì¦ˆë¡œ í¬ì»¤ì‹±
            if (bookDone && !quizDone) {
                goToPage(1);
                return;
            }
            // í€´ì¦ˆ ì™„ë£Œ
            if (quizDone) {
                if (data.hasRetelling && !retellDone) {
                    goToPage(2); // ë¦¬í…”ë§ìœ¼ë¡œ
                    return;
                }
                if (!data.hasRetelling && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab')); // ì–´íœ˜ì±Œë¦°ì§€ë¡œ
                    return;
                }
                if (data.hasRetelling && retellDone && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab'));
                    return;
                }
            }
        }

        function setSegState(id, isDone, isActive) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active', 'completed', 'locked');
            const lockIcon = el.querySelector('.seg-lock');
            if (isDone) {
                el.classList.add('completed');
                if (lockIcon) lockIcon.style.display = 'none';
            } else if (isActive) {
                el.classList.add('active');
                if (lockIcon) lockIcon.style.display = 'none';
            } else {
                el.classList.add('locked');
                if (lockIcon) lockIcon.style.display = '';
            }
        }

        function setCardLock(cardId, isLocked) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.toggle('unlocked', !isLocked);
        }

        // ===== Completion =====
        function showCompletedState() {
            document.getElementById('story-active').classList.add('hidden');
            document.getElementById('story-completed').classList.remove('hidden');

            const data = weeklyData[currentWeek];
            document.getElementById('completed-book-title').textContent = data.book.title + ' - ì´ë²ˆ ì£¼ í•™ìŠµ ì™„ë£Œ!';

            setSegState('seg-book', true, false);
            setSegState('seg-quiz', true, false);
            if (data.hasRetelling) setSegState('seg-retelling', true, false);
            setSegState('seg-vocab', true, false);

            // Gauge full
            document.getElementById('step-gauge').style.width = '100%';
            document.getElementById('step-gauge').classList.add('full-complete');
        }

        function hideCompletedState() {
            document.getElementById('story-active').classList.remove('hidden');
            document.getElementById('story-completed').classList.add('hidden');
        }

        function loadNextBook() {
            // ì£¼ì°¨ë³„ ì§„í–‰ ìƒíƒœëŠ” ìœ ì§€ (ë…ë¦½ì ì´ë¯€ë¡œ ì‚­ì œí•˜ì§€ ì•ŠìŒ)
            if (currentWeek < 4) { selectWeek(currentWeek + 1); }
            else { alert('ì´ë²ˆ ë‹¬ ëª¨ë“  í•™ìŠµì„ ì™„ë£Œí–ˆì–´ìš”! ë‹¤ìŒ ë‹¬ ì»¤ë¦¬í˜ëŸ¼ì„ ê¸°ëŒ€í•´ì£¼ì„¸ìš”!'); selectWeek(1); }
        }

        // ===== Init =====
        document.addEventListener('DOMContentLoaded', () => {
            // ìµœì´ˆ ì§„ì… ì‹œ ê³µìœ  í‚¤ ì •ë¦¬ (stale completed ìƒíƒœ ë°©ì§€)
            // book-viewerì—ì„œ ëŒì•„ì˜¨ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ê³µìœ  í‚¤ ì‚­ì œ
            const referrer = document.referrer || '';
            if (!referrer.includes('book-viewer')) {
                sessionStorage.removeItem('currentBook');
            }
            loadSidebar('home');
            loadLogoutModal();
            selectWeek(1);
        });

        // ===== Touch Swipe =====
        (function() {
            let startX = 0, dragging = false;
            const carousel = document.querySelector('.story-carousel');
            if (!carousel) return;
            carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; dragging = true; }, { passive: true });
            carousel.addEventListener('touchend', e => {
                if (!dragging) return; dragging = false;
                const diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) { diff > 0 ? nextPage() : prevPage(); }
            }, { passive: true });
        })();
    </script>
</body>
</html>
