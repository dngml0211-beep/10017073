<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>북클럽 3.0 - 홈</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1', paper: '#FDFBF7',
                            report: { bg: '#F8FAFC', accent: '#4F46E5', dark: '#1E293B' },
                            tech: { dark: '#1e293b', purple: '#8b5cf6', blue: '#3b82f6', cyan: '#06b6d4' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 25px -5px rgba(0, 0, 0, 0.05)',
                        'floating': '0 20px 25px -5px rgba(255, 159, 67, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        /* === Week Header === */
        .week-nav-btn { transition: all 0.2s ease; }
        .week-nav-btn:hover { background: rgba(255,159,67,0.12); border-color: #FF9F43; }
        .week-nav-btn:active { transform: scale(0.9); }

        /* === Level Badge Inline === */
        .level-badge-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FF9F43 0%, #f97316 100%);
            color: white;
            font-size: 13px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(255, 159, 67, 0.35);
            margin-right: 6px;
        }

        /* === Book Type Tabs (코어북/교과서 짝꿍책) === */
        .book-type-tabs {
            display: flex;
            gap: 8px;
            padding: 0 6px;
        }
        .book-type-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 14px;
            background: #f8f6f3;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }
        .book-type-tab:hover {
            background: #fff8f0;
            border-color: #ffe4c4;
        }
        .book-type-tab.active {
            background: white;
            border-color: #FF9F43;
            box-shadow: 0 2px 12px rgba(255, 159, 67, 0.2);
        }
        .book-type-tab .tab-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .book-type-tab.core .tab-icon {
            background: linear-gradient(135deg, #FF9F43, #f97316);
        }
        .book-type-tab.textbook .tab-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .book-type-tab .tab-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            min-width: 0;
        }
        .book-type-tab .tab-label {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: #6b7280;
            white-space: nowrap;
        }
        .book-type-tab.active .tab-label {
            color: #374151;
        }
        .book-type-tab .tab-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 11px;
            font-weight: 500;
            color: #9ca3af;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
        .book-type-tab.active .tab-title {
            color: #FF9F43;
        }
        .book-type-tab .tab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .book-type-tab .tab-badge.incomplete {
            background: #f59e0b;
        }
        @media (max-width: 480px) {
            .book-type-tab { padding: 10px 12px; }
            .book-type-tab .tab-icon { width: 32px; height: 32px; font-size: 16px; }
            .book-type-tab .tab-label { font-size: 12px; }
            .book-type-tab .tab-title { font-size: 10px; max-width: 70px; }
        }

        /* === Step Progress Bar (탭→프로그래스바) === */
        .step-progress-bar {
            display: flex; height: 40px; border-radius: 20px;
            background: #f0ebe3; overflow: hidden; position: relative;
        }
        .step-segment {
            flex: 1; position: relative; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: #b8a080;
            transition: color 0.3s; z-index: 2;
            border-right: 2px solid rgba(255,255,255,0.5);
            user-select: none;
        }
        .step-segment:last-child { border-right: none; }
        .step-segment .seg-icon { margin-right: 5px; font-size: 15px; }
        .step-segment .seg-lock { font-size: 8px; margin-left: 3px; opacity: 0.6; }
        .step-segment.active { color: #b8a080; }
        .step-segment.completed { color: #b8a080; }
        .step-segment.locked { color: #c0b49a; cursor: default; }
        .step-segment.gauge-covered { color: #fff; }

        /* Gauge fill behind segments */
        .step-gauge {
            position: absolute; top: 0; left: 0; height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, #FF9F43, #ffb347);
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
        }
        .step-gauge.full-complete {
            background: linear-gradient(90deg, #1dd1a1, #2ecc71);
        }
        /* 교과서 짝꿍책용 게이지 색상 */
        .step-gauge.textbook-gauge {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        .step-gauge.textbook-gauge.full-complete {
            background: linear-gradient(90deg, #059669, #10b981);
        }
        /* 게이지 전환 시 즉시 리셋 */
        .step-gauge.instant-reset {
            transition: none !important;
        }

        /* === Book Spread (양면 펼침) === */
        .book-spread {
            display: flex; flex-wrap: wrap;
            border-radius: 1.25rem;
            box-shadow: 0 4px 24px rgba(80,60,30,0.12), 0 2px 0 #ede6d8;
            border: 1px solid #e8e0d4;
            transition: all 0.3s ease;
            width: 70%;
            margin: 0 auto;
        }
        .book-spread:hover {
            box-shadow: 0 8px 32px rgba(80,60,30,0.16), 0 2px 0 #ede6d8;
        }

        /* A면: 표지 — 5:5 비율 */
        .spread-cover {
            flex: 1 1 50%; min-height: 200px; max-width: 50%;
            position: relative; background: #2c1810; overflow: hidden;
            border-radius: 1.25rem 0 0 1.25rem;
        }
        .spread-cover img {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        /* 책 등 (spine) 그림자 — 오른쪽 */
        .spread-cover::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 28px; height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.08) 40%, rgba(0,0,0,0.22) 100%);
            pointer-events: none;
        }

        /* B면: 내용 — 5:5 비율 */
        .spread-content {
            flex: 1 1 50%;
            background: #FDFBF7;
            padding: clamp(1rem, 3vw, 1.75rem);
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; min-width: 0;
            border-radius: 0 1.25rem 1.25rem 0;
            cursor: pointer;
        }
        /* 종이 질감 — 책 등 왼쪽 그림자 */
        .spread-content::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 24px; height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.12) 0%, rgba(0,0,0,0.04) 40%, transparent 100%);
            pointer-events: none; z-index: 1;
        }

        /* 페이지 넘김 애니메이션 — 설명 영역(B면)만 넘김 */
        @keyframes pageTurnRight {
            0% { transform: perspective(1200px) rotateY(0deg); opacity: 1; }
            60% { opacity: 0.6; }
            100% { transform: perspective(1200px) rotateY(-85deg); opacity: 0; }
        }
        .page-turning .spread-content {
            animation: pageTurnRight 0.55s ease-in forwards;
            transform-origin: left center;
        }

        /*
         * 반응형: flex-wrap이 자동으로 스택을 처리하지만,
         * 세로 스택 시 A면의 max-width 해제 + 고정 높이 부여
         */
        @media (max-width: 720px) {
            .book-spread {
                width: 100%;
                flex-direction: column;
            }
            .spread-cover {
                flex: none;
                max-width: 100%; min-height: 0;
                height: clamp(180px, 45vw, 260px);
                border-radius: 1.25rem 1.25rem 0 0;
            }
            .spread-cover img {
                width: 100%; height: 100%; object-fit: cover;
            }
            .spread-cover::after {
                top: auto; right: auto; bottom: 0; left: 0;
                width: 100%; height: 16px;
                background: linear-gradient(180deg, transparent, rgba(0,0,0,0.12));
            }
            .spread-content {
                flex: none;
                border-radius: 0 0 1.25rem 1.25rem;
                min-height: auto;
            }
            .spread-content::before {
                width: 100%; height: 12px;
                background: linear-gradient(180deg, rgba(0,0,0,0.05), transparent);
            }
        }

        /* 모바일: 축소 */
        @media (max-width: 768px) {
            .book-excerpt { -webkit-line-clamp: 3; line-clamp: 3; }
        }

        /* 프로그래스바·버튼 유동 사이즈 */
        @media (max-width: 480px) {
            .step-segment { font-size: 11px; }
            .step-segment .seg-icon { font-size: 12px; margin-right: 3px; }
            .step-progress-bar { height: 34px; border-radius: 17px; }
            .step-gauge { border-radius: 17px; }
            .cta-btn { padding: 11px; font-size: 13px; }
        }

        /* 모바일: 프로그래스바 컨테이너 너비 */
        @media (max-width: 720px) {
            .story-page .step-progress-bar { width: 100% !important; }
        }

        /* 태블릿: B면 콘텐츠 유동 축소 */
        @media (min-width: 721px) and (max-width: 1100px) {
            .spread-cover { max-width: 50%; min-height: 200px; }
            .spread-content { flex-basis: 50%; }
            /* B면 내부 마진·갭 축소 */
            .spread-content .book-info-top { gap: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .tag-row { margin-bottom: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .book-title { margin-bottom: 2px; }
            .spread-content .book-info-top .book-desc { margin-bottom: clamp(6px, 1.2vw, 16px); }
            .spread-content .book-excerpt { margin-bottom: clamp(8px, 1.5vw, 20px); }
            .book-excerpt { -webkit-line-clamp: 2; line-clamp: 2; font-size: clamp(0.85rem, 1.8vw, 1rem); line-height: 1.7; }
            .book-tag { font-size: 10px; padding: 3px 7px; }
            .cta-btn { padding: clamp(8px, 1.5vw, 12px); font-size: clamp(11px, 1.8vw, 14px); }
            .pg-indicator { font-size: 12px; }
            .pg-indicator .pg-num { font-size: 15px; }
            .pg-arrow { width: 28px; height: 28px; }
        }

        /* Book tag */
        .book-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: 700;
        }

        /* 본문 인용 스타일 */
        .book-excerpt {
            font-family: 'Gowun Batang', 'Noto Sans KR', serif;
            font-size: clamp(0.95rem, 2.2vw, 1.1rem);
            line-height: 1.85; color: #5c4a32;
            position: relative;
            padding-left: clamp(0.8rem, 2vw, 1.2rem);
            border-left: 3px solid #e8d5b8;
            word-break: keep-all; overflow-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* CTA Button */
        .cta-btn {
            width: 100%;
            padding: clamp(10px, 2vw, 13px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(12px, 2vw, 14px);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }

        .cta-btn-secondary {
            width: 100%;
            padding: clamp(8px, 1.5vw, 10px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(11px, 1.8vw, 13px);
            border: 2px solid #1dd1a1;
            background: white;
            color: #1dd1a1;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn-secondary:hover { background: #f0fdf9; transform: translateY(-1px); }

        /* Page indicator */
        .pg-indicator {
            display: flex; align-items: center; gap: 6px;
            font-size: 14px; font-weight: 700; color: #b8a080;
        }
        .pg-indicator .pg-num { color: #FF9F43; font-size: 18px; }
        .pg-arrow {
            width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid #e8e0d4;
            background: #fff; display: flex; align-items: center; justify-content: center;
            color: #b8a080; cursor: pointer; transition: all 0.2s;
        }
        .pg-arrow:hover { border-color: #FF9F43; color: #FF9F43; background: #fff8f0; }

        /* === Carousel (표시/숨김 방식) === */
        .story-carousel { position: relative; }
        .story-page { display: none; }
        .story-page.active-page { display: block; animation: fadeInPage 0.3s ease; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === Locked Card === */
        .locked-card-main {
            background: #fff; border-radius: 1.25rem;
            box-shadow: 0 2px 0 #ede6d8, 0 6px 24px rgba(120,90,50,0.08);
            border: 1px solid #f0ebe3;
            min-height: 320px; position: relative; overflow: hidden;
        }
        .locked-card-main .lock-veil {
            position: absolute; inset: 0; z-index: 10;
            background: rgba(255,255,255,0.7); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        .lock-badge {
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #f0ebe3, #e8e0d4);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: #b8a080;
        }
        .locked-card-main.unlocked .lock-veil { display: none; }
        .locked-card-main.unlocked { cursor: pointer; transition: all 0.3s; }
        .locked-card-main.unlocked:hover { transform: translateY(-1px); box-shadow: 0 2px 0 #ede6d8, 0 12px 32px rgba(120,90,50,0.14); }

        /* === Completion Card === */
        .completion-card {
            background: #fff; border-radius: 1.25rem; text-align: center;
            box-shadow: 0 2px 0 #8fe0bb, 0 6px 24px rgba(29,209,161,0.15);
            border: 1px solid #b2f0d1; overflow: hidden; min-height: 320px;
        }
        .completion-top {
            background: linear-gradient(135deg, #1dd1a1, #10b981);
            padding: 2rem; color: #fff; position: relative; overflow: hidden;
        }
        .completion-bottom {
            padding: 1.5rem 2rem; background: #fff;
        }
        .confetti-p {
            position: absolute; border-radius: 3px;
            animation: confetti-drift 2.5s ease-in-out infinite;
        }
        @keyframes confetti-drift {
            0% { transform: translateY(0) rotate(0); opacity: 0.9; }
            100% { transform: translateY(60px) rotate(600deg); opacity: 0; }
        }

        /* === Completion Stamp (완료 도장) === */
        .completion-stamp {
            position: absolute;
            top: 16px; right: 16px;
            z-index: 20;
            background: rgba(29, 209, 161, 0.13);
            border: 2.5px solid rgba(29, 209, 161, 0.5);
            color: #1dd1a1;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transform: rotate(-6deg);
            pointer-events: none;
            animation: stampAppear 0.4s ease-out;
        }
        .completion-stamp i {
            font-size: 16px;
        }
        @keyframes stampAppear {
            0% { opacity: 0; transform: rotate(-6deg) scale(0.5); }
            60% { transform: rotate(-6deg) scale(1.1); }
            100% { opacity: 1; transform: rotate(-6deg) scale(1); }
        }

        /* === General === */
        .book-card:hover { transform: translateY(-4px); }
        .level-badge { font-size: 10px; padding: 2px 8px; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* 찜하기 하트 */
        .fav-heart-sm {
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(255,255,255,0.85);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .fav-heart-sm:hover { transform: scale(1.15); }
        .fav-heart-sm i { font-size: 13px; color: #d1d5db; transition: color 0.2s; }
        .fav-heart-sm.active i { color: #ef4444; }
    </style>
</head>
<body class="bg-brand-bg font-sans text-gray-800 h-screen overflow-hidden">
    <!-- 모바일 햄버거 버튼 -->
    <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars text-gray-600 text-lg"></i>
    </button>

    <!-- 사이드바 오버레이 -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="flex w-full h-full">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 h-full overflow-y-auto px-6 py-8 md:px-12">
          <div class="max-w-[1400px]">
            <!-- Header -->
            <header class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="font-noto text-[19px] md:text-[25px] text-gray-800">
                        <span data-user-name>우희</span>님, 안녕! <button onclick="showTtottoPopup()" class="inline-flex items-center justify-center hover:scale-125 transition-transform cursor-pointer bg-transparent border-none p-0" style="outline:none;" title="또또와 대화하기">👋</button>
                    </h2>
                    <p class="text-gray-500 mt-1">오늘도 즐거운 독서 탐험을 시작해볼까요?</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative hide-mobile">
                        <input type="text" placeholder="책 제목, 작가 검색..." class="w-64 h-12 bg-white/80 border border-gray-200 rounded-2xl px-5 pr-12 outline-none focus:border-brand-primary focus:bg-white transition-all text-sm">
                        <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="openTool('diagnosis')" class="flex flex-col items-center group" title="진단 테스트">
                        <div class="w-12 h-12 bg-gradient-to-br from-brand-primary to-orange-500 rounded-2xl border-2 border-orange-300 flex items-center justify-center text-white hover:shadow-lg group-hover:scale-105 transition-all shadow-md">
                            <i class="fa-solid fa-compass text-lg"></i>
                        </div>
                        <span class="text-[9px] text-gray-400/70 mt-0.5 tracking-tight">진단테스트</span>
                    </button>
                </div>
            </header>

            <!-- Weekly Curriculum Section -->
            <section id="curriculum-section" class="mb-8">
                <div class="bg-white rounded-[1.5rem] shadow-lg border border-orange-100 overflow-hidden" style="position:relative;">

                    <!-- Row 1: Week Header -->
                    <div class="flex items-center justify-between px-6 pt-5 pb-3">
                        <div class="flex items-center gap-2">
                            <button onclick="prevWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <span id="week-label" class="font-noto text-lg text-gray-800 mx-1 flex items-center"><span class="level-badge-inline">K2-1</span> 1주차</span>
                            <button onclick="nextWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                        <button onclick="showStarRewardModal()" class="flex items-center gap-2 bg-amber-50 px-3 py-1.5 rounded-full hover:bg-amber-100 transition-all cursor-pointer border-none" style="outline:none;" title="별 상자 보기">
                            <span class="text-amber-500 text-sm">⭐</span>
                            <span class="font-bold text-sm text-amber-600">125</span>
                        </button>
                    </div>

                    <!-- Row 2: Book Type Tabs (코어북 vs 교과서 짝꿍책) -->
                    <div class="book-type-tabs px-6 pb-4" id="book-type-tabs">
                        <div class="book-type-tab core active" data-book-type="core" onclick="switchBookType('core')">
                            <div class="tab-icon">📕</div>
                            <div class="tab-content">
                                <span class="tab-label">코어북</span>
                                <span class="tab-title" id="core-book-title">오즈의 마법사</span>
                            </div>
                            <div class="tab-badge incomplete" id="core-badge"><i class="fa-solid fa-ellipsis"></i></div>
                        </div>
                        <div class="book-type-tab textbook" data-book-type="textbook" onclick="switchBookType('textbook')">
                            <div class="tab-icon">📗</div>
                            <div class="tab-content">
                                <span class="tab-label">교과서 짝꿍책</span>
                                <span class="tab-title" id="textbook-book-title">국어 2-1 연계</span>
                            </div>
                            <div class="tab-badge incomplete" id="textbook-badge" style="display:none;"><i class="fa-solid fa-check"></i></div>
                        </div>
                    </div>

                    <!-- Row 3: Card Carousel -->
                    <div class="px-6 pb-5 bg-[#FFF8F0]" id="carousel-wrapper">
                        <div id="story-active" class="story-carousel">

                                <!-- PAGE 1: 도서 읽기 (양면 펼침) -->
                                <div class="story-page active-page" data-page="book">
                                    <div class="book-spread" id="book-card">
                                        <!-- A면: 표지 -->
                                        <div class="spread-cover" id="spread-cover" onclick="openBookViewer()" style="cursor:pointer;">
                                            <img id="book-cover-img" src="../img/book1.jpg" alt="책 표지">
                                        </div>
                                        <!-- B면: 내용 -->
                                        <div class="spread-content" onclick="openBookViewer()"
                                            <!-- 상단: 책 정보 -->
                                            <div class="book-info-top" id="book-info-top" onclick="openBookViewer()" style="cursor:pointer;">
                                                <!-- Labels -->
                                                <div class="flex items-center gap-2 flex-wrap tag-row" style="margin-bottom:clamp(6px,1.5vw,12px);">
                                                    <span id="book-type-badge" class="book-tag bg-orange-50 text-orange-500">
                                                        <i class="fa-solid fa-bookmark text-[9px]"></i> 코어북
                                                    </span>
                                                    <span id="main-book-level" class="book-tag bg-indigo-50 text-indigo-500 border border-indigo-100">K2-1</span>
                                                </div>

                                                <!-- Title & Desc -->
                                                <h3 id="main-book-title" class="font-noto text-gray-900 book-title" style="font-size:clamp(1rem,2.5vw,1.25rem); margin-bottom:2px;">오즈의 마법사</h3>
                                                <p id="main-book-desc" class="text-xs text-gray-400 book-desc" style="margin-bottom:clamp(8px,1.5vw,16px);">도로시와 함께하는 신비한 모험 이야기</p>

                                                <!-- 본문 인용 -->
                                                <div class="book-excerpt" id="book-excerpt" style="margin-bottom:clamp(8px,1.5vw,20px);">
                                                    쿵! 마침내 회오리바람이 멈추고 집이 땅에 떨어졌어요.<br>
                                                    도로시가 집 밖으로 나오자 지팡이를 든 할머니가 다가왔어요.
                                                </div>
                                            </div>

                                            <!-- 하단: CTA + 페이지 -->
                                            <div>
                                                <button id="main-action-btn" class="cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md" onclick="openBookViewer()">
                                                    <i class="fa-solid fa-book-open"></i>
                                                    <span id="main-action-text">읽기 시작</span>
                                                </button>
                                                <button id="reread-btn" class="hidden cta-btn-secondary mt-2" onclick="reReadBook()">
                                                    <i class="fa-solid fa-rotate-right"></i>
                                                    <span>다시 읽기</span>
                                                </button>

                                                <div class="flex items-center justify-end mt-3 gap-2" id="book-pg-area" onclick="openBookViewer()" style="cursor:pointer;">
                                                    <div class="pg-indicator">
                                                        <span class="pg-num" id="book-pg-current">1</span>
                                                        <span>/</span>
                                                        <span id="book-pg-total">8</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step Progress Bar (책 아래 배치 - 시원하게 확장) -->
                                    <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                        <div class="step-progress-bar" id="step-progress-bar">
                                            <div class="step-gauge" id="step-gauge" style="width:0%"></div>
                                            <div class="step-segment active" onclick="goToPage(0)" id="seg-book">
                                                <span class="seg-icon">📖</span><span id="seg-book-label">도서읽기</span>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(1)" id="seg-quiz">
                                                <span class="seg-icon">❓</span>독후퀴즈<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked hidden" onclick="goToPage(2)" id="seg-retelling">
                                                <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())" id="seg-vocab">
                                                <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE 2: 독후퀴즈 -->
                                <div class="story-page" data-page="quiz">
                                    <div class="locked-card-main" id="quiz-card">
                                        <div class="lock-veil" id="quiz-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">책을 먼저 읽어주세요</span>
                                            <span class="text-xs text-gray-400">독서 완료 후 퀴즈가 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-amber-50 to-amber-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">❓</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">독후퀴즈</h4>
                                            <p class="text-sm text-gray-500 mb-4">책 내용을 얼마나 기억하고 있을까?</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-amber-50 text-amber-600">📝 5문제</span>
                                                <span class="book-tag bg-amber-50 text-amber-600">⭐ +50점</span>
                                            </div>
                                            <button onclick="window.location.href='quiz.html'" class="cta-btn bg-gradient-to-r from-amber-500 to-yellow-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 퀴즈 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">2</span>/<span id="pg-total-quiz">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                            <!-- Step Progress Bar (독후퀴즈 페이지) -->
                                            <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                                <div class="step-progress-bar">
                                                    <div class="step-gauge" style="width:25%"></div>
                                                    <div class="step-segment completed" onclick="goToPage(0)">
                                                        <span class="seg-icon">📖</span>도서읽기
                                                    </div>
                                                    <div class="step-segment active" onclick="goToPage(1)">
                                                        <span class="seg-icon">❓</span>독후퀴즈
                                                    </div>
                                                    <div class="step-segment locked hidden" onclick="goToPage(2)">
                                                        <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                                    </div>
                                                    <div class="step-segment locked" onclick="goToPage(getLastPageIndex())">
                                                        <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE 3: AI리텔링 (2,4주차) -->
                                <div class="story-page hidden" data-page="retelling" id="page-retelling">
                                    <div class="locked-card-main" id="retelling-card">
                                        <div class="lock-veil" id="retelling-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">퀴즈를 먼저 풀어주세요</span>
                                            <span class="text-xs text-gray-400">퀴즈 완료 후 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-pink-50 to-pink-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">🎬</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">AI 리텔링</h4>
                                            <p class="text-sm text-gray-500 mb-4">이야기를 나만의 방식으로 다시 들려줘!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-pink-50 text-pink-600">🎙️ 음성녹음</span>
                                                <span class="book-tag bg-pink-50 text-pink-600">⭐ +70점</span>
                                            </div>
                                            <button onclick="window.location.href='video-retelling.html'" class="cta-btn bg-gradient-to-r from-pink-500 to-rose-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 리텔링 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">3</span>/<span>4</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                            <!-- Step Progress Bar (AI리텔링 페이지) -->
                                            <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                                <div class="step-progress-bar">
                                                    <div class="step-gauge" style="width:50%"></div>
                                                    <div class="step-segment completed" onclick="goToPage(0)">
                                                        <span class="seg-icon">📖</span>도서읽기
                                                    </div>
                                                    <div class="step-segment completed" onclick="goToPage(1)">
                                                        <span class="seg-icon">❓</span>독후퀴즈
                                                    </div>
                                                    <div class="step-segment active" onclick="goToPage(2)">
                                                        <span class="seg-icon">🎬</span>AI리텔링
                                                    </div>
                                                    <div class="step-segment locked" onclick="goToPage(getLastPageIndex())">
                                                        <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE: 어휘 챌린지 -->
                                <div class="story-page" data-page="vocab">
                                    <div class="locked-card-main" id="vocab-card">
                                        <div class="lock-veil" id="vocab-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">이전 단계를 완료해주세요</span>
                                            <span class="text-xs text-gray-400">순서대로 진행해야 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">🎮</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">어휘 챌린지</h4>
                                            <p class="text-sm text-gray-500 mb-4">재미있는 게임으로 새 단어를 정복하자!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-green-50 text-green-600">🏆 10단어</span>
                                                <span class="book-tag bg-green-50 text-green-600">⭐ +80점</span>
                                            </div>
                                            <button onclick="window.location.href='vocabulary-challenge.html'" class="cta-btn bg-gradient-to-r from-green-500 to-emerald-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 챌린지 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num" id="pg-vocab-num">3</span>/<span id="pg-vocab-total">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                            <!-- Step Progress Bar (어휘챌린지 페이지) -->
                                            <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                                <div class="step-progress-bar">
                                                    <div class="step-gauge" style="width:75%"></div>
                                                    <div class="step-segment completed" onclick="goToPage(0)">
                                                        <span class="seg-icon">📖</span>도서읽기
                                                    </div>
                                                    <div class="step-segment completed" onclick="goToPage(1)">
                                                        <span class="seg-icon">❓</span>독후퀴즈
                                                    </div>
                                                    <div class="step-segment completed hidden" onclick="goToPage(2)">
                                                        <span class="seg-icon">🎬</span>AI리텔링
                                                    </div>
                                                    <div class="step-segment active" onclick="goToPage(getLastPageIndex())">
                                                        <span class="seg-icon">🎮</span>어휘챌린지
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- Completed State -->
                        <div id="story-completed" class="hidden">
                            <div class="completion-card">
                                <div class="completion-top">
                                    <div class="confetti-p" style="width:10px;height:10px;background:#fff;left:15%;top:20%;animation-delay:0s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#ffd54f;left:40%;top:10%;animation-delay:0.4s;"></div>
                                    <div class="confetti-p" style="width:12px;height:6px;background:#ff8a65;left:65%;top:25%;animation-delay:0.8s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#80deea;left:85%;top:12%;animation-delay:0.2s;"></div>
                                    <div style="position:relative; z-index:2;">
                                        <div style="font-size:4rem; margin-bottom:0.5rem;">🏆</div>
                                        <h3 class="font-noto text-2xl">학습 완료!</h3>
                                    </div>
                                </div>
                                <div class="completion-bottom">
                                    <p id="completed-book-title" class="text-sm text-gray-500 mb-4">오즈의 마법사 - 이번 주 학습 완료!</p>
                                    <div class="flex items-center justify-center gap-3 mb-5">
                                        <span class="book-tag bg-amber-50 text-amber-600 text-sm py-1.5 px-4">⭐ +130</span>
                                        <span class="book-tag bg-indigo-50 text-indigo-600 text-sm py-1.5 px-4">🏅 배지 획득</span>
                                    </div>
                                    <button onclick="loadNextBook()" class="cta-btn bg-gradient-to-r from-emerald-500 to-green-400 text-white shadow-md">
                                        <i class="fa-solid fa-arrow-right"></i> 다음 주 책 불러오기
                                    </button>
                                </div>
                            </div>
                        </div>
                    <!-- Star Reward Modal (주차 영역 내부에 표시) -->
            <div id="star-reward-modal" class="hidden" style="position:absolute;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);backdrop-filter:blur(3px);border-radius:1.5rem;">
                <div class="star-reward-content" style="background:linear-gradient(135deg,#FFF8DC,#FFFACD);border-radius:20px;padding:28px;text-align:center;max-width:300px;width:85%;box-shadow:0 16px 48px rgba(0,0,0,0.25);position:relative;overflow:hidden;animation:modalAppear 0.4s ease;">
                    <!-- 별 배경 장식 (⭐로 통일) -->
                    <div class="star-bg" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;">
                        <span style="position:absolute;font-size:18px;top:10%;left:10%;opacity:0.3;animation:twinkle 1.5s infinite;">⭐</span>
                        <span style="position:absolute;font-size:14px;top:20%;right:15%;opacity:0.4;animation:twinkle 2s infinite 0.3s;">⭐</span>
                        <span style="position:absolute;font-size:16px;bottom:20%;left:15%;opacity:0.3;animation:twinkle 1.8s infinite 0.5s;">⭐</span>
                        <span style="position:absolute;font-size:12px;bottom:30%;right:10%;opacity:0.4;animation:twinkle 2.2s infinite 0.7s;">⭐</span>
                    </div>
                    <!-- 별상자 아이콘 -->
                    <div id="star-box-icon" style="font-size:64px;margin-bottom:12px;cursor:pointer;transition:transform 0.3s;position:relative;z-index:2;" onclick="openStarBox()">🎁</div>
                    <h3 class="font-noto" style="font-size:18px;font-weight:700;color:#B8860B;margin-bottom:6px;position:relative;z-index:2;">별상자 획득!</h3>
                    <p style="font-size:13px;color:#DAA520;margin-bottom:16px;position:relative;z-index:2;">이번 주 학습을 모두 완료했어요!<br>상자를 열어 별 보상을 받으세요!</p>
                    <!-- 별 보상 결과 (처음에 숨김) -->
                    <div id="star-reward-result" class="hidden" style="position:relative;z-index:2;">
                        <div style="font-size:48px;margin-bottom:10px;">⭐</div>
                        <div style="font-size:36px;font-weight:800;color:#B8860B;text-shadow:1px 1px 0 #FFD700, -1px -1px 0 #FFD700, 1px -1px 0 #FFD700, -1px 1px 0 #FFD700, 0 0 8px rgba(255,215,0,0.5);background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,165,0,0.2));padding:8px 20px;border-radius:12px;display:inline-block;" id="star-count">+15</div>
                        <p style="font-size:13px;color:#8B6914;margin-top:10px;font-weight:600;">별을 획득했어요!</p>
                    </div>
                    <button id="star-reward-close-btn" class="hidden" onclick="closeStarRewardModal()" style="margin-top:16px;padding:10px 28px;border-radius:10px;background:linear-gradient(135deg,#FFD700,#FFA500);color:white;font-weight:700;font-size:14px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(255,165,0,0.4);transition:all 0.2s;position:relative;z-index:2;">
                        확인
                    </button>
                </div>
            </div>
                </div>
            </section>
            <style>
                @keyframes modalAppear {
                    from { opacity:0; transform:scale(0.8) translateY(20px); }
                    to { opacity:1; transform:scale(1) translateY(0); }
                }
                @keyframes twinkle {
                    0%, 100% { opacity:0.3; transform:scale(1); }
                    50% { opacity:0.7; transform:scale(1.2); }
                }
                /* 두근두근 상자 떨림 애니메이션 */
                @keyframes boxDrumroll {
                    0%, 100% { transform:rotate(0deg) scale(1); }
                    10% { transform:rotate(-8deg) scale(1.05); }
                    20% { transform:rotate(8deg) scale(1.05); }
                    30% { transform:rotate(-8deg) scale(1.08); }
                    40% { transform:rotate(8deg) scale(1.08); }
                    50% { transform:rotate(-10deg) scale(1.1); }
                    60% { transform:rotate(10deg) scale(1.1); }
                    70% { transform:rotate(-12deg) scale(1.12); }
                    80% { transform:rotate(12deg) scale(1.12); }
                    90% { transform:rotate(-5deg) scale(1.15); }
                }
                @keyframes boxExplode {
                    0% { transform:scale(1.15); }
                    30% { transform:scale(1.5) rotate(10deg); opacity:1; }
                    100% { transform:scale(2) rotate(0deg); opacity:0; }
                }
                @keyframes starBurst {
                    0% { transform:scale(0) rotate(-180deg); opacity:0; }
                    60% { transform:scale(1.3) rotate(10deg); opacity:1; }
                    80% { transform:scale(0.9) rotate(-5deg); }
                    100% { transform:scale(1) rotate(0deg); opacity:1; }
                }
                @keyframes countPulse {
                    0% { transform:scale(1); opacity:1; }
                    50% { transform:scale(1.3); }
                    100% { transform:scale(1); opacity:0; }
                }
                @keyframes starGlow {
                    0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.5), 0 0 40px rgba(255,165,0,0.3); }
                    50% { box-shadow: 0 0 30px rgba(255,215,0,0.8), 0 0 60px rgba(255,165,0,0.5), 0 0 80px rgba(255,215,0,0.3); }
                }
                @keyframes confettiExplode {
                    0% { transform:translate(0,0) scale(0); opacity:1; }
                    100% { transform:translate(var(--tx), var(--ty)) scale(1); opacity:0; }
                }
                @keyframes numberCountUp {
                    0% { transform:translateY(20px); opacity:0; }
                    100% { transform:translateY(0); opacity:1; }
                }
                #star-box-icon:hover { transform:scale(1.1) rotate(-5deg); }
                #star-box-icon.drumroll { animation:boxDrumroll 2s ease-in-out forwards; cursor:default; }
                #star-box-icon.exploding { animation:boxExplode 0.5s ease-out forwards; }
                #star-reward-result.showing { animation:starBurst 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
                #star-count.glowing { animation:starGlow 1s ease-in-out infinite; border-radius:12px; }
                .countdown-number {
                    position:absolute; font-size:80px; font-weight:900; color:#FFD700;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 40px rgba(255,215,0,0.5);
                    animation: countPulse 0.7s ease-out forwards;
                    z-index:10;
                }
                .confetti-particle {
                    position:absolute; width:10px; height:10px; border-radius:50%;
                    animation: confettiExplode 1s ease-out forwards;
                }
            </style>

            <!-- Recommendations Section -->
            <section class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">✨</span>
                        <h3 class="font-noto text-xl text-gray-800">추천 도서</h3>
                        <span class="text-xs bg-brand-primary/10 text-brand-primary px-2 py-0.5 rounded-full">맞춤 추천</span>
                    </div>
                    <button onclick="window.location.href='library.html'" class="text-sm text-brand-primary font-medium hover:underline">더보기 →</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Recommended Book 1 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_02.png" alt="추천도서" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/60 text-sm font-bold tracking-widest">BOOK</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <h4 class="font-bold text-gray-800 mb-1 truncate">숲속 친구들</h4>
                                <div class="fav-heart-sm" onclick="event.stopPropagation(); toggleFavHome(this, 'rec-1', '숲속 친구들', '자연/동물', 'from-emerald-400 to-teal-500')">
                                    <i class="fa-regular fa-heart"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">동물 친구들의 우정 이야기</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-emerald-100 text-emerald-600 rounded-full font-bold">K1-1</span>
                                <span class="text-xs text-gray-400">자연/동물</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Book 2 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-violet-400 to-purple-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_03.png" alt="추천도서" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/60 text-sm font-bold tracking-widest">BOOK</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <h4 class="font-bold text-gray-800 mb-1 truncate">우주 탐험대</h4>
                                <div class="fav-heart-sm" onclick="event.stopPropagation(); toggleFavHome(this, 'rec-2', '우주 탐험대', '과학/모험', 'from-violet-400 to-purple-500')">
                                    <i class="fa-regular fa-heart"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">신비로운 우주 여행 모험</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-violet-100 text-violet-600 rounded-full font-bold">K2-1</span>
                                <span class="text-xs text-gray-400">과학/모험</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Book 3 -->
                    <div class="book-card bg-white rounded-2xl p-4 shadow-soft border border-gray-100 flex gap-4 cursor-pointer hover:shadow-lg transition-all">
                        <div class="w-20 h-28 bg-gradient-to-br from-rose-400 to-pink-500 rounded-xl shadow-md flex-shrink-0 overflow-hidden relative flex items-center justify-center">
                            <img src="../images/thumbnails/book_04.png" alt="추천도서" class="absolute inset-0 w-full h-full object-cover" onerror="this.style.display='none';">
                            <span class="text-white/60 text-sm font-bold tracking-widest">BOOK</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <h4 class="font-bold text-gray-800 mb-1 truncate">공주와 용</h4>
                                <div class="fav-heart-sm" onclick="event.stopPropagation(); toggleFavHome(this, 'rec-3', '공주와 용', '판타지', 'from-rose-400 to-pink-500')">
                                    <i class="fa-regular fa-heart"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 line-clamp-2">용감한 공주의 이야기</p>
                            <div class="flex items-center gap-2">
                                <span class="level-badge bg-rose-100 text-rose-600 rounded-full font-bold">K1-1</span>
                                <span class="text-xs text-gray-400">판타지</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

                      </div>
        </main>
    </div>

    <!-- 또또 캐릭터 팝업 (우측 하단, 큰 캐릭터) -->
    <div id="ttotto-popup" class="hidden" onclick="hideTtottoPopup()" style="position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.25);display:none;align-items:flex-end;justify-content:flex-end;padding:24px;">
        <div class="ttotto-container" onclick="event.stopPropagation()" style="position:relative;display:flex;flex-direction:column;align-items:center;animation:ttottoPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
            <!-- 말풍선 (캐릭터 위에 표시) -->
            <div class="ttotto-speech" style="position:relative;background:white;border-radius:24px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);max-width:260px;margin-bottom:16px;animation:speechFadeIn 0.4s ease 0.2s both;">
                <!-- 말풍선 꼬리 (아래 방향) -->
                <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:14px solid white;"></div>
                <p style="font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:600;color:#374151;line-height:1.6;margin:0;text-align:center;">안녕, 반가워!<br>코어북을 먼저 읽어보자!</p>
            </div>
            <!-- 또또 캐릭터 (화면 35% 크기) -->
            <div class="ttotto-character" style="width:35vh;height:35vh;min-width:200px;min-height:200px;max-width:380px;max-height:380px;filter:drop-shadow(0 12px 36px rgba(0,0,0,0.25));animation:ttottoBounce 2s ease-in-out infinite;">
                <img src="../img/EHEH.png" alt="또또" style="width:100%;height:100%;object-fit:contain;" onerror="this.innerHTML='🐿️'">
            </div>
        </div>
    </div>
    <style>
        @keyframes ttottoPopIn {
            0% { opacity:0; transform:translateY(100px) scale(0.3); }
            60% { transform:translateY(-20px) scale(1.05); }
            100% { opacity:1; transform:translateY(0) scale(1); }
        }
        @keyframes ttottoBounce {
            0%, 100% { transform:translateY(0); }
            50% { transform:translateY(-12px); }
        }
        @keyframes speechFadeIn {
            0% { opacity:0; transform:translateY(10px); }
            100% { opacity:1; transform:translateY(0); }
        }
        #ttotto-popup.hidden { display:none !important; }
    </style>

    <!-- Logout Modal Container -->
    <div id="logout-modal-container"></div>

    <!-- Scripts -->
    <script src="../js/common.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
        // ===== 주차별 커리큘럼 데이터 =====
        const weeklyData = {
            1: {
                // 코어북/관리이북 (메인)
                core: {
                    type: 'core', bookType: '코어북',
                    book: { title: '오즈의 마법사', author: '바움', desc: '회오리바람에 날려간 도로시의 신비로운 모험 이야기', level: 'K2-1' },
                    excerpt: '쿵! 마침내 회오리바람이 멈추고 집이 땅에 떨어졌어요.\n도로시가 집 밖으로 나오자 지팡이를 든 할머니가 다가왔어요.\n"여기는 오즈의 나라란다. 넌 나쁜 마녀를 물리쳤어!"',
                    coverImg: '../img/book1.jpg',
                    steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 8
                },
                // 교과서 짝꿍책 (어휘챌린지 없음)
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '개구리와 두꺼비', author: '아놀드 로벨', desc: '국어 2-1 1단원 연계 · 친구 사이 우정 이야기', level: 'K2-1' },
                    excerpt: '두꺼비가 개구리네 집에 갔어요.\n"개구리야, 일어나! 봄이 왔어!"\n개구리는 침대에서 뒹굴뒹굴,\n"5월에 깨워줘..." 두꺼비는 달력을 찢기 시작했어요.',
                    coverImg: '../img/book1.jpg',
                    subject: '국어 2-1', unit: '1단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 6
                }
            },
            2: {
                core: {
                    type: 'managed', bookType: '관리이북',
                    book: { title: '약속은 즐거워', author: '박은경', desc: '약속과 규칙의 소중함을 배우는 생활 동화', level: 'K1-1' },
                    excerpt: '은지는 친구들과 함께 유치원에서 즐거운 하루를 보내요.\n"우리 모두 차례차례 줄을 서자!" 약속을 지키니까\n놀이시간이 더 즐거워졌어요.',
                    coverImg: '../img/book2.jpg',
                    steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                    currentBookPage: 1, totalPages: 8
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '강아지똥', author: '권정생', desc: '국어 2-1 2단원 연계 · 자연과 생명의 소중함', level: 'K2-1' },
                    excerpt: '길가에 떨어진 강아지똥이 슬피 울었어요.\n"나는 아무 쓸모 없는 더러운 똥이야..."\n그때 민들레 씨앗이 말했어요. "넌 소중해!"',
                    coverImg: '../img/book2.jpg',
                    subject: '국어 2-1', unit: '2단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 6
                }
            },
            3: {
                core: {
                    type: 'core', bookType: '코어북',
                    book: { title: '숭숭이와 나', author: '지윤경', desc: '특별한 친구와 함께 자라는 우정 이야기', level: 'K3-1' },
                    excerpt: '숭숭이는 나만 알아보는 특별한 친구예요.\n오늘도 숭숭이와 나란히 걸으며 이야기를 나눴어요.\n"우리 내일도 같이 놀자!" 숭숭이가 고개를 끄덕였어요.',
                    coverImg: '../img/book3.jpg',
                    steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 8
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '나무를 심은 사람', author: '장 지오노', desc: '국어 2-1 3단원 연계 · 자연 사랑의 이야기', level: 'K2-1' },
                    excerpt: '황량한 산에 홀로 사는 노인이 있었어요.\n매일 백 개의 도토리를 심었지요.\n30년이 지나자, 숲이 되어 새들이 노래했어요.',
                    coverImg: '../img/book3.jpg',
                    subject: '국어 2-1', unit: '3단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 6
                }
            },
            4: {
                core: {
                    type: 'managed', bookType: '관리이북',
                    book: { title: '빨간머리 앤', author: '몽고메리', desc: '상상력 넘치는 소녀 앤의 초록 지붕 집 이야기', level: 'K5' },
                    excerpt: '매슈 아저씨가 데려온 건 남자아이가 아니라 빨간 머리 소녀였어요!\n"저를 앤이라고 불러주세요. e가 붙은 Anne요!"\n앤은 초록 지붕 집에서 새로운 가족과 생활을 시작했어요.',
                    coverImg: '../img/book4.jpg',
                    steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                    currentBookPage: 1, totalPages: 8
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '별을 헤아리며', author: '윤동주', desc: '국어 2-1 4단원 연계 · 시와 감성의 세계', level: 'K2-1' },
                    excerpt: '계절이 지나가는 하늘에는\n가을로 가득 차 있습니다.\n나는 아무 걱정도 없이\n가을 속의 별들을 다 헤일 듯합니다.',
                    coverImg: '../img/book4.jpg',
                    subject: '국어 2-1', unit: '4단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 6
                }
            }
        };

        let currentWeek = 1;
        let currentPage = 0;
        let currentBookType = 'core'; // 'core' or 'textbook'

        // ===== 현재 선택된 책 데이터 가져오기 =====
        function getCurrentBookData() {
            return weeklyData[currentWeek][currentBookType];
        }

        // ===== Book Type Switching =====
        function switchBookType(bookType) {
            if (currentBookType === bookType) return;

            // 교과서 짝꿍책은 항상 선택 가능 (단, 읽기 버튼만 잠금)
            currentBookType = bookType;
            currentPage = 0;

            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.book-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.bookType === bookType);
            });

            // 배경색 변경 (코어북: 주황, 교과서짝꿍책: 초록)
            const carouselWrapper = document.getElementById('carousel-wrapper');
            if (bookType === 'textbook') {
                carouselWrapper.style.background = '#F0FDF4'; // 연한 초록
            } else {
                carouselWrapper.style.background = '#FFF8F0'; // 연한 주황
            }

            // 프로그래스바 즉시 리셋 (전환 효과 제거 후 0%로)
            const gauge = document.getElementById('step-gauge');
            gauge.classList.add('instant-reset');
            gauge.style.width = '0%';

            // 다음 프레임에서 전환 효과 복원 후 새 진행률 적용
            requestAnimationFrame(() => {
                setTimeout(() => {
                    gauge.classList.remove('instant-reset');
                    // 책 정보 업데이트
                    updateBookDisplay();
                    updateLearningProgress();
                }, 50);
            });
        }

        function updateBookTypeTabs() {
            const coreData = weeklyData[currentWeek].core;
            const textbookData = weeklyData[currentWeek].textbook;

            // 탭 제목 업데이트
            document.getElementById('core-book-title').textContent = coreData.book.title;
            document.getElementById('textbook-book-title').textContent = textbookData.subject + ' 연계';

            // 탭 라벨 업데이트 (코어북 vs 관리이북)
            const coreTab = document.querySelector('.book-type-tab.core');
            coreTab.querySelector('.tab-label').textContent = coreData.bookType;

            // 활성화 상태 업데이트
            document.querySelectorAll('.book-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.bookType === currentBookType);
            });

            // 교과서 짝꿍책 탭은 항상 활성화 (읽기 버튼만 잠금 처리)
            const textbookTab = document.querySelector('.book-type-tab.textbook');
            textbookTab.style.opacity = '1';
            textbookTab.style.cursor = 'pointer';
            const lockIndicator = textbookTab.querySelector('.tab-lock');
            if (lockIndicator) lockIndicator.remove();

            // 진행 상태 배지 업데이트
            updateBookTypeBadges();
        }

        function updateBookTypeBadges() {
            const coreProgress = getWeekProgress(currentWeek + '_core') || {};
            const textbookProgress = getWeekProgress(currentWeek + '_textbook') || {};

            const coreBadge = document.getElementById('core-badge');
            const textbookBadge = document.getElementById('textbook-badge');

            // 코어북 배지
            if (coreProgress.allComplete) {
                coreBadge.innerHTML = '<i class="fa-solid fa-check"></i>';
                coreBadge.classList.remove('incomplete');
                coreBadge.style.display = 'flex';
            } else {
                coreBadge.innerHTML = '<i class="fa-solid fa-ellipsis"></i>';
                coreBadge.classList.add('incomplete');
                coreBadge.style.display = 'flex';
            }

            // 교과서 짝꿍책 배지
            if (textbookProgress.allComplete) {
                textbookBadge.innerHTML = '<i class="fa-solid fa-check"></i>';
                textbookBadge.classList.remove('incomplete');
                textbookBadge.style.display = 'flex';
            } else {
                textbookBadge.style.display = 'none';
            }
        }

        function updateBookDisplay() {
            const data = getCurrentBookData();

            // Book spread: cover image
            const coverImg = document.getElementById('book-cover-img');
            coverImg.style.display = 'block';
            coverImg.src = data.coverImg;
            coverImg.onerror = function() {
                // 이미지 로드 실패 시 그라디언트 배경으로 대체
                this.style.display = 'none';
                this.parentElement.style.background = data.type === 'textbook'
                    ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                    : 'linear-gradient(135deg, #FF9F43 0%, #f97316 100%)';
            };
            // 이미지 로드 성공 시 부모 배경 초기화
            coverImg.onload = function() {
                this.style.display = 'block';
                this.parentElement.style.background = '#2c1810';
            };

            // Book spread: info
            const typeBadge = document.getElementById('book-type-badge');
            if (data.type === 'textbook') {
                typeBadge.innerHTML = '<i class="fa-solid fa-book text-[9px]"></i> ' + data.subject + ' ' + data.unit;
                typeBadge.className = 'book-tag bg-green-50 text-green-600';
            } else {
                typeBadge.innerHTML = '<i class="fa-solid fa-bookmark text-[9px]"></i> ' + data.bookType;
                typeBadge.className = 'book-tag bg-orange-50 text-orange-500';
            }

            document.getElementById('main-book-level').textContent = data.book.level;
            document.getElementById('main-book-title').textContent = data.book.title;
            document.getElementById('main-book-desc').textContent = data.book.desc;
            document.getElementById('book-excerpt').innerHTML = data.excerpt.replace(/\n/g, '<br>');

            // Page indicator
            document.getElementById('book-pg-current').textContent = data.currentBookPage;
            document.getElementById('book-pg-total').textContent = data.totalPages;

            // Segment label for book step
            if (data.type === 'textbook') {
                document.getElementById('seg-book-label').textContent = '도서읽기';
            } else {
                document.getElementById('seg-book-label').textContent = data.bookType === '관리이북' ? '이북읽기' : '도서읽기';
            }

            // Show/hide retelling segment & page
            const retPage = document.getElementById('page-retelling');
            const retSeg = document.getElementById('seg-retelling');
            if (data.hasRetelling) {
                retPage.classList.remove('hidden');
                retSeg.classList.remove('hidden');
            } else {
                retPage.classList.add('hidden');
                retSeg.classList.add('hidden');
            }

            // Show/hide vocab segment & page (교과서 짝꿍책은 어휘챌린지 없음)
            const vocabPage = document.querySelector('.story-page[data-page="vocab"]');
            const vocabSeg = document.getElementById('seg-vocab');
            if (data.type === 'textbook') {
                // 교과서 짝꿍책: 어휘챌린지 숨김
                if (vocabPage) vocabPage.classList.add('hidden');
                if (vocabSeg) vocabSeg.classList.add('hidden');
            } else {
                // 코어북/관리이북: 어휘챌린지 표시
                if (vocabPage) vocabPage.classList.remove('hidden');
                if (vocabSeg) vocabSeg.classList.remove('hidden');
            }

            // 배경색 업데이트
            const carouselWrapper = document.getElementById('carousel-wrapper');
            if (data.type === 'textbook') {
                carouselWrapper.style.background = '#F0FDF4'; // 연한 초록
            } else {
                carouselWrapper.style.background = '#FFF8F0'; // 연한 주황
            }

            // Reset to first page
            goToPage(0);
        }

        // ===== Page Navigation =====
        function getTotalPages() { return getCurrentBookData().steps.length; }
        function getLastPageIndex() { return getTotalPages() - 1; }

        function goToPage(idx) {
            const total = getTotalPages();
            if (idx < 0 || idx >= total) return;
            currentPage = idx;

            // 모든 페이지 숨기고 현재 페이지만 표시
            const pages = document.querySelectorAll('.story-page');
            const steps = getCurrentBookData().steps;
            let visibleIdx = 0;
            pages.forEach(p => {
                const pageType = p.dataset.page;
                // hidden 클래스가 있는 페이지는 건너뜀
                if (p.classList.contains('hidden')) {
                    p.classList.remove('active-page');
                    return;
                }
                if (visibleIdx === idx) {
                    p.classList.add('active-page');
                } else {
                    p.classList.remove('active-page');
                }
                visibleIdx++;
            });

            updatePageIndicators();
            updatePageNavButtons();
        }

        function nextPage() { if (currentPage < getTotalPages() - 1) goToPage(currentPage + 1); }
        function prevPage() { if (currentPage > 0) goToPage(currentPage - 1); }

        function updatePageIndicators() {
            // 책 페이지 인디케이터는 selectWeek/updateLearningProgress에서 별도 관리
        }

        function updatePageNavButtons() {
            // 책 페이지의 화살표 버튼은 제거됨 - 다른 페이지(퀴즈 등)의 화살표는 자체 inline으로 동작
        }

        // ===== 주차별 sessionStorage 키 헬퍼 =====
        function getProgressKey(week) { return 'learningProgress_w' + (week || currentWeek); }
        function getBookKey(week) { return 'currentBook_w' + (week || currentWeek); }
        function getWeekProgress(week) { return JSON.parse(sessionStorage.getItem(getProgressKey(week)) || '{}'); }
        function getWeekBookData(week) { return JSON.parse(sessionStorage.getItem(getBookKey(week)) || '{}'); }
        function saveWeekProgress(data, week) { sessionStorage.setItem(getProgressKey(week), JSON.stringify(data)); }
        function saveWeekBookData(data, week) { sessionStorage.setItem(getBookKey(week), JSON.stringify(data)); }

        // ===== Book Viewer =====
        function openBookViewer() {
            const data = getCurrentBookData();
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: data.currentBookPage, totalPages: data.totalPages,
                week: currentWeek,
                bookType: currentBookType // 코어북/교과서짝꿍책 구분
            };
            // 주차별 + 책타입별 키에 저장
            saveWeekBookData(bookPayload, currentWeek + '_' + currentBookType);
            // book-viewer는 기존 'currentBook' 키를 읽으므로 호환용으로도 저장
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));

            // 페이지 넘김 애니메이션 후 이동
            const bookCard = document.getElementById('book-card');
            if (bookCard) {
                bookCard.classList.add('page-turning');
                setTimeout(() => { window.location.href = 'book-viewer.html'; }, 650);
            } else {
                window.location.href = 'book-viewer.html';
            }
        }

        // ===== 다시 읽기 =====
        function reReadBook() {
            const data = getCurrentBookData();
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: 1, totalPages: data.totalPages,
                week: currentWeek,
                bookType: currentBookType,
                reReading: true  // 다시 읽기 플래그 - 프로그래스바에 영향 없음
            };
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));
            window.location.href = 'book-viewer.html';
        }

        // ===== Week Navigation =====
        function prevWeek() { if (currentWeek > 1) selectWeek(currentWeek - 1); }
        function nextWeek() { if (currentWeek < 4) selectWeek(currentWeek + 1); }

        function selectWeek(week) {
            currentWeek = week;
            currentPage = 0;
            currentBookType = 'core'; // 주차 변경 시 코어북으로 초기화

            // Week header - [K2-1] 1주차 형식 (1~4주차)
            const levelLabels = { 1: 'K2-1', 2: 'K2-1', 3: 'K2-1', 4: 'K2-1' };
            document.getElementById('week-label').innerHTML = '<span class="level-badge-inline">' + levelLabels[week] + '</span> ' + week + '주차';

            // 책 타입 탭 업데이트
            updateBookTypeTabs();

            // 책 정보 표시 업데이트
            updateBookDisplay();

            // 먼저 기본 페이지로 초기화
            currentPage = -1;
            goToPage(0);

            // 진행 상태 업데이트 (내부에서 autoFocusNextStep이 다음 단계로 이동)
            updateLearningProgress();
        }

        // ===== Step Progress Gauge =====
        function updateStepGauge() {
            const progressKey = currentWeek + '_' + currentBookType;
            const progress = getWeekProgress(progressKey);
            const bookData = getWeekBookData(progressKey);
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const data = getCurrentBookData();
            const gauge = document.getElementById('step-gauge');
            const steps = data.steps;
            const segmentWidth = 100 / steps.length;

            const bookDone = bookData.completed === true || (sharedBook.week === currentWeek && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;

            // 독서 읽기 진행률: 현재 페이지 / 전체 페이지
            const readPct = bookDone ? 100 : ((data.currentBookPage / data.totalPages) * 100);

            // 각 단계별 완료 여부 → 세그먼트 수로 환산
            let filledSegments = 0;
            let partialFill = 0;

            // 1단계: 도서읽기
            if (bookDone) {
                filledSegments = 1;
                // 2단계: 독후퀴즈
                if (quizDone) {
                    filledSegments = 2;
                    // 교과서 짝꿍책은 퀴즈까지만
                    if (data.type !== 'textbook') {
                        // 3단계: 리텔링 (있을 경우)
                        if (data.hasRetelling) {
                            if (retellDone) {
                                filledSegments = 3;
                                if (vocabDone) filledSegments = 4;
                            }
                        } else {
                            if (vocabDone) filledSegments = 3;
                        }
                    }
                }
            } else {
                // 도서 읽기 진행 중 → 부분 채움
                partialFill = (readPct / 100) * segmentWidth;
            }

            const totalWidth = bookDone
                ? (filledSegments * segmentWidth)
                : partialFill;

            gauge.style.width = Math.min(totalWidth, 100) + '%';

            // 책 타입별 게이지 색상 적용
            gauge.classList.toggle('textbook-gauge', data.type === 'textbook');

            // 전체 완료 시 녹색 (교과서 짝꿍책은 퀴즈까지만)
            const allDone = data.type === 'textbook'
                ? (bookDone && quizDone)
                : (vocabDone && quizDone && bookDone && (!data.hasRetelling || retellDone));
            gauge.classList.toggle('full-complete', allDone);

            // 게이지 위치 기반 텍스트 색상 업데이트
            updateSegmentColors();
        }

        function updateSegmentColors() {
            const bar = document.getElementById('step-progress-bar');
            const gauge = document.getElementById('step-gauge');
            if (!bar || !gauge) return;
            const barRect = bar.getBoundingClientRect();
            const gaugeRight = barRect.left + (bar.offsetWidth * parseFloat(gauge.style.width || '0') / 100);

            bar.querySelectorAll('.step-segment').forEach(seg => {
                if (seg.classList.contains('hidden')) return;
                const segRect = seg.getBoundingClientRect();
                // 세그먼트 중앙이 게이지 안에 있으면 흰색
                const segCenter = segRect.left + segRect.width / 2;
                seg.classList.toggle('gauge-covered', segCenter <= gaugeRight);
            });
        }

        // 게이지 트랜지션 완료 후 세그먼트 색상 재계산
        document.addEventListener('DOMContentLoaded', () => {
            const gauge = document.getElementById('step-gauge');
            if (gauge) gauge.addEventListener('transitionend', updateSegmentColors);
        });

        // ===== Learning Progress =====
        function updateLearningProgress() {
            const progressKey = currentWeek + '_' + currentBookType;
            const progress = getWeekProgress(progressKey);
            const bookData = getWeekBookData(progressKey);
            const data = getCurrentBookData();

            // 뷰어에서 돌아온 경우: 공용 키에서 주차별+책타입별 키로 마이그레이션
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const sharedBookMatch = sharedBook.week === currentWeek && sharedBook.bookType === currentBookType;
            if (sharedBookMatch && sharedBook.currentBookPage) {
                data.currentBookPage = sharedBook.currentBookPage;
                // 주차+책타입별 키에 동기화 저장
                saveWeekBookData(sharedBook, progressKey);
            } else if (bookData.currentBookPage) {
                data.currentBookPage = bookData.currentBookPage;
            }

            const bookDone = bookData.completed === true || (sharedBookMatch && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;
            const weekDone = progress.weekCompleted === true;

            // Step segments
            setSegState('seg-book', bookDone, !bookDone);
            setSegState('seg-quiz', quizDone, bookDone && !quizDone);

            // 교과서 짝꿍책은 어휘챌린지 없음
            if (data.type !== 'textbook') {
                if (data.hasRetelling) {
                    setSegState('seg-retelling', retellDone, quizDone && !retellDone);
                    setSegState('seg-vocab', vocabDone, retellDone && !vocabDone);
                } else {
                    setSegState('seg-vocab', vocabDone, quizDone && !vocabDone);
                }
            }

            // Lock/unlock cards
            setCardLock('quiz-card', !bookDone);
            if (data.type !== 'textbook') {
                if (data.hasRetelling) {
                    setCardLock('retelling-card', !quizDone);
                    setCardLock('vocab-card', !retellDone);
                } else {
                    setCardLock('vocab-card', !quizDone);
                }
            }

            // 완료 도장 표시 (교과서 짝꿍책은 어휘챌린지 없음)
            updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, data.hasRetelling, data.type === 'textbook');

            // Book CTA button
            const btn = document.getElementById('main-action-btn');
            const actionTxt = document.getElementById('main-action-text');
            const rereadBtn = document.getElementById('reread-btn');

            // 표지 & 책정보 & 페이지 영역 클릭 핸들러 참조
            const coverEl = document.getElementById('spread-cover');
            const pgArea = document.getElementById('book-pg-area');
            const infoTop = document.getElementById('book-info-top');

            // 교과서 짝꿍책인 경우 코어북 완료 체크
            let textbookReadingLocked = false;
            if (data.type === 'textbook') {
                const coreProgress = getWeekProgress(currentWeek + '_core') || {};
                const coreBookData = getWeekBookData(currentWeek + '_core') || {};
                const coreData = weeklyData[currentWeek].core;
                const coreBookDone = coreBookData.completed === true;
                const coreQuizDone = coreProgress.quizCompleted === true;
                const coreVocabDone = coreProgress.vocabCompleted === true;
                const coreRetellDone = !coreData.hasRetelling || coreProgress.retellingCompleted === true;
                textbookReadingLocked = !(coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone);
            }

            if (bookDone) {
                btn.className = 'cta-btn bg-[#1dd1a1] text-white shadow-md opacity-80';
                btn.querySelector('i').className = 'fa-solid fa-check';
                actionTxt.textContent = '독서 완료';
                btn.onclick = null;
                document.getElementById('book-pg-current').textContent = data.totalPages;
                // 다시 읽기 버튼 표시
                if (rereadBtn) rereadBtn.classList.remove('hidden');
                // 표지 & 책정보 & 페이지 영역 클릭 비활성화
                if (coverEl) { coverEl.onclick = null; coverEl.style.cursor = 'default'; }
                if (infoTop) { infoTop.onclick = null; infoTop.style.cursor = 'default'; }
                if (pgArea) { pgArea.onclick = null; pgArea.style.cursor = 'default'; }
            } else if (textbookReadingLocked) {
                // 교과서 짝꿍책 - 코어북 미완료 시 읽기 버튼만 잠금
                btn.className = 'cta-btn bg-gray-300 text-gray-500 shadow-md cursor-not-allowed';
                btn.querySelector('i').className = 'fa-solid fa-lock';
                actionTxt.textContent = '코어북 완료 후 읽기';
                btn.onclick = function() { alert('코어북 학습을 먼저 완료해주세요!'); };
                document.getElementById('book-pg-current').textContent = '1';
                // 다시 읽기 버튼 숨김
                if (rereadBtn) rereadBtn.classList.add('hidden');
                // 표지 & 책정보는 보이게 하되 클릭 시 알림
                if (coverEl) { coverEl.onclick = function() { alert('코어북 학습을 먼저 완료해주세요!'); }; coverEl.style.cursor = 'not-allowed'; }
                if (infoTop) { infoTop.onclick = null; infoTop.style.cursor = 'default'; }
                if (pgArea) { pgArea.onclick = null; pgArea.style.cursor = 'default'; }
            } else {
                btn.className = 'cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md';
                btn.querySelector('i').className = 'fa-solid fa-book-open';
                actionTxt.textContent = data.currentBookPage > 1 ? '계속 읽기' : '읽기 시작';
                btn.onclick = openBookViewer;
                document.getElementById('book-pg-current').textContent = data.currentBookPage;
                // 다시 읽기 버튼 숨김
                if (rereadBtn) rereadBtn.classList.add('hidden');
                // 표지 & 책정보 & 페이지 영역 클릭 활성화
                if (coverEl) { coverEl.onclick = openBookViewer; coverEl.style.cursor = 'pointer'; }
                if (infoTop) { infoTop.onclick = openBookViewer; infoTop.style.cursor = 'pointer'; }
                if (pgArea) { pgArea.onclick = openBookViewer; pgArea.style.cursor = 'pointer'; }
            }

            // Step gauge
            updateStepGauge();

            // 탭 상태 업데이트 (잠금 표시 등)
            updateBookTypeTabs();

            // 현재 책 타입의 모든 단계 완료 체크
            const allStepsDone = bookDone && quizDone && (!data.hasRetelling || retellDone) && (data.type === 'textbook' || vocabDone);

            // allComplete 상태 저장
            if (allStepsDone) {
                const progress = getWeekProgress(currentWeek + '_' + currentBookType) || {};
                progress.allComplete = true;
                saveWeekProgress(progress, currentWeek + '_' + currentBookType);
            }

            // Completion - 개별 책 완료 표시
            if (allStepsDone && currentBookType === 'core') {
                // 코어북 완료 시 교과서 짝꿍책으로 자동 전환
                checkAutoSwitchToTextbook();
            }

            // 완료 상태 처리 (별상자는 ⭐ 버튼 클릭으로만 표시)
            if (weekDone) { showCompletedState(); } else { hideCompletedState(); }

            // 자동 포커싱: 완료된 단계 다음으로 이동
            autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data);
        }

        // ===== 완료 도장 표시 =====
        function updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, hasRetelling, isTextbook = false) {
            // 도서 읽기 완료 도장
            applyStamp('book-card', bookDone, '독서 완료!');
            applyStamp('quiz-card', quizDone, '퀴즈 완료!');
            if (hasRetelling) applyStamp('retelling-card', retellDone, '리텔링 완료!');
            // 교과서 짝꿍책은 어휘챌린지 없음
            if (!isTextbook) applyStamp('vocab-card', vocabDone, '챌린지 완료!');
        }

        function applyStamp(cardId, isDone, label) {
            const card = document.getElementById(cardId);
            if (!card) return;
            let stamp = card.querySelector('.completion-stamp');
            if (isDone) {
                if (!stamp) {
                    stamp = document.createElement('div');
                    stamp.className = 'completion-stamp';
                    stamp.innerHTML = '<i class="fa-solid fa-circle-check"></i> ' + label;
                    card.style.position = 'relative';
                    card.appendChild(stamp);
                }
                stamp.style.display = '';
            } else {
                if (stamp) stamp.style.display = 'none';
            }
        }

        // ===== 자동 포커싱: 다음 미완료 단계로 이동 =====
        function autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data) {
            // 주차 전환 시에만 자동 포커싱 (첫 로드 시)
            if (!bookDone) {
                // 독서 미완료 → 도서읽기 페이지 (기본값이므로 별도 처리 불필요)
                return;
            }
            // 독서 완료 → 퀴즈 미완료면 퀴즈로 포커싱
            if (bookDone && !quizDone) {
                goToPage(1);
                return;
            }
            // 퀴즈 완료
            if (quizDone) {
                if (data.hasRetelling && !retellDone) {
                    goToPage(2); // 리텔링으로
                    return;
                }
                if (!data.hasRetelling && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab')); // 어휘챌린지로
                    return;
                }
                if (data.hasRetelling && retellDone && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab'));
                    return;
                }
            }
        }

        function setSegState(id, isDone, isActive) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active', 'completed', 'locked');
            const lockIcon = el.querySelector('.seg-lock');
            if (isDone) {
                el.classList.add('completed');
                if (lockIcon) lockIcon.style.display = 'none';
            } else if (isActive) {
                el.classList.add('active');
                if (lockIcon) lockIcon.style.display = 'none';
            } else {
                el.classList.add('locked');
                if (lockIcon) lockIcon.style.display = '';
            }
        }

        function setCardLock(cardId, isLocked) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.toggle('unlocked', !isLocked);
        }

        // ===== Completion =====
        function showCompletedState() {
            document.getElementById('story-active').classList.add('hidden');
            document.getElementById('story-completed').classList.remove('hidden');

            const data = getCurrentBookData();
            document.getElementById('completed-book-title').textContent = data.book.title + ' - 학습 완료!';

            setSegState('seg-book', true, false);
            setSegState('seg-quiz', true, false);
            if (data.hasRetelling) setSegState('seg-retelling', true, false);
            setSegState('seg-vocab', true, false);

            // Gauge full
            document.getElementById('step-gauge').style.width = '100%';
            document.getElementById('step-gauge').classList.add('full-complete');
        }

        function hideCompletedState() {
            document.getElementById('story-active').classList.remove('hidden');
            document.getElementById('story-completed').classList.add('hidden');
        }

        function loadNextBook() {
            // 주차별 진행 상태는 유지 (독립적이므로 삭제하지 않음)
            if (currentWeek < 4) { selectWeek(currentWeek + 1); }
            else { alert('이번 달 모든 학습을 완료했어요! 다음 달 커리큘럼을 기대해주세요!'); selectWeek(1); }
        }

        // ===== Star Reward Modal =====
        let starRewardOpened = false;
        let earnedStars = 0;

        function showStarRewardModal() {
            const modal = document.getElementById('star-reward-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            starRewardOpened = false;

            // 초기화
            const boxIcon = document.getElementById('star-box-icon');
            boxIcon.textContent = '🎁';
            boxIcon.classList.remove('drumroll', 'exploding');
            boxIcon.style.display = 'block';
            boxIcon.style.cursor = 'pointer';
            boxIcon.style.transform = '';

            const result = document.getElementById('star-reward-result');
            result.classList.add('hidden');
            result.classList.remove('showing');

            const starCount = document.getElementById('star-count');
            starCount.classList.remove('glowing');
            starCount.textContent = '+0';

            document.getElementById('star-reward-close-btn').classList.add('hidden');
        }

        function openStarBox() {
            if (starRewardOpened) return;
            starRewardOpened = true;

            const boxIcon = document.getElementById('star-box-icon');
            const modalContent = boxIcon.closest('.star-reward-content');

            // 1단계: 두근두근 드럼롤 애니메이션 시작
            boxIcon.classList.add('drumroll');
            boxIcon.style.cursor = 'default';

            // 카운트다운 표시 (3, 2, 1)
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                if (countdown > 0) {
                    showCountdown(modalContent, countdown);
                    countdown--;
                }
            }, 700);

            // 2단계: 드럼롤 후 상자 폭발
            setTimeout(() => {
                clearInterval(countdownInterval);

                // 랜덤 별 보상 (10~50개로 더 풍성하게)
                earnedStars = Math.floor(Math.random() * 41) + 10;

                // 상자 폭발 애니메이션
                boxIcon.classList.remove('drumroll');
                boxIcon.classList.add('exploding');

                // 폭죽 효과
                createConfetti(modalContent);

                // 3단계: 별 결과 표시
                setTimeout(() => {
                    boxIcon.style.display = 'none';

                    const result = document.getElementById('star-reward-result');
                    const starCount = document.getElementById('star-count');

                    // 숫자 카운트업 효과
                    starCount.textContent = '+0';
                    result.classList.remove('hidden');
                    result.classList.add('showing');

                    // 숫자가 올라가는 애니메이션
                    setTimeout(() => {
                        animateStarCount(starCount, earnedStars);
                        starCount.classList.add('glowing');
                    }, 500);

                    // 확인 버튼 표시
                    setTimeout(() => {
                        document.getElementById('star-reward-close-btn').classList.remove('hidden');

                        // 별 카운트 업데이트 (현재 표시된 별에 추가)
                        const starDisplay = document.querySelector('.bg-amber-50 .font-bold.text-amber-600');
                        if (starDisplay) {
                            const currentStars = parseInt(starDisplay.textContent) || 0;
                            starDisplay.textContent = currentStars + earnedStars;
                        }
                    }, 1500);
                }, 500);
            }, 2100);
        }

        // 카운트다운 숫자 표시
        function showCountdown(container, num) {
            const countEl = document.createElement('div');
            countEl.className = 'countdown-number';
            countEl.textContent = num;
            countEl.style.left = '50%';
            countEl.style.top = '30%';
            countEl.style.transform = 'translate(-50%, -50%)';
            container.appendChild(countEl);

            setTimeout(() => countEl.remove(), 700);
        }

        // 폭죽 효과 생성
        function createConfetti(container) {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96E6A1', '#DDA0DD', '#F7DC6F'];
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti-particle';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = '50%';
                particle.style.top = '35%';
                particle.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px');
                particle.style.setProperty('--ty', (Math.random() - 0.5) * 200 + 'px');
                particle.style.animationDelay = Math.random() * 0.2 + 's';
                container.appendChild(particle);

                setTimeout(() => particle.remove(), 1200);
            }
        }

        // 별 개수 카운트업 애니메이션
        function animateStarCount(element, target) {
            let current = 0;
            const duration = 1000;
            const stepTime = duration / target;
            const minStep = 30;
            const actualStepTime = Math.max(stepTime, minStep);
            const increment = Math.ceil(target / (duration / actualStepTime));

            const counter = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(counter);
                }
                element.textContent = '+' + current;
            }, actualStepTime);
        }

        function closeStarRewardModal() {
            const modal = document.getElementById('star-reward-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';

            // 다음 주로 이동
            loadNextBook();
        }

        // 교과서 짝꿍책 독후퀴즈 완료 시 별상자 표시 체크
        function checkWeekAllComplete() {
            // 교과서 짝꿍책 퀴즈 완료 플래그 확인
            const textbookQuizJustCompleted = sessionStorage.getItem('textbookQuizJustCompleted') === 'true';
            const completedWeek = parseInt(sessionStorage.getItem('textbookQuizCompletedWeek') || '0');

            // 플래그가 있고 현재 주차와 일치하면 별상자 표시
            if (textbookQuizJustCompleted && completedWeek === currentWeek) {
                // 플래그 제거 (한 번만 표시)
                sessionStorage.removeItem('textbookQuizJustCompleted');
                sessionStorage.removeItem('textbookQuizCompletedWeek');

                // 이미 보상 받았는지 체크 (localStorage 사용 - 영구 저장)
                const rewardKey = 'starReward_week_' + currentWeek;
                if (!localStorage.getItem(rewardKey)) {
                    localStorage.setItem(rewardKey, 'claimed');
                    // 교과서 짝꿍책 탭으로 전환 후 별상자 표시
                    if (currentBookType !== 'textbook') {
                        switchBookType('textbook');
                    }
                    setTimeout(() => {
                        showStarRewardModal();
                    }, 300);
                    return true;
                }
            }
            return false;
        }

        // 코어북 완료 시 교과서 짝꿍책으로 자동 전환
        function checkAutoSwitchToTextbook() {
            const coreProgress = getWeekProgress(currentWeek + '_core') || {};
            const coreBookData = getWeekBookData(currentWeek + '_core') || {};
            const coreData = weeklyData[currentWeek].core;

            const coreBookDone = coreBookData.completed === true;
            const coreQuizDone = coreProgress.quizCompleted === true;
            const coreVocabDone = coreProgress.vocabCompleted === true;
            const coreRetellDone = !coreData.hasRetelling || coreProgress.retellingCompleted === true;
            const coreAllDone = coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone;

            // 코어북 완료 && 현재 코어북 선택 중 && 교과서 짝꿍책 미완료 시 자동 전환
            if (coreAllDone && currentBookType === 'core') {
                const textbookProgress = getWeekProgress(currentWeek + '_textbook') || {};
                const textbookBookData = getWeekBookData(currentWeek + '_textbook') || {};
                const textbookBookDone = textbookBookData.completed === true;
                const textbookQuizDone = textbookProgress.quizCompleted === true;
                const textbookAllDone = textbookBookDone && textbookQuizDone;

                if (!textbookAllDone) {
                    // 자동으로 교과서 짝꿍책으로 전환
                    setTimeout(() => {
                        switchBookType('textbook');
                    }, 500);
                }
            }
        }

        // ===== 찜하기 토글 (홈) =====
        function toggleFavHome(el, id, title, genre, bg) {
            const added = Favorites.toggle({ id, title, genre, bg });
            if (added) {
                el.classList.add('active');
                el.querySelector('i').className = 'fa-solid fa-heart';
            } else {
                el.classList.remove('active');
                el.querySelector('i').className = 'fa-regular fa-heart';
            }
        }

        function initFavHearts() {
            document.querySelectorAll('.fav-heart-sm').forEach(el => {
                const onclick = el.getAttribute('onclick') || '';
                const match = onclick.match(/toggleFavHome\(this,\s*'([^']+)'/);
                if (match && Favorites.isFavorite(match[1])) {
                    el.classList.add('active');
                    el.querySelector('i').className = 'fa-solid fa-heart';
                }
            });
        }

        // ===== 또또 캐릭터 팝업 =====
        function showTtottoPopup() {
            const popup = document.getElementById('ttotto-popup');
            popup.classList.remove('hidden');
            popup.style.display = 'flex';
        }

        function hideTtottoPopup() {
            const popup = document.getElementById('ttotto-popup');
            popup.classList.add('hidden');
            popup.style.display = 'none';
        }

        // ===== Init =====
        document.addEventListener('DOMContentLoaded', () => {
            // 최초 진입 시 공유 키 정리 (stale completed 상태 방지)
            // book-viewer에서 돌아온 경우가 아니면 공유 키 삭제
            const referrer = document.referrer || '';
            if (!referrer.includes('book-viewer')) {
                sessionStorage.removeItem('currentBook');
            }
            loadSidebar('home');
            loadLogoutModal();
            selectWeek(1);
            initFavHearts();
        });

        // ===== Touch Swipe =====
        (function() {
            let startX = 0, dragging = false;
            const carousel = document.querySelector('.story-carousel');
            if (!carousel) return;
            carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; dragging = true; }, { passive: true });
            carousel.addEventListener('touchend', e => {
                if (!dragging) return; dragging = false;
                const diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) { diff > 0 ? nextPage() : prevPage(); }
            }, { passive: true });
        })();
    </script>
</body>
</html>
