<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>북클럽 3.0 - 질문렌즈</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        },
                        lens: {
                            purple: '#8B5CF6',
                            purpleDark: '#6D28D9',
                            pink: '#EC4899',
                            blue: '#3B82F6',
                            green: '#10B981'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        body {
            background: linear-gradient(180deg, #F3E8FF 0%, #E9D5FF 50%, #DDD6FE 100%);
        }

        /* 채팅 버블 */
        .chat-bubble {
            animation: bubbleIn 0.4s ease-out;
        }
        @keyframes bubbleIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chat-bubble.buddy {
            background: white;
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #8B5CF6, #6D28D9);
            color: white;
            border-radius: 20px 20px 4px 20px;
        }

        /* 버디 아바타 */
        .buddy-avatar {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* 질문 카드 */
        .question-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .question-card:hover {
            transform: translateY(-6px) scale(1.02);
        }
        .question-card:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* 3D 버튼 */
        .btn-3d {
            transform: translateY(-4px);
            transition: all 0.1s ease;
        }
        .btn-3d:active {
            transform: translateY(0);
        }

        /* 타이핑 인디케이터 */
        .typing-indicator span {
            animation: typingBounce 1.4s ease-in-out infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* 선택된 카드 */
        .question-card.selected {
            border-color: #8B5CF6;
            background: linear-gradient(135deg, #F3E8FF, #E9D5FF);
            transform: scale(1.05);
        }

        /* 입력 영역 */
        .input-area {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 스크롤바 숨김 */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* 반짝임 효과 */
        .sparkle {
            animation: sparkle 2s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* 완료 애니메이션 */
        .complete-badge {
            animation: badgePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* 책 선택 버튼 */
        .book-select-btn {
            animation: fadeInUp 0.5s ease-out backwards;
        }
        .book-select-btn:nth-child(1) { animation-delay: 0.1s; }
        .book-select-btn:nth-child(2) { animation-delay: 0.2s; }
        .book-select-btn:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .book-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }
    </style>
</head>
<body class="font-sans text-gray-800 min-h-screen overflow-hidden flex flex-col">
    <!-- 상단 헤더 -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-purple-100 px-6 py-4">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 bg-purple-50 hover:bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </button>

            <div class="flex items-center gap-2 absolute left-1/2 -translate-x-1/2">
                <span class="text-2xl">🔍</span>
                <span class="font-noto text-lg text-purple-600">질문 렌즈</span>
            </div>

            <!-- 책 정보 (책 선택 후 표시) -->
            <div id="header-book-info" class="hidden items-center gap-2 bg-purple-50 px-3 py-1.5 rounded-full">
                <span class="text-sm">📖</span>
                <span id="header-book-title" class="text-xs text-purple-600 font-medium">마법사의 물약</span>
            </div>
            <!-- 책 정보가 없을 때 균형을 위한 placeholder -->
            <div id="header-placeholder" class="w-10 h-10"></div>
        </div>
    </header>

    <!-- 책 선택 화면 -->
    <div id="book-selection-screen" class="flex-1 flex flex-col items-center justify-center px-4 py-8">
        <div class="max-w-md w-full text-center">
            <!-- 버디 인사 -->
            <div class="buddy-avatar w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-5xl shadow-xl">
                🐿️
            </div>
            <h2 class="font-noto text-2xl text-purple-700 mb-2">안녕! 나는 버디야!</h2>
            <p class="text-gray-600 mb-8">우리 어떤 책으로 이야기할까?</p>

            <!-- 최근 읽은 책 리스트 -->
            <div class="space-y-3" id="book-list">
                <!-- 책 1 -->
                <button onclick="selectBook('magic-potion')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        🧙‍♂️
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">마법사의 물약</p>
                        <p class="text-xs text-gray-400">오늘 읽은 책</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>

                <!-- 책 2 -->
                <button onclick="selectBook('forest-friends')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        🌲
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">숲속 친구들</p>
                        <p class="text-xs text-gray-400">어제 읽은 책</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>

                <!-- 책 3 -->
                <button onclick="selectBook('princess-dragon')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-pink-400 to-rose-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        🐉
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">공주와 용</p>
                        <p class="text-xs text-gray-400">3일 전 읽은 책</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>
            </div>

            <p class="text-xs text-gray-400 mt-6">
                <i class="fa-solid fa-clock mr-1"></i>
                최근 읽은 순서로 보여드려요
            </p>
        </div>
    </div>

    <!-- 채팅 영역 (처음에 숨김) -->
    <main class="flex-1 overflow-y-auto hide-scrollbar px-4 py-6 hidden" id="chat-container">
        <div class="max-w-2xl mx-auto space-y-6" id="chat-messages">
            <!-- 메시지들이 여기에 동적으로 추가됨 -->
        </div>
    </main>

    <!-- 입력 영역 -->
    <footer class="bg-white/95 backdrop-blur-lg border-t border-purple-100 px-4 py-4" id="input-area">
        <div class="max-w-2xl mx-auto">
            <!-- 초기 상태: 시작 버튼 (책 선택 후 표시) -->
            <div id="start-section" class="hidden text-center">
                <button onclick="startConversation()" class="btn-3d px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #6D28D9, 0 8px 20px rgba(0,0,0,0.15);">
                    <i class="fa-solid fa-comments mr-2"></i> 대화 시작하기
                </button>
            </div>

            <!-- 질문 카드 선택 -->
            <div id="card-selection" class="hidden">
                <p class="text-center text-sm text-gray-500 mb-3">뭐가 궁금한지 하나만 골라봐!</p>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectQuestionCard('who')" class="question-card bg-gradient-to-br from-blue-50 to-indigo-50 border-3 border-blue-200 rounded-2xl p-4 text-center" data-card="who">
                        <span class="text-3xl mb-2 block">👤</span>
                        <span class="font-noto text-blue-600 text-sm">누구일까?</span>
                    </button>
                    <button onclick="selectQuestionCard('what')" class="question-card bg-gradient-to-br from-green-50 to-emerald-50 border-3 border-green-200 rounded-2xl p-4 text-center" data-card="what">
                        <span class="text-3xl mb-2 block">❓</span>
                        <span class="font-noto text-green-600 text-sm">무엇일까?</span>
                    </button>
                    <button onclick="selectQuestionCard('why')" class="question-card bg-gradient-to-br from-amber-50 to-orange-50 border-3 border-amber-200 rounded-2xl p-4 text-center" data-card="why">
                        <span class="text-3xl mb-2 block">🤔</span>
                        <span class="font-noto text-amber-600 text-sm">왜 그랬을까?</span>
                    </button>
                </div>
            </div>

            <!-- 텍스트 입력 -->
            <div id="text-input-section" class="hidden input-area">
                <div class="flex items-end gap-3">
                    <div class="flex-1 bg-purple-50 rounded-2xl p-3 border-2 border-purple-100 focus-within:border-purple-300 transition-colors">
                        <textarea id="user-input" placeholder="생각을 말해봐!" class="w-full bg-transparent outline-none resize-none text-gray-800" rows="2" oninput="autoResize(this)"></textarea>
                    </div>
                    <button onclick="sendMessage()" class="btn-3d w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl flex items-center justify-center" style="box-shadow: 0 4px 0 #6D28D9;">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">엔터를 눌러 전송하세요</p>
            </div>

            <!-- 다음 질문 버튼 -->
            <div id="next-question-section" class="hidden text-center">
                <button onclick="showNextQuestion()" class="btn-3d px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #6D28D9;">
                    다음 질문으로 <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- 완료 버튼 -->
            <div id="complete-section" class="hidden text-center">
                <button onclick="completeSession()" class="btn-3d px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #047857;">
                    <i class="fa-solid fa-check mr-2"></i> 질문 렌즈 완료!
                </button>
            </div>
        </div>
    </footer>

    <!-- 완료 모달 -->
    <div id="complete-modal" class="hidden fixed inset-0 z-[100] bg-gradient-to-br from-purple-500 via-pink-500 to-rose-500 flex items-center justify-center">
        <div class="text-center px-6">
            <div class="complete-badge w-40 h-40 mx-auto mb-6 bg-white rounded-full flex items-center justify-center shadow-2xl">
                <span class="text-7xl">🔍</span>
            </div>
            <h2 class="font-noto text-4xl text-white mb-2">질문 렌즈 완료!</h2>
            <p class="text-white/90 text-xl mb-8">책에 대해 더 깊이 생각했어요!</p>

            <div class="flex justify-center gap-4 mb-8">
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">⭐</span>
                    <span class="text-white font-noto">+25 별</span>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">💬</span>
                    <span class="text-white font-noto">질문 3개</span>
                </div>
            </div>

            <button onclick="goBack()" class="btn-3d px-10 py-4 bg-white text-purple-600 rounded-2xl font-noto text-lg" style="box-shadow: 0 6px 0 #DDD6FE;">
                돌아가기
            </button>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script>
        // 책 데이터
        const booksData = {
            'magic-potion': {
                title: '마법사의 물약',
                emoji: '🧙‍♂️',
                conversations: {
                    who: {
                        questions: [
                            { q: "숲속에서 마법사를 도와준 친구는 누구일까?", hint: "날개가 있고 노래를 잘 불러요" },
                            { q: "마법사가 가장 좋아하는 친구는 누구라고 생각해?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "마법사가 만든 물약의 색깔은 무엇이었을까?", hint: "무지개처럼 여러 색이에요" },
                            { q: "마법사의 집에서 가장 신기한 물건은 뭐였을까?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "마법사가 숲속으로 재료를 찾으러 간 이유는 뭘까?", hint: "특별한 물약을 만들고 싶었어요" },
                            { q: "숲속 동물들이 마법사를 도와준 이유가 뭐라고 생각해?", hint: "" }
                        ]
                    }
                }
            },
            'forest-friends': {
                title: '숲속 친구들',
                emoji: '🌲',
                conversations: {
                    who: {
                        questions: [
                            { q: "숲속에서 가장 용감한 친구는 누구였을까?", hint: "작지만 씩씩해요" },
                            { q: "다람쥐가 가장 좋아하는 친구는 누구라고 생각해?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "숲속 친구들이 함께 만든 건 무엇이었을까?", hint: "모두 함께 살 수 있는 곳이에요" },
                            { q: "친구들이 나눠 먹은 맛있는 음식은 뭐였을까?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "토끼가 숲속 친구들을 도와주려고 한 이유는 뭘까?", hint: "혼자보다 함께가 좋아서요" },
                            { q: "숲속 친구들이 서로 도우면서 산 이유가 뭐라고 생각해?", hint: "" }
                        ]
                    }
                }
            },
            'princess-dragon': {
                title: '공주와 용',
                emoji: '🐉',
                conversations: {
                    who: {
                        questions: [
                            { q: "공주를 구하러 온 사람은 누구였을까?", hint: "갑옷을 입고 있지 않았어요" },
                            { q: "용의 가장 친한 친구는 누구라고 생각해?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "용이 지키고 있던 보물은 무엇이었을까?", hint: "반짝반짝 빛나는 건 아니에요" },
                            { q: "공주가 용에게 준 선물은 뭐였을까?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "용이 무섭게 행동했던 이유는 뭘까?", hint: "사실은 외로웠어요" },
                            { q: "공주와 용이 친구가 된 이유가 뭐라고 생각해?", hint: "" }
                        ]
                    }
                }
            }
        };

        // 상태 관리
        let selectedBook = null;
        let conversationData = null;
        let currentCardType = null;
        let currentQuestionIndex = 0;
        let answeredQuestions = 0;
        const totalQuestions = 3;
        let cameFromBuddy = false; // AI 버디에서 진입했는지 여부

        // 책 선택
        function selectBook(bookId) {
            selectedBook = booksData[bookId];
            conversationData = selectedBook.conversations;

            // 헤더 책 정보 업데이트
            document.getElementById('header-book-title').textContent = selectedBook.title;
            document.getElementById('header-book-info').classList.remove('hidden');
            document.getElementById('header-book-info').classList.add('flex');
            document.getElementById('header-placeholder').classList.add('hidden');

            // 책 선택 화면 숨기기
            document.getElementById('book-selection-screen').classList.add('hidden');

            // 채팅 영역 표시
            document.getElementById('chat-container').classList.remove('hidden');

            // 바로 대화 시작
            startConversation();
        }

        // 대화 시작
        function startConversation() {
            // 버디 인트로 메시지
            addBuddyMessage(`${selectedBook.emoji} '${selectedBook.title}' 이야기 재미있었어?`);

            setTimeout(() => {
                addBuddyMessage("나랑 같이 이야기해볼래? 뭐가 궁금한지 골라봐!");
                showCardSelection();
            }, 1000);
        }

        // 버디 메시지 추가
        function addBuddyMessage(text, showTyping = true) {
            const container = document.getElementById('chat-messages');

            if (showTyping) {
                // 타이핑 인디케이터
                const typing = document.createElement('div');
                typing.className = 'flex items-end gap-3 mb-4';
                typing.id = 'typing-indicator';
                typing.innerHTML = `
                    <div class="buddy-avatar w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-2xl shadow-md flex-shrink-0">
                        🐿️
                    </div>
                    <div class="chat-bubble buddy px-4 py-3">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                container.appendChild(typing);
                scrollToBottom();

                setTimeout(() => {
                    typing.remove();
                    actuallyAddBuddyMessage(text);
                }, 600);
            } else {
                actuallyAddBuddyMessage(text);
            }
        }

        function actuallyAddBuddyMessage(text) {
            const container = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = 'flex items-end gap-3 mb-4';
            message.innerHTML = `
                <div class="buddy-avatar w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-2xl shadow-md flex-shrink-0">
                    🐿️
                </div>
                <div class="chat-bubble buddy px-5 py-4 max-w-[80%]">
                    <p class="text-gray-800">${text}</p>
                </div>
            `;
            container.appendChild(message);
            scrollToBottom();
        }

        // 사용자 메시지 추가
        function addUserMessage(text) {
            const container = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = 'flex items-end justify-end gap-3 mb-4';
            message.innerHTML = `
                <div class="chat-bubble user px-5 py-4 max-w-[80%]">
                    <p>${text}</p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-pink-400 rounded-full flex items-center justify-center text-lg shadow-md flex-shrink-0">
                    👦
                </div>
            `;
            container.appendChild(message);
            scrollToBottom();
        }

        // 카드 선택 표시
        function showCardSelection() {
            document.getElementById('card-selection').classList.remove('hidden');
            document.getElementById('text-input-section').classList.add('hidden');
            document.getElementById('next-question-section').classList.add('hidden');
        }

        // 질문 카드 선택
        function selectQuestionCard(cardType) {
            // 이전 선택 해제
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 현재 선택 표시
            document.querySelector(`[data-card="${cardType}"]`).classList.add('selected');

            currentCardType = cardType;
            currentQuestionIndex = 0;

            const cardNames = { who: '누구일까?', what: '무엇일까?', why: '왜 그랬을까?' };
            const cardEmojis = { who: '👤', what: '❓', why: '🤔' };

            setTimeout(() => {
                // 카드 선택 숨기기
                document.getElementById('card-selection').classList.add('hidden');

                // 사용자 선택 메시지
                addUserMessage(`${cardEmojis[cardType]} ${cardNames[cardType]}`);

                // 버디 응답
                setTimeout(() => {
                    addBuddyMessage("좋아! 그럼 질문할게!");
                }, 500);

                setTimeout(() => {
                    askQuestion();
                }, 1200);
            }, 300);
        }

        // 질문하기
        function askQuestion() {
            const questions = conversationData[currentCardType].questions;
            const question = questions[currentQuestionIndex];

            addBuddyMessage(question.q);

            if (question.hint) {
                setTimeout(() => {
                    addBuddyMessage(`💡 힌트: ${question.hint}`, false);
                }, 500);
            }

            // 입력 영역 표시
            setTimeout(() => {
                document.getElementById('text-input-section').classList.remove('hidden');
                document.getElementById('user-input').focus();
            }, 800);
        }

        // 메시지 전송
        function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();

            if (!text) return;

            // 사용자 메시지 추가
            addUserMessage(text);
            input.value = '';
            input.style.height = 'auto';

            // 입력 영역 숨기기
            document.getElementById('text-input-section').classList.add('hidden');

            // 버디 반응
            setTimeout(() => {
                const responses = [
                    "와! 정말 좋은 생각이야! 🌟",
                    "오~ 그렇게 생각했구나! 대단해! ✨",
                    "재미있는 대답이야! 👏",
                    "멋진 생각이야! 나도 그렇게 생각해! 💜"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addBuddyMessage(randomResponse);

                answeredQuestions++;

                setTimeout(() => {
                    currentQuestionIndex++;

                    if (currentQuestionIndex < conversationData[currentCardType].questions.length) {
                        // 다음 질문 버튼 표시
                        document.getElementById('next-question-section').classList.remove('hidden');
                    } else if (answeredQuestions < totalQuestions) {
                        // 다른 카드 선택 유도
                        addBuddyMessage("다른 것도 궁금하지 않아? 또 골라봐!");
                        showCardSelection();
                    } else {
                        // 완료
                        addBuddyMessage("와! 오늘 정말 많이 생각했어! 대단해! 🎉");
                        document.getElementById('complete-section').classList.remove('hidden');
                    }
                }, 800);
            }, 600);
        }

        // 다음 질문으로
        function showNextQuestion() {
            document.getElementById('next-question-section').classList.add('hidden');
            askQuestion();
        }

        // 세션 완료
        function completeSession() {
            document.getElementById('complete-modal').classList.remove('hidden');
        }

        // 스크롤 맨 아래로
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // 텍스트에어리어 자동 높이 조절
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // 엔터키 전송
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('user-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // AI 버디에서 책을 이미 선택하고 온 경우 → 책 선택 스킵
            const buddyBookRaw = sessionStorage.getItem('aiBuddyBook');
            const chatStateRaw = sessionStorage.getItem('aiBuddyChatState');

            // aiBuddyChatState가 있으면 AI 버디에서 온 것으로 간주
            if (chatStateRaw) {
                cameFromBuddy = true;
            }

            if (buddyBookRaw) {
                try {
                    const buddyBook = JSON.parse(buddyBookRaw);
                    // 버디 책 → 질문렌즈 매핑 (ID가 다르므로 기본 대화 세트 사용)
                    const defaultConversations = booksData['magic-potion'].conversations;
                    selectedBook = {
                        title: buddyBook.title,
                        emoji: buddyBook.emoji,
                        conversations: defaultConversations
                    };
                    conversationData = selectedBook.conversations;

                    // 헤더에 책 정보 표시
                    document.getElementById('header-book-title').textContent = selectedBook.title;
                    document.getElementById('header-book-info').classList.remove('hidden');
                    document.getElementById('header-book-info').classList.add('flex');
                    document.getElementById('header-placeholder').classList.add('hidden');

                    // 책 선택 화면 스킵 → 채팅 영역 바로 표시
                    document.getElementById('book-selection-screen').classList.add('hidden');
                    document.getElementById('chat-container').classList.remove('hidden');

                    // 버디 인사 (책 이미 선택된 상태)
                    addBuddyMessage(`${selectedBook.emoji} '${selectedBook.title}' 이야기 재미있었어?`);
                    setTimeout(() => {
                        addBuddyMessage("나랑 같이 이야기해볼래? 뭐가 궁금한지 하나만 골라봐!");
                        showCardSelection();
                    }, 1000);

                    // AI 버디에서 진입 플래그 설정
                    cameFromBuddy = true;
                    // 사용한 세션 데이터 제거
                    sessionStorage.removeItem('aiBuddyBook');
                } catch (e) {
                    // 파싱 실패 시 기본 책 선택 화면 유지
                }
            }
        });

        // 뒤로가기
        function goBack() {
            // 완료 모달이 열려있으면 닫기
            if (!document.getElementById('complete-modal').classList.contains('hidden')) {
                document.getElementById('complete-modal').classList.add('hidden');
                if (cameFromBuddy) {
                    window.location.href = 'ai-buddy.html';
                } else {
                    resetToBookSelection();
                }
                return;
            }

            // AI 버디에서 온 경우 → 버디 챗봇으로 돌아가기
            if (cameFromBuddy) {
                window.location.href = 'ai-buddy.html';
                return;
            }

            // 대화 중이면 책 선택 화면으로 돌아가기
            if (selectedBook && document.getElementById('book-selection-screen').classList.contains('hidden')) {
                resetToBookSelection();
            } else if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'home.html';
            }
        }

        // 책 선택 화면으로 리셋
        function resetToBookSelection() {
            // 상태 초기화
            selectedBook = null;
            conversationData = null;
            currentCardType = null;
            currentQuestionIndex = 0;
            answeredQuestions = 0;

            // UI 초기화
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('book-selection-screen').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('hidden');
            document.getElementById('header-book-info').classList.add('hidden');
            document.getElementById('header-book-info').classList.remove('flex');
            document.getElementById('header-placeholder').classList.remove('hidden');

            // 입력 섹션들 숨기기
            document.getElementById('card-selection').classList.add('hidden');
            document.getElementById('text-input-section').classList.add('hidden');
            document.getElementById('next-question-section').classList.add('hidden');
            document.getElementById('complete-section').classList.add('hidden');
        }
    </script>
</body>
</html>
