<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>북클럽 3.0 - 독서토론</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        },
                        debate: {
                            blue: '#3B82F6',
                            blueDark: '#1D4ED8',
                            red: '#EF4444',
                            redDark: '#DC2626',
                            purple: '#8B5CF6'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        body {
            background: linear-gradient(180deg, #EEF2FF 0%, #E0E7FF 50%, #C7D2FE 100%);
        }

        /* 3D 버튼 */
        .btn-3d {
            transform: translateY(-4px);
            transition: all 0.1s ease;
        }
        .btn-3d:active {
            transform: translateY(0);
        }

        /* 투표 버튼 */
        .vote-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .vote-btn:hover {
            transform: translateY(-4px) scale(1.02);
        }
        .vote-btn:active {
            transform: translateY(0) scale(0.98);
        }
        .vote-btn.selected {
            transform: scale(1.05);
        }
        .vote-btn.not-selected {
            opacity: 0.4;
            filter: grayscale(0.5);
            transform: scale(0.95);
        }

        /* 펄스 효과 */
        .pulse-ring {
            animation: pulseRing 2s ease-in-out infinite;
        }
        @keyframes pulseRing {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
        }

        /* 슬라이드 애니메이션 */
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 두구두구 결과 공개 */
        .reveal-animation {
            animation: reveal 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes reveal {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* 드럼롤 효과 */
        .drumroll {
            animation: drumroll 0.1s ease-in-out infinite alternate;
        }
        @keyframes drumroll {
            from { transform: translateX(-2px); }
            to { transform: translateX(2px); }
        }

        /* 녹음 버튼 */
        .record-btn.recording {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            animation: recordPulse 1s ease-in-out infinite;
        }
        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }

        /* 진행 스텝 */
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
        }
        .step-indicator.completed {
            background: #10B981;
            color: white;
        }

        /* 타이핑 효과 */
        .typing-dots span {
            animation: typingDot 1.4s ease-in-out infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* 프로그레스 바 */
        .progress-bar-fill {
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="font-sans text-gray-800 min-h-screen overflow-x-hidden">
    <!-- 상단 헤더 -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-indigo-100 px-6 py-4">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 bg-indigo-50 hover:bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600 transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </button>

            <!-- 진행 단계 표시 -->
            <div class="flex items-center gap-2">
                <div id="step-1" class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                <div class="w-6 h-1 bg-gray-200 rounded-full"><div id="progress-1" class="h-full bg-indigo-500 rounded-full transition-all" style="width:0%"></div></div>
                <div id="step-2" class="step-indicator w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-sm font-bold">2</div>
                <div class="w-6 h-1 bg-gray-200 rounded-full"><div id="progress-2" class="h-full bg-indigo-500 rounded-full transition-all" style="width:0%"></div></div>
                <div id="step-3" class="step-indicator w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-sm font-bold">3</div>
                <div class="w-6 h-1 bg-gray-200 rounded-full"><div id="progress-3" class="h-full bg-indigo-500 rounded-full transition-all" style="width:0%"></div></div>
                <div id="step-4" class="step-indicator w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-sm font-bold">4</div>
            </div>

            <div class="w-10"></div>
        </div>
    </header>

    <!-- 메인 컨텐츠 영역 -->
    <main class="max-w-2xl mx-auto px-6 py-8" id="main-content">
        <!-- Stage 1: 주제 제시 및 투표 -->
        <div id="stage-1" class="slide-in">
            <!-- 캐릭터 -->
            <div class="text-center mb-6">
                <div class="inline-block relative">
                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-indigo-200 float-animation">
                        🐿️
                    </div>
                    <div class="absolute -bottom-2 -right-2 bg-indigo-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                        토론왕
                    </div>
                </div>
                <div class="mt-3 bg-white rounded-2xl px-5 py-3 shadow-md inline-block">
                    <p class="font-noto text-indigo-600">오늘의 토론 주제예요! 찬성? 반대?</p>
                </div>
            </div>

            <!-- 토론 주제 카드 -->
            <div class="bg-white rounded-3xl p-6 shadow-xl border-2 border-indigo-100 mb-8">
                <!-- 책 정보 -->
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100">
                    <div class="w-12 h-16 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-lg flex items-center justify-center text-white text-xl shadow-md">
                        📖
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">오늘 읽은 책</p>
                        <p class="font-noto text-gray-800">마법사의 물약</p>
                    </div>
                </div>

                <!-- 토론 주제 -->
                <div class="text-center mb-6">
                    <p class="text-sm text-indigo-500 font-bold mb-2">💬 토론 주제</p>
                    <h2 class="font-noto text-2xl text-gray-800 leading-relaxed">
                        "마법사가 숲속 친구들에게<br>
                        물약을 <span class="text-debate-blue">나눠줘야</span> 할까,<br>
                        <span class="text-debate-red">혼자 간직해야</span> 할까?"
                    </h2>
                </div>

                <!-- 투표 버튼들 -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="vote-agree" onclick="selectVote('agree')" class="vote-btn bg-gradient-to-br from-blue-50 to-indigo-50 border-4 border-blue-200 rounded-2xl p-5 text-center pulse-ring">
                        <span class="text-5xl mb-3 block">😊</span>
                        <span class="font-noto text-lg text-debate-blue block mb-1">나눠줘야 해!</span>
                        <span class="text-xs text-gray-500">함께 나누면 더 좋아요</span>
                    </button>

                    <button id="vote-disagree" onclick="selectVote('disagree')" class="vote-btn bg-gradient-to-br from-red-50 to-pink-50 border-4 border-red-200 rounded-2xl p-5 text-center pulse-ring" style="animation-delay: 0.5s;">
                        <span class="text-5xl mb-3 block">🤔</span>
                        <span class="font-noto text-lg text-debate-red block mb-1">간직해야 해!</span>
                        <span class="text-xs text-gray-500">특별한 건 소중하니까</span>
                    </button>
                </div>
            </div>

            <!-- 다음 버튼 -->
            <button id="btn-next-1" onclick="goToStage2()" disabled class="btn-3d w-full py-4 bg-gray-300 text-white rounded-2xl font-noto text-lg disabled:transform-none disabled:shadow-none" style="box-shadow: 0 6px 0 #9CA3AF;">
                먼저 투표해주세요
            </button>
        </div>

        <!-- Stage 2: 의견 작성 -->
        <div id="stage-2" class="hidden slide-in">
            <div class="text-center mb-6">
                <div class="inline-block w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl shadow-lg border-4 border-indigo-200">
                    ✏️
                </div>
                <p class="mt-3 font-noto text-lg text-gray-700">왜 그렇게 생각하나요?</p>
            </div>

            <!-- 선택한 입장 표시 -->
            <div id="selected-stance" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl p-4 mb-6 text-center">
                <span class="text-2xl mr-2">😊</span>
                <span class="font-noto text-lg">나는 "나눠줘야 해!" 를 선택했어요</span>
            </div>

            <!-- 의견 입력 -->
            <div class="bg-white rounded-3xl p-6 shadow-xl border-2 border-indigo-100 mb-6">
                <p class="text-sm text-gray-500 mb-3">내 생각을 적어주세요</p>
                <textarea id="opinion-text" placeholder="예) 친구들이랑 같이 쓰면 더 재미있을 것 같아요!" class="w-full h-32 bg-indigo-50 rounded-2xl p-4 text-gray-800 outline-none focus:ring-2 focus:ring-indigo-300 resize-none border border-indigo-100" oninput="checkOpinion()"></textarea>

                <!-- 또는 음성 녹음 -->
                <div class="flex items-center justify-center gap-4 mt-4 pt-4 border-t border-gray-100">
                    <span class="text-sm text-gray-400">또는</span>
                    <button id="record-btn" onclick="toggleRecording()" class="record-btn flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-red-400 to-pink-500 text-white rounded-full font-bold hover:shadow-lg transition-all">
                        <i class="fa-solid fa-microphone"></i>
                        <span id="record-text">음성으로 말하기</span>
                    </button>
                </div>

                <!-- 녹음 시간 표시 -->
                <div id="record-indicator" class="hidden mt-4 text-center">
                    <div class="inline-flex items-center gap-2 bg-red-100 text-red-600 px-4 py-2 rounded-full">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="record-time">00:00</span>
                    </div>
                </div>
            </div>

            <!-- 다음 버튼 -->
            <button id="btn-next-2" onclick="goToStage3()" disabled class="btn-3d w-full py-4 bg-gray-300 text-white rounded-2xl font-noto text-lg disabled:transform-none disabled:shadow-none">
                의견을 작성해주세요
            </button>
        </div>

        <!-- Stage 3: 투표 결과 공개 -->
        <div id="stage-3" class="hidden slide-in">
            <div class="text-center mb-8">
                <div class="inline-block w-20 h-20 bg-white rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-yellow-200 mb-4">
                    🥁
                </div>
                <p class="font-noto text-2xl text-gray-800">두구두구...</p>
                <p class="text-gray-500">투표 결과를 공개합니다!</p>
            </div>

            <!-- 결과 카드 (처음엔 숨김) -->
            <div id="result-card" class="opacity-0 bg-white rounded-3xl p-8 shadow-xl border-2 border-yellow-200 text-center">
                <!-- 드럼롤 로딩 -->
                <div id="drumroll-loader" class="py-12">
                    <div class="text-6xl drumroll mb-4">🎲</div>
                    <p class="text-gray-500">결과 집계 중...</p>
                </div>

                <!-- 실제 결과 (숨김) -->
                <div id="actual-result" class="hidden">
                    <p class="text-sm text-gray-500 mb-4">우리 반 친구들의 선택</p>

                    <!-- 그래프 -->
                    <div class="flex items-center gap-2 mb-6">
                        <div class="text-3xl">😊</div>
                        <div class="flex-1 h-10 bg-gray-100 rounded-full overflow-hidden flex">
                            <div id="result-bar-agree" class="progress-bar-fill h-full bg-gradient-to-r from-blue-400 to-indigo-500 flex items-center justify-end pr-3" style="width:0%">
                                <span class="text-white font-bold text-sm" id="result-percent-agree">0%</span>
                            </div>
                            <div id="result-bar-disagree" class="progress-bar-fill h-full bg-gradient-to-r from-red-400 to-pink-500 flex items-center justify-start pl-3" style="width:0%">
                                <span class="text-white font-bold text-sm" id="result-percent-disagree">0%</span>
                            </div>
                        </div>
                        <div class="text-3xl">🤔</div>
                    </div>

                    <!-- 상세 수치 -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-2xl p-4">
                            <p class="font-noto text-3xl text-debate-blue" id="count-agree">0명</p>
                            <p class="text-sm text-gray-500">나눠줘야 해!</p>
                        </div>
                        <div class="bg-red-50 rounded-2xl p-4">
                            <p class="font-noto text-3xl text-debate-red" id="count-disagree">0명</p>
                            <p class="text-sm text-gray-500">간직해야 해!</p>
                        </div>
                    </div>

                    <!-- 내 선택 표시 -->
                    <div id="my-result" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl p-4">
                        <span class="text-2xl mr-2">🎯</span>
                        <span class="font-noto">나는 다수와 같은 생각이에요!</span>
                    </div>
                </div>
            </div>

            <!-- 다음 버튼 -->
            <button id="btn-next-3" onclick="goToStage4()" class="hidden btn-3d w-full py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl font-noto text-lg mt-6" style="box-shadow: 0 6px 0 #4338CA;">
                다른 친구들 의견 보기 <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- Stage 4: AI 의견 요약 -->
        <div id="stage-4" class="hidden slide-in">
            <div class="text-center mb-6">
                <div class="inline-block w-20 h-20 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center text-4xl shadow-lg">
                    🤖
                </div>
                <p class="mt-3 font-noto text-lg text-gray-700">AI가 다른 의견을 정리했어요!</p>
            </div>

            <!-- AI 요약 카드 -->
            <div class="bg-white rounded-3xl p-6 shadow-xl border-2 border-purple-100 mb-6">
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl shadow-md">
                        🤖
                    </div>
                    <div>
                        <p class="font-noto text-gray-800">AI 독서 버디</p>
                        <p class="text-xs text-gray-500">다른 친구들의 의견을 요약했어요</p>
                    </div>
                </div>

                <!-- 타이핑 효과 -->
                <div id="ai-typing" class="text-center py-8">
                    <div class="typing-dots inline-flex gap-2">
                        <span class="w-3 h-3 bg-purple-400 rounded-full"></span>
                        <span class="w-3 h-3 bg-purple-400 rounded-full"></span>
                        <span class="w-3 h-3 bg-purple-400 rounded-full"></span>
                    </div>
                    <p class="text-gray-500 mt-2">의견을 정리하고 있어요...</p>
                </div>

                <!-- AI 요약 내용 -->
                <div id="ai-summary" class="hidden">
                    <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-2xl p-5 mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">🤔</span>
                            <span class="font-noto text-debate-red">"간직해야 해!" 친구들의 생각</span>
                        </div>
                        <p class="text-gray-700 leading-relaxed" id="opposite-summary">
                            "특별한 물약은 아무에게나 주면 위험할 수 있어요. 마법사가 책임감 있게 관리해야 한다고 생각해요. 또 힘들게 만든 물약이니까 소중히 보관하는 게 맞아요."
                        </p>
                    </div>

                    <div class="bg-purple-50 rounded-2xl p-4 text-center">
                        <p class="text-purple-600 text-sm">
                            <i class="fa-solid fa-lightbulb mr-1"></i>
                            다른 생각도 이해하면 더 넓은 시야를 가질 수 있어요!
                        </p>
                    </div>
                </div>
            </div>

            <!-- 완료 버튼 -->
            <button id="btn-complete" onclick="completeDebate()" class="hidden btn-3d w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-noto text-lg" style="box-shadow: 0 6px 0 #047857;">
                <i class="fa-solid fa-check mr-2"></i> 토론 완료!
            </button>
        </div>
    </main>

    <!-- 완료 모달 -->
    <div id="complete-modal" class="hidden fixed inset-0 z-[100] bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center">
        <div class="text-center px-6">
            <div class="reveal-animation w-40 h-40 mx-auto mb-6 bg-white rounded-full flex items-center justify-center shadow-2xl">
                <span class="text-7xl">🏆</span>
            </div>
            <h2 class="font-noto text-4xl text-white mb-2">토론 완료!</h2>
            <p class="text-white/90 text-xl mb-8">멋진 생각을 나눠줬어요!</p>

            <div class="flex justify-center gap-4 mb-8">
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">⭐</span>
                    <span class="text-white font-noto">+30 별</span>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">🎖️</span>
                    <span class="text-white font-noto">토론 뱃지</span>
                </div>
            </div>

            <button onclick="goBack()" class="btn-3d px-10 py-4 bg-white text-indigo-600 rounded-2xl font-noto text-lg" style="box-shadow: 0 6px 0 #C7D2FE;">
                돌아가기
            </button>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script>
        // 상태 관리
        let userVote = null; // 'agree' or 'disagree'
        let userOpinion = '';
        let isRecording = false;
        let recordingInterval = null;
        let recordingSeconds = 0;

        // Stage 1: 투표 선택
        function selectVote(vote) {
            userVote = vote;

            const agreeBtn = document.getElementById('vote-agree');
            const disagreeBtn = document.getElementById('vote-disagree');

            // 선택 상태 표시
            agreeBtn.classList.remove('selected', 'not-selected', 'pulse-ring');
            disagreeBtn.classList.remove('selected', 'not-selected', 'pulse-ring');

            if (vote === 'agree') {
                agreeBtn.classList.add('selected');
                agreeBtn.style.borderColor = '#3B82F6';
                disagreeBtn.classList.add('not-selected');
            } else {
                disagreeBtn.classList.add('selected');
                disagreeBtn.style.borderColor = '#EF4444';
                agreeBtn.classList.add('not-selected');
            }

            // 다음 버튼 활성화
            const btn = document.getElementById('btn-next-1');
            btn.disabled = false;
            btn.className = 'btn-3d w-full py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl font-noto text-lg';
            btn.style.boxShadow = '0 6px 0 #4338CA';
            btn.textContent = '내 의견 말하기 →';
        }

        // Stage 2로 이동
        function goToStage2() {
            document.getElementById('stage-1').classList.add('hidden');
            document.getElementById('stage-2').classList.remove('hidden');

            // 진행 표시 업데이트
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-1').classList.add('completed');
            document.getElementById('progress-1').style.width = '100%';
            document.getElementById('step-2').classList.add('active');

            // 선택한 입장 표시
            const stanceDiv = document.getElementById('selected-stance');
            if (userVote === 'agree') {
                stanceDiv.className = 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl p-4 mb-6 text-center';
                stanceDiv.innerHTML = '<span class="text-2xl mr-2">😊</span><span class="font-noto text-lg">나는 "나눠줘야 해!" 를 선택했어요</span>';
            } else {
                stanceDiv.className = 'bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-2xl p-4 mb-6 text-center';
                stanceDiv.innerHTML = '<span class="text-2xl mr-2">🤔</span><span class="font-noto text-lg">나는 "간직해야 해!" 를 선택했어요</span>';
            }
        }

        // 의견 입력 체크
        function checkOpinion() {
            const text = document.getElementById('opinion-text').value.trim();
            const btn = document.getElementById('btn-next-2');

            if (text.length >= 5) {
                userOpinion = text;
                btn.disabled = false;
                btn.className = 'btn-3d w-full py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl font-noto text-lg';
                btn.style.boxShadow = '0 6px 0 #4338CA';
                btn.textContent = '투표 결과 보기 →';
            } else {
                btn.disabled = true;
                btn.className = 'btn-3d w-full py-4 bg-gray-300 text-white rounded-2xl font-noto text-lg disabled:transform-none disabled:shadow-none';
                btn.textContent = '의견을 작성해주세요';
            }
        }

        // 녹음 토글
        function toggleRecording() {
            const btn = document.getElementById('record-btn');
            const text = document.getElementById('record-text');
            const indicator = document.getElementById('record-indicator');
            const timeDisplay = document.getElementById('record-time');

            isRecording = !isRecording;

            if (isRecording) {
                btn.classList.add('recording');
                text.textContent = '녹음 중지';
                indicator.classList.remove('hidden');
                recordingSeconds = 0;

                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
                    const secs = (recordingSeconds % 60).toString().padStart(2, '0');
                    timeDisplay.textContent = `${mins}:${secs}`;
                }, 1000);
            } else {
                btn.classList.remove('recording');
                text.textContent = '음성으로 말하기';
                indicator.classList.add('hidden');
                clearInterval(recordingInterval);

                if (recordingSeconds > 2) {
                    userOpinion = '[음성 녹음됨]';
                    const btn2 = document.getElementById('btn-next-2');
                    btn2.disabled = false;
                    btn2.className = 'btn-3d w-full py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl font-noto text-lg';
                    btn2.style.boxShadow = '0 6px 0 #4338CA';
                    btn2.textContent = '투표 결과 보기 →';
                }
            }
        }

        // Stage 3로 이동
        function goToStage3() {
            document.getElementById('stage-2').classList.add('hidden');
            document.getElementById('stage-3').classList.remove('hidden');

            // 진행 표시 업데이트
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-2').classList.add('completed');
            document.getElementById('progress-2').style.width = '100%';
            document.getElementById('step-3').classList.add('active');

            // 결과 카드 표시
            setTimeout(() => {
                document.getElementById('result-card').style.opacity = '1';
            }, 300);

            // 드럼롤 후 결과 공개
            setTimeout(() => {
                document.getElementById('drumroll-loader').classList.add('hidden');
                document.getElementById('actual-result').classList.remove('hidden');

                // 결과 애니메이션
                setTimeout(() => {
                    // 가상의 투표 결과 (실제로는 서버에서 받아옴)
                    const agreePercent = 62;
                    const disagreePercent = 38;

                    document.getElementById('result-bar-agree').style.width = agreePercent + '%';
                    document.getElementById('result-bar-disagree').style.width = disagreePercent + '%';
                    document.getElementById('result-percent-agree').textContent = agreePercent + '%';
                    document.getElementById('result-percent-disagree').textContent = disagreePercent + '%';
                    document.getElementById('count-agree').textContent = '15명';
                    document.getElementById('count-disagree').textContent = '9명';

                    // 내 선택 결과
                    const myResult = document.getElementById('my-result');
                    if ((userVote === 'agree' && agreePercent > 50) || (userVote === 'disagree' && disagreePercent > 50)) {
                        myResult.innerHTML = '<span class="text-2xl mr-2">🎯</span><span class="font-noto">나는 다수와 같은 생각이에요!</span>';
                    } else {
                        myResult.className = 'bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl p-4';
                        myResult.innerHTML = '<span class="text-2xl mr-2">💡</span><span class="font-noto">나만의 특별한 생각이에요!</span>';
                    }

                    // 다음 버튼 표시
                    document.getElementById('btn-next-3').classList.remove('hidden');
                }, 500);
            }, 2500);
        }

        // Stage 4로 이동
        function goToStage4() {
            document.getElementById('stage-3').classList.add('hidden');
            document.getElementById('stage-4').classList.remove('hidden');

            // 진행 표시 업데이트
            document.getElementById('step-3').classList.remove('active');
            document.getElementById('step-3').classList.add('completed');
            document.getElementById('progress-3').style.width = '100%';
            document.getElementById('step-4').classList.add('active');

            // AI 요약 표시
            setTimeout(() => {
                document.getElementById('ai-typing').classList.add('hidden');
                document.getElementById('ai-summary').classList.remove('hidden');

                // 반대 의견 요약 (사용자가 찬성을 선택한 경우)
                const summaryText = document.getElementById('opposite-summary');
                if (userVote === 'agree') {
                    summaryText.textContent = '"특별한 물약은 아무에게나 주면 위험할 수 있어요. 마법사가 책임감 있게 관리해야 한다고 생각해요. 또 힘들게 만든 물약이니까 소중히 보관하는 게 맞아요."';
                } else {
                    document.querySelector('#ai-summary > div:first-child').className = 'bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-5 mb-4';
                    document.querySelector('#ai-summary > div:first-child > div').innerHTML = '<span class="text-2xl">😊</span><span class="font-noto text-debate-blue">"나눠줘야 해!" 친구들의 생각</span>';
                    summaryText.textContent = '"숲속 친구들도 물약이 필요할 때가 있을 거예요. 함께 나누면 더 많은 좋은 일이 생길 수 있어요. 마법사 혼자만 쓰기엔 너무 아깝다고 생각해요."';
                }

                // 완료 버튼 표시
                setTimeout(() => {
                    document.getElementById('btn-complete').classList.remove('hidden');
                }, 500);
            }, 2000);
        }

        // 토론 완료
        function completeDebate() {
            document.getElementById('complete-modal').classList.remove('hidden');
        }

        // 뒤로가기
        function goBack() {
            // AI 버디에서 온 경우 버디로 돌아가기
            const chatState = sessionStorage.getItem('aiBuddyChatState');
            if (chatState) {
                window.location.href = 'ai-buddy.html';
                return;
            }

            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'home.html';
            }
        }
    </script>
</body>
</html>
